---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### ------------------------------------------------------------------------------------ ###

## 

### ------------------------------------------------------------------------------------ ###

## plot average speed vs location for groups of neurons (P, S etc)



### ------------------------------------------------------------------------------------ ###

## plot average speed vs location for groups of neurons (P, S etc)

1. Write function to add position to speed
```{r}
add_position <- function(hit, try, run) {
  df <- tibble(Speed = c(unlist(hit), unlist(try), unlist(run)), 
               Position = rep(1:200, times=3), 
               Indicator = c(rep("Hit", times=200), rep("Try", times=200), rep("Run", times=200)))
  return(df)
}
```

2. Run on dataframe : Average across trial types

input columns: 
Speed_mean_rewarded = speed on rewarded beaconed trials
Speed_mean_try =  speed ontry beaconed trials
Speed_mean_runthru = speed on run through trials
```{r}
spatial_firing <- spatial_firing %>%
  mutate(Speed_avg = pmap(list(Speed_mean_rewarded, Speed_mean_try, Speed_mean_runthru), add_position))
```

Then average over selected neurons 

Function to plot data mean and SD of the population data based on the classification, as per Figure 2, on beaconed and non-beaconed trials.
```{r}
mean_speed_plots <- function(df, x_start = 30, x_end = 90){
 df <- df %>%
   select(Speed_avg) %>%
   unnest((Speed_avg))
 
 df <- df %>%
   group_by(Position, Indicator) %>%
   summarise(mean_b = mean(Speed, na.rm = TRUE),
             se_b = std.error(Speed, na.rm = TRUE))
 ggplot(data=df) +
  annotate("rect", xmin=0, xmax=30, ymin=0,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=170, xmax=200, ymin=0,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=90, xmax=110, ymin=0,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
  geom_ribbon(aes(x=Position, 
                  y=mean_b, ymin = mean_b - se_b, ymax = mean_b + se_b, 
                  fill=as.factor(Indicator)), alpha=0.1) +
   geom_line(aes(y=mean_b, 
                 x=Position, 
                 color=as.factor(Indicator)), alpha=0.5, n= 100, span=0.2) +
   scale_fill_manual(values=c("black", "red", "blue")) +
   scale_color_manual(values=c("black", "red", "blue")) +
   theme_classic() +
   labs(y = "Mean speed (cm/s)", x = "Position") +
   xlim(x_start, x_end) +
   #ylim(10,170) +
   theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        text = element_text(size=12))
 
}
```

3. Split data based on encoding group (Figure 3) as we are only interested in position neurons here
```{r}
position_neurons <- filter(spatial_firing, final_model_o_b == "P" | final_model_o_b == "S" | final_model_o_b == "A" | final_model_o_b == "SA")
```

4. Subset data by group then average rates for plotting          
```{r}
(Pos_speed_plot <- mean_speed_plots(spatial_firing,  0, 200))
ggsave(file = "plots/PI_speed.png", width = 4.5, height = 2.5)
```




```{r}
# The function to use at each step is `mean`.
# The window size is 5
rolling_mean <- rollify(mean, window = 10)

mean_speed_plots <- function(df, x_start = 30, x_end = 90){
  
  hit <- df %>%
    select(Speed_mean_rewarded) %>%
    unnest(Speed_mean_rewarded) %>%
    mutate(rolling_avg = rolling_mean(mean_speed)/10)
  try <- df %>%
    select(Speed_mean_try) %>%
    unnest(Speed_mean_try) %>%
    mutate(rolling_avg = rolling_mean(mean_speed)/10)
  run <- df %>%
    select(Speed_mean_run) %>%
    unnest(Speed_mean_run) %>%
    mutate(rolling_avg = rolling_mean(mean_speed)/10)

  full_df <- tibble(Speed = c(hit$rolling_avg,try$rolling_avg, run$rolling_avg),
               Position = c(hit$Position,try$Position, run$Position),
               Indicator = c(rep("Hit", times=nrow(hit)),rep("Try", times=nrow(try)),rep("Run",times=nrow(run)))
    )

  full_df <- full_df %>%
    group_by(Position, Indicator) %>%
    dplyr::summarise(rolling_mean = mean(Speed, na.rm = TRUE),
                     se_b = std.error(Speed, na.rm = TRUE))
  
  ggplot(data=full_df) +
    coord_cartesian(ylim = c(5,140)) +
    annotate("rect", xmin=0, xmax=30, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
    annotate("rect", xmin=170, xmax=200, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
    annotate("rect", xmin=90, xmax=110, ymin=5,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
    geom_ribbon(aes(x=Position, 
                    y=rolling_mean, ymin = rolling_mean - se_b, ymax = rolling_mean + se_b, 
                    fill=as.factor(Indicator)), alpha=0.1) +
    geom_line(aes(y=rolling_mean, 
                  x=Position, 
                  color=as.factor(Indicator)), alpha=0.5, n= 100) +
    scale_fill_manual(values=c("black", "red", "blue")) +
    scale_color_manual(values=c("black", "red", "blue")) +
    theme_classic() +
    labs(y = "Mean speed (cm/s)", x = "Position") +
    xlim(x_start, x_end) +
    theme(axis.text.x = element_text(size=12),
          axis.text.y = element_text(size=12),
          legend.title = element_blank(),
          text = element_text(size=12))
  }
```



### ------------------------------------------------------------------------------------ ###

## calculate a histogram of speed in the reward zone

Here we want to see the distribution of speed in the reward zone in the trial types (hit, run, try)

Function to extract all data. Filter for positions in the reward zone and calculate mean speed for each trial. Do this seperatly for hit, run and try neurons. 
```{r}
sum_speed_in_reward_zone <- function(df) {
  df <-
    tibble(
      Speed = as.numeric((Re(df[[2]]))),
      Position = as.integer(Re(df[[3]])),
      Trials = as.factor(df[[4]]),
      Types = as.factor(df[[5]])
    )

  df <- df %>%
    filter(Types == 0) %>%
    select(Speed, Trials, Position) %>%
    filter(Position >= 90, Position <= 110) %>%
    group_by(Trials) %>%
    dplyr::summarise(mean_speed = mean(Speed, na.rm = TRUE),
             se_speed = std.error(Speed, na.rm = TRUE)) 
  return(df)
}
```

1. Run on dataframe : Average across trial types

input columns: 
spikes_in_time_rewarded_b = speed, position and trial number for rewarded beaconed trials
spikes_in_time_try_b =  speed, position and trial number for try beaconed trials
Speed_hist_runthru_b = speed, position and trial number for run through trials
```{r}
spatial_firing <- spatial_firing %>%
  mutate(Speed_hist_rewarded = map(spikes_in_time_reward_b, sum_speed_in_reward_zone),
         Speed_hist_try = map(spikes_in_time_try_b, sum_speed_in_reward_zone),
         Speed_hist_run = map(spikes_in_time_runthru_b, sum_speed_in_reward_zone))
```


Function to calculate and plot histogram. First takes input column, extracts the average reward zone speed for each trial, then plots for all sessions 
```{r}
histogram_plots <- function(df, name, color){
  df <- df %>%
    select(name) %>%
    unnest(name) %>%
    select(mean_speed)

  ggplot(data=df, aes(x = as.vector(mean_speed))) +
    coord_cartesian(xlim=c(0,100)) +
    geom_histogram(aes(y=..density..),binwidth = 2, alpha=0.5, fill=color) +
    scale_y_continuous(breaks = scales::pretty_breaks(n = 4)) +
    labs(y="Density", x="") +
    theme_classic() +
    theme(axis.text.x = element_text(size=16),
          axis.text.y = element_text(size=16),
          text = element_text(size=16), 
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)))
}
```


4. Plot histogram for rewarded trials
```{r}
(hit_hist_plot <- histogram_plots(spatial_firing, "Speed_hist_rewarded", "black"))
ggsave(file = "plots/Mean_rewardzone_speed_rewarded.png",width = 4, height = 2.5)
```

5. Plot histogram for try trials
```{r}
(run_hist_plot <- histogram_plots(spatial_firing, "Speed_hist_run", "red"))
ggsave(file = "plots/Mean_rewardzone_speed_run.png",width = 4, height = 2.5)
```

6. Plot histogram for run trials
```{r}
(try_hist_plot <- histogram_plots(spatial_firing, "Speed_hist_try", "blue"))
ggsave(file = "plots/Mean_rewardzone_speed_try.png",width = 4, height = 2.5)
```


### ------------------------------------------------------------------------------------ ###

### plot the 95 % confidence intervals for speed in the reward zone



Function to calculate and plot histogram. First takes input column, extracts the average reward zone speed for each trial, then plots for all sessions 
```{r}
CI_plot <- function(df, name, color){
  
  df <- df %>%
    select(name) %>%
    unnest(name[1]) 
  
  print(df)

  ggplot(data=df, aes(x = as.vector(name))) +
    coord_cartesian(xlim=c(0,100)) +
    geom_histogram(aes(y=..density..),binwidth = 2, alpha=0.5, fill=color) +
    labs(y="Density", x="") +
    theme_classic() +
    theme(axis.text.x = element_text(size=12),
          axis.text.y = element_text(size=12),
          text = element_text(size=12), 
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)))
}
```



6. Plot histogram for run trials
```{r}
CI_plot_upper <- function(df, name, color){
  df <- df %>%
    select(name) %>%
    unnest_wider(name,names_repair = "universal")
  
  upper <- ggplot(data=df, aes(x = as.vector(...1))) +
    coord_cartesian(xlim=c(0,100)) +
    geom_histogram(aes(y=..density..),binwidth = 2, alpha=0.5, fill=color) +
    labs(y="Density", x="") +
    theme_classic() +
    theme(axis.text.x = element_text(size=12),
          axis.text.y = element_text(size=12),
          text = element_text(size=12), 
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)))
}
```

```{r}
CI_plot_lower <- function(df, name, color){
  df <- df %>%
    select(name) %>%
    unnest_wider(name,names_repair = "universal")
  
  upper <- ggplot(data=df, aes(x = as.vector(...2))) +
    coord_cartesian(xlim=c(0,100)) +
    geom_histogram(aes(y=..density..),binwidth = 2, alpha=0.5, fill=color) +
    labs(y="Density", x="") +
    theme_classic() +
    theme(axis.text.x = element_text(size=12),
          axis.text.y = element_text(size=12),
          text = element_text(size=12), 
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)))
}
```

```{r}
(upper <- CI_plot_upper(position_neurons, "speed_CI_rewarded", "black"))
ggsave(file = "plots/Speed_upperCI_rewarded.png", width = 4, height = 2.5)
```
```{r}
(upper <- CI_plot_lower(position_neurons, "speed_CI_rewarded", "black"))
ggsave(file = "plots/Speed_lowerCI_rewarded.png", width = 4, height = 2.5)
```


```{r}
(upper <- CI_plot_upper(position_neurons, "speed_CI_run", "red"))
ggsave(file = "plots/Speed_upperCI_run.png", width = 4, height = 2.5)
```
```{r}
(upper <- CI_plot_lower(position_neurons, "speed_CI_run", "red"))
ggsave(file = "plots/Speed_lowerCI_run.png", width = 4, height = 2.5)
```


