---
title: "ShuffleAnalysis_example"
author: "Sarah Tennant"
date: "01/09/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Script generates 1000 shuffled datasets for each neuron 


### load data 

_Run if using script stand alone_

```{r}
spatial_firing_test <- readRDS(file="spatial_firing_test.Rda")
```


_run if using from Prelim_Analysis_0100.Rmd_

```{r}
spatial_firing_test <- subset(spatial_firing2, asr_b_rewarded_slope_o < -0.38) #extract test neuron
```


1. write function for running lm

```{r}

lm_helper <- function(df, bins){
  if(all(is.na(df))) 
    return(0)
  df <- df  %>% subset(Position > 30 & Position <= 90) %>%  
    group_by(Position) %>%
    summarise(Rates = mean(Rates, na.rm = TRUE))  %>% 
    mutate(Position = c(31:90))
  df_mod <- lm(Rates ~ Position, data = df, na.action=na.exclude)
}

```

2. write function to generate 1000 shuffles
- shuffles spikes using sample() function
- runs lm
- extracts coefficients
- stores coefficients for each 1000 shuffles (less memory than saving 1000 shuffles)
```{r}
#library(gdata)
shuffle_rates <- function(df) {
  df_modified <- data.frame(neuron=as.numeric(),
                 slope=as.numeric(), 
                 rsquared=as.numeric(), 
                 pval=vector())
  names(df_modified) <- c("neuron", "slope", "rsquared", "pval")
  x <- 1
  repeat {
  shuff_df <- tibble(Rates = sample(as.vector(unlist(df)),replace = TRUE, prob = NULL), Position = rep(1:200, times=length(df)/200), Trials = rep(1:(length(df)/200), each=200))
  shuff_df <- subset(shuff_df, Position >=30 & Position <=90)
  df_mod <- lm_helper(shuff_df)
  rsquared <- glance(df_mod)$r.squared
  pval<- glance(df_mod)$p.value
  slope <- coefficients(df_mod)[2] # slope
  data <- data.frame(as.numeric(x), slope, rsquared, round(pval,5))
  names(data) <- c("neuron", "slope", "rsquared", "pval")
  df_modified <- rbind(df_modified,data)

  x = x+1
  if (x == 100){
  break
  }
  }
return(df_modified)
}
```

3. Run on example neuron
```{r}

spatial_firing_test <- spatial_firing_test %>%
  mutate(shuffle_results = map(Firing_rate_b, shuffle_rates)) 

```

Then we want to find limits of the shuffled data for this neuron

1. extract shuffle results (slopes and r2 for each shuffle)
_functions_
```{r} 

extract_shuffle_slopes <- function(df){
  df <- tibble(slopes = unlist(df$slope), rsquared = unlist(df$rsquared))
  return(df$slopes)
}

extract_shuffle_r2 <- function(df){
  df <- tibble(slopes = unlist(df$slope), rsquared = unlist(df$rsquared))
  return(df$rsquared)
}

extract_shuffle_pval <- function(df){
  df <- tibble(pval = unlist(df$pval))
  return(df$pval)
}
```

2. run on test neuron
```{r}
spatial_firing_test <- spatial_firing_test %>%
  mutate(shuffle_slopes = map(shuffle_results, extract_shuffle_slopes)) %>%
  mutate(shuffle_rsquared = map(shuffle_results, extract_shuffle_r2)) %>%
  mutate(shuffle_pval = map(shuffle_results, extract_shuffle_r2)) 


```

3. find limits for that neuron
```{r}
min_slope_o <- quantile(as.numeric(unlist(spatial_firing_test$shuffle_slopes)), c(.05, .95)) [[1]][1]
max_slope_o <- quantile(as.numeric(unlist(spatial_firing_test$shuffle_slopes)), c(.05, .95)) [[2]][1]
max_r2_o <- quantile(as.numeric(unlist(spatial_firing_test$shuffle_rsquared)), c(.025, .975)) [[2]][1]

```

Now we can plot coefficients from shuffled and real datasets 

1. make two tibbles with data
- first tibble contains all data
- second tibble contains only ramp data as identified by lm

```{r}

lm_results <- tibble(Slopes =  unlist(spatial_firing_test$shuffle_slopes), 
    r2 = unlist(spatial_firing_test$shuffle_rsquared), 
    id = rep(1:999))

lm_results_ramps <- tibble(
    Slopes = as.numeric(unlist(spatial_firing_test$asr_b_rewarded_slope_o)), 
    r2 = as.numeric(unlist(spatial_firing_test$asr_b_rewarded_r2_o)), 
    id = as.numeric(spatial_firing_test$cluster_id))

```

2. Plot results, color coded by ramp type

```{r}

lm_plot_start <- ggplot(data=lm_results, aes(x = Slopes, y = r2)) + 
    #coord_cartesian(xlim = c(-0.6,0.6), ylim = c(0,1)) +
    xlim(c(-0.6,0.6)) + 
    geom_point() +
    geom_point(data=lm_results_ramps, aes(x = Slopes, y = r2), color="Blue") +
    xlab("\nslope") +
    ylab("R2") +
    theme_classic() +
    theme(axis.text.x = element_text(size=12),
          axis.text.y = element_text(size=12),
          legend.position="bottom", 
          legend.title = element_blank(),
          text = element_text(size=12), 
          legend.text=element_text(size=12), 
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) 

lm_plot_start <- lm_plot_start + geom_vline(xintercept = min_slope_o , linetype="dotted", color = "blue", size=.6)
lm_plot_start <- lm_plot_start + geom_vline(xintercept = max_slope_o, linetype="dotted", color = "blue", size=.6)
lm_plot_start <- lm_plot_start + geom_hline(yintercept = max_r2_o, linetype="dotted", color = "red", size=.6)
show(lm_plot_start)
ggsave(file = "plots/shuff_lm1_examplecell.png", width = 4, height = 5, ggMarginal(lm_plot_start, expand = FALSE, type = "density", margins = c("both"), size=4))
```


3. plot zoom of shuffled data to see the limits
```{r}

lm_plot_start <- ggplot(data=lm_results, aes(x = Slopes, y = r2)) + 
    geom_jitter() +
    xlab("\nslope") +
    ylab("R2") +
    theme_classic() +
    theme(axis.text.x = element_text(size=12),
          axis.text.y = element_text(size=12),
          legend.position="bottom", 
          legend.title = element_blank(),
          text = element_text(size=12), 
          legend.text=element_text(size=12), 
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) 

lm_plot_start <- lm_plot_start + geom_vline(xintercept = min_slope_o , linetype="dotted", color = "blue", size=.6)
lm_plot_start <- lm_plot_start + geom_vline(xintercept = max_slope_o, linetype="dotted", color = "blue", size=.6)
lm_plot_start <- lm_plot_start + geom_hline(yintercept = max_r2_o, linetype="dotted", color = "red", size=.6)
show(lm_plot_start)
ggsave(file = "plots/shuff_lm1_examplecell_shuffinsert.png", width = 4, height = 5, ggMarginal(lm_plot_start, expand = FALSE, type = "density", margins = c("both"), size=4))

```



Now i want to check the shuffled data. So I want to plot these shuffles.

1. write function to plot shuffled dataset in a loop
```{r}
#library(gdata)
shuffle_rates <- function(df) {
  df_modified <- data.frame(neuron=as.numeric(), 
                 rates = vector())
  names(df_modified) <- c("neuron","rates")
  x <- 1
  repeat {
  shuff_df <- tibble(Rates = sample(as.vector(unlist(df)),replace = TRUE, prob = NULL), Position = rep(1:200, times=length(df)/200), Trials = rep(1:(length(df)/200), each=200))
  shuff_df <- subset(shuff_df, Position >=30 & Position <=90)
  
  #plot shuffled points - use jitter to see density of points
  ggplot(data=shuff_df, aes(x = Position, y = Rates)) + 
    geom_jitter(size=0.5) +
    theme_classic()
  ggsave(file = paste0("plots/ExampleShuffle.", as.character(x), ".png"), width = 4, height = 3)
  
  #average firing rate
  shuff_df <- shuff_df %>% 
    group_by(Position) %>% 
    summarise(avg_rate = mean(Rates, na.rm =TRUE)) %>% 
    mutate(bins=rep(30:90))
  ggplot(data=shuff_df, aes(x = bins, y = avg_rate)) + 
  geom_line() +
  theme_classic()
  ggsave(file = paste0("plots/ExampleShuffle_rate.", as.character(x), ".png"), width = 4, height = 3)
  
  x = x+1
  if (x == 100){
  break
  }
  }
return(df_modified)
}
```

2. run on test neuron shuffle rates 1000 times
```{r}

spatial_firing_test <- spatial_firing_test %>%
  mutate(shuffle_firing_rates = map(Firing_rate_b, shuffle_rates)) 

```


Also want to plot the real firing rate of the neuron

1. extract firing rate into a tibble
```{r}
real_df <- tibble(Rates = as.vector(unlist(spatial_firing_test$Firing_rate_b)), Position = rep(1:200, times=length(as.vector(unlist(spatial_firing_test$Firing_rate_b)))/200), Trials = rep(1:(length(as.vector(unlist(spatial_firing_test$Firing_rate_b)))/200), each=200))

```

2. plot real rates
```{r}
ggplot(data=real_df, aes(x =Position, y = Rates)) + 
  coord_cartesian(xlim=c(30,90), ylim=c(0,45)) +
  geom_jitter(size=0.5) +
  theme_classic()
ggsave(file = paste0("plots/ExampleShuffle-real.png"), width = 4, height = 3)

```


### plot pval distribution of shuffled data

3. plot zoom of shuffled data to see the limits

```{r}
pdata <- tibble(pvals = unlist(spatial_firing_test$shuffle_pval))
```

```{r}
ggplot(data=pdata, aes(x = pvals)) + 
    geom_histogram() +
    xlab("pval") +
    ylab("count") +
    theme_classic() +
    theme(axis.text.x = element_text(size=12),
          axis.text.y = element_text(size=12),
          legend.position="bottom", 
          legend.title = element_blank(),
          text = element_text(size=12), 
          legend.text=element_text(size=12), 
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) 

ggsave(file = "plots/shuff_pvalues.png", width = 4, height = 5)

```
