---
title: "Untitled"
author: "Sarah Tennant"
date: "23/06/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---
title: "HitMissAnalysis"
author: "Sarah Tennant"
date: "30/10/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### -------------------------------------------------------------------------------------------------------------------------------------------------- ###

## Differences in spatial firing between hit/rewarded and miss/unrewarded trials

We might want to see differences in the relationship between firing rate and position along the track between rewarded and non rewarded trials (i.e. hit and miss trials)


### -------------------------------------------------------------------------------------------------------------------------------------------------- ###



## Are neurons influenced by reward?

1. Combine hit and miss trials

```{r}
join_rates <- function(hit, miss) {
  df <- tibble(Rates = c(unlist(hit[31:90]), unlist(miss[31:90])), Reward_indicator = c(rep(1, times=60), rep(0, times=60)), Position = c(rep(31:90), rep(31:90)))
  return (df)
}
spatial_firing <- spatial_firing %>%
  mutate(both_asr_b = map2(Rates_averaged_rewarded_b,Rates_averaged_failed_b, join_rates))%>%
  mutate(both_asr_p = map2(Rates_averaged_rewarded_p,Rates_averaged_failed_p, join_rates))

```


## remove ones without any failed trials

1. Write function to sum rates
```{r}
sum_failed_rates <- function(df){
  if(all(is.na(df$Rates[61:120])))
    return(0)
  x = sum(as.numeric(df$Rates[61:120]), na.rm=TRUE)     
}
```

2. Run on dataframe : sum rates across location for each cluster
```{r}

spatial_firing <- spatial_firing %>% 
  mutate(asr_b_failed_sum = map(both_asr_b, sum_failed_rates)) 

```

3. Remove NA's and clusters with no data on probe trials
```{r}
spatial_firing_rewarded <- spatial_firing %>% 
  filter(asr_b_failed_sum > 0)

```

2. Run lm and compare models without reward to models with via anova

```{r}

compare_models_slope <- function(df1){
  fit <- lme4::lmer(Rates ~ Position * Reward_indicator + (Position||Reward_indicator), data = df1, na.action = na.omit) # more complicated model
  prtAnova <- car::Anova(fit, type="II")
  #print(prtAnova$"Pr(>Chisq)"[3][1])
  return (prtAnova$"Pr(>Chisq)"[3][1])
}

compare_models_intercept <- function(df1){
  fit <- lme4::lmer(Rates ~ Position * Reward_indicator + (Position||Reward_indicator), data = df1, na.action = na.omit) # more complicated model
  prtAnova <- car::Anova(fit, type="II")
  #print(prtAnova$"Pr(>Chisq)"[2][1])
  return (prtAnova$"Pr(>Chisq)"[2][1])
}
```

3. Run lm on all cells and extract anova pval

```{r}
spatial_firing_rewarded <- spatial_firing_rewarded %>%
  mutate(pval_slope = map(both_asr_b, compare_models_slope)) %>%
  mutate(pval_intercept = map(both_asr_b, compare_models_intercept))

```


### tag cells based on significance
1. make function
2. run on all neurons
```{r}
mark_neurons_sig <- function(pval){
  if( pval < 0.05) {
    return( "Significant" )
  } else if( pval >= 0.05) {
    return( "Not-Significant" )
  } else {
    return("None")
  }
}

spatial_firing_rewarded <- spatial_firing_rewarded %>%
  mutate(reward_interaction_slope = map(pval_slope, mark_neurons_sig)) %>%
  mutate(reward_interaction_intercept = map(pval_intercept, mark_neurons_sig))

```


### -------------------------------------------------------------------------------------------------------------------------------------------------- ###

5. Plot distribution of slopes with significant and non signifncant ramps


4. extract significant ramps
```{r}
ramps <- subset(spatial_firing_rewarded, lm_result_o_rewarded == "Negative" | lm_result_o_rewarded == "Positive")
outbound_ramps_sig <- subset(ramps, reward_interaction_slope == "Significant"| reward_interaction_intercept == "Significant")

```


```{r}

lm_results <- tibble(Ramp_type = as.character(ramps$lm_result_o_rewarded),
    Slopes = ramps$asr_b_rewarded_slope_o, 
    r2 = ramps$asr_b_rewarded_r2_o, 
    id = ramps$cluster_id)

lm_results_ramps <- tibble(Ramp_type = as.character(outbound_ramps_rewards$lm_result_o_rewarded),
    Slopes = outbound_ramps_rewards$asr_b_rewarded_slope_o, 
    r2 = outbound_ramps_rewards$asr_b_rewarded_r2_o, 
    id = outbound_ramps_rewards$cluster_id)


lm_plot_end <- ggplot(data=lm_results_ramps, aes(x = Slopes, y = r2, color=factor(Ramp_type))) + 
    coord_cartesian(xlim = c(-1,1), ylim = c(0,1)) +
    geom_point() +
    geom_point(data=lm_results, aes(x = Slopes, y = r2), color='grey') +
    geom_point(data=lm_results_ramps, aes(x = Slopes, y = r2, color=factor(Ramp_type))) +
    xlab("\nslope") +
    ylab("R2") +
    theme_classic() +
    scale_color_manual(values=c("red", "red", "red")) +
    theme(axis.text.x = element_text(size=16),
          axis.text.y = element_text(size=16),
          legend.position="bottom", 
          legend.title = element_blank(),
          text = element_text(size=16), 
          legend.text=element_text(size=16), 
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) 

ggsave(file = "plots/b_lm_plot_start_rewards.png", width = 5, height = 6)
```


6. find proportions for above.

```{r}
# extracting diff models 
pos <-subset(spatial_firing, lm_result_o_rewarded == "Positive")
neg <-subset(spatial_firing, lm_result_o_rewarded == "Negative")
none <-subset(spatial_firing, lm_result_o_rewarded == "None")

sig_toreward <- nrow(subset(pos, pval < 0.001 ))/nrow(pos)*100
notsig_toreward <- nrow(subset(pos, pval >= 0.001 ))/nrow(pos)*100

sig_start <- nrow(subset(neg, pval < 0.001 ))/nrow(neg)*100
notsig_start <- nrow(subset(neg, pval >= 0.001 ))/nrow(neg)*100

proportions_mixed_ramps <- tibble(perc=c(sig_start, notsig_start, sig_toreward, notsig_toreward), ramp_id= c("Sig", "Not", "Sig", "Not"),ramp_type = c("Negative", "Negative", "Positive", "Positive"))

```

7. Plot results

```{r}
ggplot(proportions_mixed_ramps, aes(x= ramp_type, y = perc, fill=factor(ramp_id))) +
  coord_cartesian(ylim = c(0,100), xlim=(NULL)) +
  geom_bar(stat="identity",width = 0.9, alpha = .4) +
  labs(y = "Percent") +
  scale_fill_manual(values=c("grey62", "red")) +
  theme_classic() +
  theme(axis.text.x = element_text(size=18),
        axis.text.y = element_text(size=18),
        legend.position="bottom", 
        legend.title = element_blank(),
        text = element_text(size=18), 
        legend.text=element_text(size=18), 
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) +
ggsave(file = "plots/LMStart_cellproportions_hitmiss.png", width = 3, height = 6)

```



```{r}

lm_results <- tibble(Ramp_type = as.character(ramps$lm_result_o_b),
    Slopes = ramps$asr_b_slope_o, 
    r2 = ramps$asr_b_r2_o, 
    id = ramps$cluster_id)

lm_results_ramps <- tibble(Ramp_type = as.character(outbound_ramps_rewards$final_model_o_b),
    Slopes = outbound_ramps_rewards$asr_b_slope_o, 
    r2 = outbound_ramps_rewards$asr_b_r2_o, 
    id = outbound_ramps_rewards$cluster_id)


lm_plot_end <- ggplot(data=lm_results_ramps, aes(x = Slopes, y = r2, color=factor(Ramp_type))) + 
    coord_cartesian(xlim = c(-0.65,0.65), ylim = c(0,1)) +
    geom_point() +
    geom_point(data=lm_results_ramps, aes(x = Slopes, y = r2, color=factor(Ramp_type))) +
    xlab("\nslope") +
    ylab("R2") +
    theme_classic() +
    scale_color_manual(values=c("deeppink1","indianred3", "steelblue3", "darkred", "orchid", "lightseagreen", "darkgreen", "grey32", "grey32")) +
    theme(axis.text.x = element_text(size=16),
          axis.text.y = element_text(size=16),
          legend.position="bottom", 
          legend.title = element_blank(),
          text = element_text(size=16), 
          legend.text=element_text(size=16), 
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) 

ggsave(file = "plots/b_lm_plot_start_rewards_groups.png", width = 5, height = 6)
```


6. find proportions for above.

```{r}
# extracting diff models 
pos <-subset(spatial_firing, final_model_o_b == "P")
speed <-subset(spatial_firing, final_model_o_b == "S")
ccel<-subset(spatial_firing, final_model_o_b == "A")
posspeed <-subset(spatial_firing, final_model_o_b == "PS")
posaccel <-subset(spatial_firing, final_model_o_b == "PA")
speedaccel <-subset(spatial_firing, final_model_o_b == "SA")
posspeedaccel <-subset(spatial_firing, final_model_o_b == "PSA")


sig_p <- nrow(subset(pos, pval < 0.01))/nrow(pos)*100
sig_s <- nrow(subset(speed, pval < 0.01))/nrow(speed)*100
sig_a <- nrow(subset(ccel, pval < 0.01))/nrow(ccel)*100
sig_ps <- nrow(subset(posspeed, pval < 0.01))/nrow(posspeed)*100
sig_pa <- nrow(subset(posaccel, pval < 0.01))/nrow(posaccel)*100
sig_sa <- nrow(subset(speedaccel, pval < 0.01))/nrow(speedaccel)*100
sig_psa <- nrow(subset(posspeedaccel, pval < 0.01))/nrow(posspeedaccel)*100

notsig_p <- nrow(subset(pos, pval > 0.01))/nrow(pos)*100
notsig_s <- nrow(subset(speed, pval > 0.01))/nrow(speed)*100
notsig_a <- nrow(subset(ccel, pval > 0.01))/nrow(ccel)*100
notsig_ps <- nrow(subset(posspeed, pval > 0.01))/nrow(posspeed)*100
notsig_pa <- nrow(subset(posaccel, pval > 0.01))/nrow(posaccel)*100
notsig_sa <- nrow(subset(speedaccel, pval > 0.01))/nrow(speedaccel)*100
notsig_psa <- nrow(subset(posspeedaccel, pval > 0.01))/nrow(posspeedaccel)*100

mixed_ramps <- tibble(perc=c(sig_p,notsig_p,sig_s, notsig_s, sig_a,notsig_a,  sig_ps, notsig_ps, sig_pa, notsig_pa, sig_sa, notsig_sa, sig_psa,notsig_psa), 
                      
                      ramp_id= c("P","P", 
                                 "S", "S", 
                                 "A", "A",
                                 "PS", "PS", 
                                 "PA", "PA", 
                                 "SA", "SA", 
                                 "PAS", "PAS"), 
                      ramp_type= c("Sig", "Not Sig","Sig", "Not Sig", "Sig", "Not Sig","Sig", "Not Sig","Sig", "Not Sig","Sig", "Not Sig", "Sig", "Not Sig" ))


```


7. Plot model results

```{r}
# plot data
level_order <- c("P", "S", "A", "PS", "PA", "SA", "PAS", "None")
ggplot(mixed_ramps, aes(x= factor(ramp_id, level = level_order), y = perc, fill=factor(ramp_type))) +
  geom_bar(stat="identity",width = 0.9, alpha = .7) +
  labs(y = "Percent of neurons identified using LM") +
  scale_fill_manual(values=c("grey","red")) +
  #scale_fill_brewer(palette= "RdYlBu") +
  theme_classic() +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.position="bottom", 
        legend.title = element_blank(),
        text = element_text(size=12), 
        legend.text=element_text(size=12), 
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) +
ggsave(file = "plots/cell_proportions-lmmodel_signeurons.png", width = 3, height =5)


```




### -------------------------------------------------------------------------------------------------------------------------------------------------- ###


Average trials with reward/no reward

1. Write function to add position
```{r}
add_position <- function(df) {
  df <- tibble(Rates = unlist(df)*5, Position = rep(1:200))
}
```

2. Run on dataframe 
```{r}
spatial_firing <- spatial_firing %>%
  mutate(asr_b_rewarded = map(Rates_averaged_rewarded_b, add_position)) %>%
  mutate(asr_b_failed = map(Rates_averaged_failed_b, add_position)) 

```


# Remove NA's and clusters with no data on probe trials

1. Write function to sum rates
```{r}
sum_rates <- function(df){
  if(all(is.na(df))) 
    return(0)
  x = sum(as.numeric(df$Rates[30:90]), na.rm=TRUE)     
}
```

2. Run on dataframe 
```{r}

spatial_firing <- spatial_firing %>% 
  mutate(asr_reward_sum = map(asr_b_rewarded, sum_rates)) %>% 
  mutate(asr_fail_sum = map(asr_b_failed, sum_rates)) 

```

3. Remove NA's and clusters with no data on probe trials
```{r}
spatial_firing <- spatial_firing %>% 
  filter(asr_reward_sum > 0 & asr_fail_sum > 0)
```


```{r}
lm_analysis <- function(df, spike_rate_col, startbin = 30, endbin = 90) {
  spike_rate_col <- enquo(spike_rate_col)
  out_name <- sym(paste0(quo_name(spike_rate_col)))
  sr_unnest_name <- sym(paste0(quo_name(spike_rate_col), "_unnest"))
  fit_name <- sym(paste0(quo_name(out_name), "_fit"))
  glance_name <- sym(paste0(quo_name(out_name), "_glance"))
  r2_name <- sym(paste0(quo_name(out_name), "_r2_o"))
  Pval_name <- sym(paste0(quo_name(out_name), "_Pval_o"))
  slope_name <- sym(paste0(quo_name(out_name), "_slope_o"))
  intercept_name <- sym(paste0(quo_name(out_name), "_intercept_o"))
  df <- df %>%
    mutate(!!fit_name := map(!!spike_rate_col, bins=c(startbin:endbin), lm_helper),
           !!glance_name := map(!!fit_name, glance),
           !!r2_name := map_dbl(!!glance_name, ~.$r.squared),
           !!Pval_name := map_dbl(!!glance_name, ~.$p.value),
           !!slope_name := map_dbl(!!fit_name, ~.$coefficients[2]),
           !!intercept_name := map_dbl(!!fit_name, ~.$coefficients[1]))
}
```

3. run lm on hit miss data
```{r}

spatial_firing <- spatial_firing %>%
  lm_analysis(asr_b_rewarded, 30, 90) %>%
  lm_analysis(asr_b_failed, 30, 90)

```

4. classify cells based on rewarded slope
```{r}

spatial_firing <- spatial_firing %>%
  mutate(lm_result_o_rewarded = pmap(list(asr_b_rewarded_Pval_o, asr_b_rewarded_r2_o, asr_b_rewarded_slope_o,max_r2_o, max_slope_o, min_slope_o), select_final_lm_result))

```


5. extract significant ramps
```{r}
ramps <- subset(spatial_firing, lm_result_o_rewarded == "Negative" | lm_result_o_rewarded == "Positive")
outbound_ramps_sig <- ramps[ramps$pval_slope < 0.05,]
outbound_ramps_notsig <- ramps[ramps$pval_slope >= 0.05,]

outbound_ramps_int_sig <- ramps[ramps$pval_intercept < 0.05,]
outbound_ramps_int_notsig <- ramps[ramps$pval_intercept >= 0.05,]
```

```{r}
slopes <- ggplot(data=ramps, aes(x=as.numeric(asr_b_failed_slope_o), y=as.numeric(asr_b_rewarded_slope_o), color=as.factor(unlist(reward_interaction_final)))) +
  coord_cartesian(xlim=c(-1,1), ylim=c(-1,1)) +
  geom_point(size=1, alpha=0.8) +
  theme_classic() +
  scale_color_manual(values=c("grey", "dodgerblue", "yellow", "orange")) +
  geom_abline(slope=1, intercept=0, color ="grey") + 
  labs(x = "\nSlope (miss)\n", y = "\nSlope (hit)\n") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        legend.text = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/LMStart_slopecomparison_allramps.png", ggMarginal(slopes, type = "density", groupColour = TRUE, groupFill = TRUE, margins = c("both"), size=4), width = 4.5, height = 4)

slopes <- ggplot(data=outbound_ramps_sig, aes(x=as.numeric(asr_b_failed_slope_o), y=as.numeric(asr_b_rewarded_slope_o), color=as.factor(unlist(lm_result_o_rewarded)), alpha=0.5)) +
  coord_cartesian(xlim=c(-1,1), ylim=c(-1,1)) +
  geom_point(size=1) +
  geom_point(data=outbound_ramps_notsig, aes(x=as.numeric(asr_b_failed_slope_o), y=as.numeric(asr_b_rewarded_slope_o), color=as.factor(unlist(lm_result_o_rewarded)), size=1)) +
  theme_classic() +
  scale_color_manual(values=c("violetred2", "chartreuse3", "blue", "green")) +
  geom_abline(slope=1, intercept=0, color ="grey") + 
  labs(x = "\nSlope (miss)\n", y = "\nSlope (hit)\n") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        legend.text = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/LMStart_slopecomparison_allramps2.png",width = 4.5, height = 4)
```

```{r}

slopes <- ggplot(data=outbound_ramps_sig, aes(x=as.numeric(asr_b_failed_slope_o), y=as.numeric(asr_b_rewarded_slope_o), color=as.factor(unlist(lm_result_o_rewarded)))) +
  coord_cartesian(xlim=c(-1,1), ylim=c(-1,1)) +
  geom_point(size=1) +
  theme_classic() +
  scale_color_manual(values=c("violetred2", "chartreuse3", "grey", "grey")) +
  geom_abline(slope=1, intercept=0, color ="grey") + 
  labs(x = "\nSlope (miss)\n", y = "\nSlope (hit)\n") +
  theme(axis.text.x = element_text(size=14),
        axis.text.y = element_text(size=14),
        legend.title = element_blank(),
        legend.text = element_blank(),
        text = element_text(size=14))
ggsave(file = "plots/LMStart_slopecomparison_sigramps.png", width = 4.5, height = 4)

slopes <- ggplot(data=outbound_ramps_notsig, aes(x=as.numeric(asr_b_failed_slope_o), y=as.numeric(asr_b_rewarded_slope_o), color=as.factor(unlist(lm_result_o_rewarded)))) +
  coord_cartesian(xlim=c(-1,1), ylim=c(-1,1)) +
  geom_point(size=1) +
  theme_classic() +
  scale_color_manual(values=c("violetred2", "chartreuse3")) +
  geom_abline(slope=1, intercept=0, color ="grey") + 
  labs(x = "\nSlope (miss)\n", y = "\nSlope (hit)\n") +
  theme(axis.text.x = element_text(size=14),
        axis.text.y = element_text(size=14),
        legend.title = element_blank(),
        legend.text = element_blank(),
        text = element_text(size=14))
ggsave(file = "plots/LMStart_slopecomparison_nonsigramps.png", width = 4.5, height = 4)
```


```{r}

slopes <- ggplot(data=outbound_ramps_int_sig, aes(x=as.numeric(asr_b_failed_slope_o), y=as.numeric(asr_b_rewarded_slope_o), color=as.factor(unlist(lm_result_o_rewarded)))) +
  coord_cartesian(xlim=c(-1,1), ylim=c(-1,1)) +
  geom_point(size=1) +
  theme_classic() +
  scale_color_manual(values=c("violetred2", "chartreuse3")) +
  geom_abline(slope=1, intercept=0, color ="grey") + 
  labs(x = "\nSlope (miss)\n", y = "\nSlope (hit)\n") +
  theme(axis.text.x = element_text(size=14),
        axis.text.y = element_text(size=14),
        legend.title = element_blank(),
        legend.text = element_blank(),
        text = element_text(size=14))
ggsave(file = "plots/LMStart_slopecomparison_siginterceptramps.png", width = 4.5, height = 4)

slopes <- ggplot(data=outbound_ramps_int_notsig, aes(x=as.numeric(asr_b_failed_slope_o), y=as.numeric(asr_b_rewarded_slope_o), color=as.factor(unlist(lm_result_o_rewarded)))) +
  coord_cartesian(xlim=c(-1,1), ylim=c(-1,1)) +
  geom_point(size=1) +
  theme_classic() +
  scale_color_manual(values=c("violetred2", "chartreuse3")) +
  geom_abline(slope=1, intercept=0, color ="grey") + 
  labs(x = "\nSlope (miss)\n", y = "\nSlope (hit)\n") +
  theme(axis.text.x = element_text(size=14),
        axis.text.y = element_text(size=14),
        legend.title = element_blank(),
        legend.text = element_blank(),
        text = element_text(size=14))
ggsave(file = "plots/LMStart_slopecomparison_nonsiginterceptramps.png", width = 4.5, height = 4)
```
# as above but for specific groups
```{r}
slopes <- ggplot(data=subset(outbound_ramps_sig, final_model_o_b == "A"), aes(x=as.numeric(asr_b_failed_slope_o), y=as.numeric(asr_b_rewarded_slope_o), color=as.factor(unlist(lm_result_o_rewarded)))) +
  coord_cartesian(xlim=c(-1,1), ylim=c(-1,1)) +
  geom_point() +
  theme_classic() +
  scale_color_manual(values=c("violetred2", "chartreuse3")) +
  geom_abline(slope=1, intercept=0, color ="grey") + 
  labs(x = "\nSlope (miss) \n", y = "Slope (hit) \n") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        legend.text = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/LMStart_slopecomparison_signeurons_A.png", width = 4.5, height = 4)

slopes <- ggplot(data=subset(outbound_ramps_notsig, final_model_o_b == "A"), aes(x=as.numeric(asr_b_failed_slope_o), y=as.numeric(asr_b_rewarded_slope_o), color=as.factor(unlist(lm_result_o_rewarded)))) +
  coord_cartesian(xlim=c(-1,1), ylim=c(-1,1)) +
  geom_point() +
  theme_classic() +
  scale_color_manual(values=c("violetred2", "chartreuse3")) +
  geom_abline(slope=1, intercept=0, color ="grey") + 
  labs(x = "\nSlope (miss) \n", y = "Slope (hit) \n") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        legend.text = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/LMStart_slopecomparison_notsigneurons_A.png", width = 4.5, height = 4)

```


# same as above but for intercept

```{r}
intercept <- ggplot(data=outbound_ramps_sig, aes(x=as.numeric(asr_b_failed_intercept_o), y=as.numeric(asr_b_rewarded_intercept_o), color=as.factor(unlist(lm_result_o_rewarded)))) +
  geom_point() +
  coord_cartesian(xlim=c(0,200), ylim=c(0,200)) +
  scale_color_manual(values=c("violetred2", "chartreuse3")) +
  geom_abline(slope=1, intercept=0, color ="grey") + 
  theme_classic() +
  labs(x = "\nIntercept (miss) \n", y = "\nIntercept (hit)\n") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
         legend.text = element_blank(),
       text = element_text(size=12))
ggsave(file = "plots/LMStart_interceptcomparison_sigcells.png", width = 4.5, height = 4)

intercept <- ggplot(data=outbound_ramps_notsig, aes(x=as.numeric(asr_b_failed_intercept_o), y=as.numeric(asr_b_rewarded_intercept_o), color=as.factor(unlist(lm_result_o_rewarded)))) +
  geom_point() +
  coord_cartesian(xlim=c(0,200), ylim=c(0,200)) +
  scale_color_manual(values=c("violetred2", "chartreuse3")) +
  geom_abline(slope=1, intercept=0, color ="grey") + 
  theme_classic() +
  labs(x = "\nIntercept (miss) \n", y = "\nIntercept (hit)\n") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
         legend.text = element_blank(),
       text = element_text(size=12))
ggsave(file = "plots/LMStart_interceptcomparison_nonsigcells.png", width = 4.5, height = 4)

```



```{r}
ggplot(data=subset(outbound_ramps_sig, final_model_o_b == "A"), aes(x=as.numeric(asr_b_failed_intercept_o), y=as.numeric(asr_b_rewarded_intercept_o), color=as.factor(unlist(lm_result_o_b)))) +
  coord_cartesian(xlim=c(0,200), ylim=c(0,200)) +
  geom_point() +
  theme_classic() +
  scale_color_manual(values=c("violetred2", "chartreuse3")) +
  geom_abline(slope=1, intercept=0, color ="grey") + 
  labs(x = "\nSlope (miss) \n", y = "Slope (hit) \n") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        legend.text = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/LMStart_interceptcomparison_sigcells_A.png", width = 3.5, height = 3)

ggplot(data=subset(outbound_ramps_sig, final_model_o_b == "A"), aes(x=as.numeric(asr_b_failed_intercept_o), y=as.numeric(asr_b_rewarded_intercept_o), color=as.factor(unlist(lm_result_o_b)))) +
  coord_cartesian(xlim=c(0,200), ylim=c(0,200)) +
  geom_point() +
  theme_classic() +
  scale_color_manual(values=c("violetred2", "chartreuse3")) +
  geom_abline(slope=1, intercept=0, color ="grey") + 
  labs(x = "\nSlope (miss) \n", y = "Slope (hit) \n") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        legend.text = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/LMStart_interceptcomparison_sigcells_A.png", width = 3.5, height = 3)
```

4. hit - miss slope
```{r}


slope_comparison_ramps_neg <- function(hit, miss) {
  #i.e. hit = -2 and miss = -0.2 hit + miss 
  x = (as.numeric(hit) + as.numeric(miss))
  return (x)
}

slope_comparison <- function(hit, miss) {
  #i.e. hit = -2 and miss = -0.2 hit + miss 
  x = (as.numeric(hit) - as.numeric(miss))
  return (x)
}


spatial_firing <- spatial_firing %>%
  mutate(slope_diff = map2(asr_b_rewarded_slope_o,asr_b_failed_slope_o, slope_comparison))
  
```

# find diff in intercept between hit and miss trials
```{r}


intercept_comparison <- function(hit, miss) {
  x = (as.numeric(hit) - as.numeric(miss))
  return (x)
}


spatial_firing <- spatial_firing %>%
  mutate(intercept_diff = map2(asr_b_rewarded_intercept_o,asr_b_failed_intercept_o, intercept_comparison))
```

# export results to CSV
```{r}
spatial_firing_save <- subset(ramps, select = c("session_id", "cluster_id","slope_diff","slope_diff_h"))
spatial_firing_save <- tibble(session_id = spatial_firing_save$session_id, cluster_id = spatial_firing_save$cluster_id, slope_diff =  as.character(spatial_firing_save$slope_diff), slope_diff_homebound =  as.character(spatial_firing_save$slope_diff_h))
write.table(spatial_firing_save, "spatial_firing_slopediff.txt", quote=FALSE, sep="\t")
```


5. extract significant ramps
```{r}
ramps <- subset(spatial_firing, lm_result_o_rewarded == "Negative" | lm_result_o_rewarded == "Positive")
outbound_ramps_sig <- ramps[ramps$pval_slope < 0.05,]
outbound_ramps_notsig <- ramps[ramps$pval_slope >= 0.05 & ramps$pval_intercept >= 0.05,]
outbound_ramps_int_sig <- ramps[ramps$pval_intercept < 0.05,]
```




```{r}
intercept <- ggplot(data=outbound_ramps_sig, aes(x=as.numeric(intercept_diff), y=as.numeric(slope_diff), color=as.factor(unlist(lm_result_o_rewarded)))) +
  geom_point(size=1) +
  coord_cartesian(ylim=c(-1,1), xlim=c(-25,40)) +
  scale_color_manual(values=c("violetred2", "chartreuse3")) +
  theme_classic() +
  labs(y = "\nSlope diff \n", x = "\nIntercept diff (cm)\n") +
  #geom_abline(slope=40, intercept= as.numeric(-10), color ="grey") + 
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
       text = element_text(size=12))
ggsave(file = "plots/hitmiss_comparison_sigcells.png", width = 4.5, height = 4)

intercept <- ggplot(data=outbound_ramps_notsig, aes(x=as.numeric(intercept_diff), y=as.numeric(slope_diff), color=as.factor(unlist(lm_result_o_rewarded)))) +
  geom_point(size=1) +
  coord_cartesian(ylim=c(-1,1), xlim=c(-25,40)) +
  scale_color_manual(values=c("violetred2", "chartreuse3")) +
  theme_classic() +
  labs(y = "\nSlope diff \n", x = "\nIntercept diff (cm)\n") +
  #geom_abline(slope=40, intercept= as.numeric(-10), color ="grey") + 
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
       text = element_text(size=12))
ggsave(file = "plots/hitmiss_comparison_nonsigcells.png", width = 4.5, height = 4)

intercept <- ggplot(data=outbound_ramps_int_sig, aes(x=as.numeric(intercept_diff), y=as.numeric(slope_diff), color=as.factor(unlist(lm_result_o_rewarded)))) +
  geom_point(size=1) +
  coord_cartesian(ylim=c(-1,1), xlim=c(-25,40)) +
  scale_color_manual(values=c("violetred2", "chartreuse3")) +
  theme_classic() +
  labs(y = "\nSlope diff \n", x = "\nIntercept diff (cm)\n") +
  #geom_abline(slope=40, intercept= as.numeric(-10), color ="grey") + 
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
       text = element_text(size=12))
ggsave(file = "plots/hitmiss_comparison_intsigcells.png", width = 4.5, height = 4)
```



5. plot distrubution of slopes 

```{r}
ggplot(data=outbound_ramps_sig, aes(x=as.numeric(slope_diff), fill=unlist(lm_result_o_rewarded))) +
  coord_cartesian(xlim=c(-1,1)) +
  geom_histogram(alpha=0.2, binwidth=0.1) +
  theme_classic() +
  scale_fill_manual(values=c("violetred2", "chartreuse3")) +
  labs(x = "\nSlope (Hit - Miss)\n", y = "\nCount\n") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
         legend.text = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/LMStart_hitmiss_sigcells.png", width = 3.5, height = 3)

ggplot(data=outbound_ramps_notsig, aes(x=as.numeric(slope_diff), fill=unlist(lm_result_o_rewarded))) +
  coord_cartesian(xlim=c(-1,1)) +
  geom_histogram(alpha=0.2, binwidth=0.1) +
  theme_classic() +
  scale_fill_manual(values=c("violetred2", "chartreuse3")) +
  labs(x = "\nSlope (Hit - Miss)\n", y = "\nCount\n") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
         legend.text = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/LMStart_hitmiss_notsigcells.png", width = 3.5, height = 3)

```


5. plot distrubution of slopes 

```{r}
ggplot(data=subset(outbound_ramps_sig, final_model_o_b == "P"), aes(x=as.numeric(unlist(slope_diff)), fill=as.factor(unlist(lm_result_o_rewarded)))) +
  coord_cartesian(xlim=c(-1,1)) +
  geom_histogram(alpha=0.2, binwidth=0.1) +
  scale_fill_manual(values=c("violetred2", "chartreuse3")) +
  theme_classic() +
  labs(x = "\nSlope (Hit - Miss)\n", y = "\nCount\n") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
         legend.text = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/LMStart_hitmiss_sig_PS.png", width = 3.5, height = 3)


ggplot(data=subset(outbound_ramps_notsig, final_model_o_b == "P"), aes(x=as.numeric(unlist(slope_diff)), fill=as.factor(unlist(lm_result_o_rewarded)))) +
  coord_cartesian(xlim=c(-1,1)) +
  geom_histogram(alpha=0.2, binwidth=0.1) +
  scale_fill_manual(values=c("violetred2", "chartreuse3")) +
  theme_classic() +
  labs(x = "\nSlope (Hit - Miss)\n", y = "\nCount\n") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
         legend.text = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/LMStart_hitmiss_notsig_PS.png", width = 3.5, height = 3)

```


7. plot distribution of intercept 
```{r}
ggplot(data=outbound_ramps_sig, aes(x=as.numeric(intercept_diff), fill=unlist(lm_result_o_rewarded))) +
  coord_cartesian(xlim=c(-50,50)) +
  geom_histogram(alpha=0.2, binwidth=1) +
  theme_classic() +
  scale_fill_manual(values=c("violetred2", "chartreuse3")) +
  labs(x = "\nSlope (Hit - Miss)\n", y = "\nCount\n") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
         legend.text = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/outbound_interceptdiff_hitmiss_sigcells.png", width = 3.5, height = 3)

ggplot(data=outbound_ramps_notsig, aes(x=as.numeric(intercept_diff), fill=unlist(lm_result_o_rewarded))) +
  coord_cartesian(xlim=c(-50,50)) +
  geom_histogram(alpha=0.2, binwidth=1) +
  theme_classic() +
  scale_fill_manual(values=c("violetred2", "chartreuse3")) +
  labs(x = "\nSlope (Hit - Miss)\n", y = "\nCount\n") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
         legend.text = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/outbound_interceptdiff_hitmiss_notsigcells.png", width = 3.5, height = 3)

```


## 

```{r}
ggplot(data=subset(spatial_firing, lm_result_o_b == "Negative"), aes(x=as.numeric(unlist(slope_diff)), fill=as.factor(unlist(final_model_o_b)))) +
  coord_cartesian(xlim=c(-1,1)) +
  geom_histogram(alpha=0.2, binwidth=0.1) +
  scale_fill_manual(values=c("deeppink1","indianred3", "steelblue3", "darkred", "orchid", "lightseagreen", "darkgreen", "grey32")) +
  theme_classic() +
  labs(x = "Slope (Hit - Miss)", y = "Count") +
  theme(axis.text.x = element_text(size=14),
        axis.text.y = element_text(size=14),
        legend.title = element_blank(),
        text = element_text(size=14))
ggsave(file = "plots/LMStart_hitmiss_negative_types.png", width = 3, height = 4)

```

