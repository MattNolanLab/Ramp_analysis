---
title: "RampCodes_Supplemental6"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




## Plot shuffled example for Supplemental Figure 6


1. Function to generate shuffles
- shuffles spikes using sample() function
- runs lm
- extracts coefficients
- stores coefficients for each 1000 shuffles (less memory than saving 1000 shuffles)
```{r}
# shuffles defines the number of shuffes. Use a smaller value for testing.
shuffle_rates_example <- function(df, startbin, endbin, shuffles = 10) {
  df_modified <- data.frame(neuron=as.numeric(),
                 Rates=as.double(),
                 slope=as.numeric(), 
                 rsquared=as.numeric(), 
                 pval=vector())
  names(df_modified) <- c("neuron", "Rates", "slope", "rsquared", "pval")
  x <- 1
  repeat {
  shuff_df <- tibble(Rates = sample(as.vector(unlist(df)),replace = TRUE, prob = NULL), Position = c(1:199))
  df_mod <- lm_helper(shuff_df, startbin, endbin)
  data <- data.frame(as.numeric(x), list(shuff_df$Rates), df_mod$slope, df_mod$r.squared, df_mod$p.value)
  names(data) <- c("neuron", "Rates" ,"slope", "r.squared", "p.value")
  df_modified <- rbind(df_modified,data)

  x = x+1
  if (x == shuffles){ 
  break
  }
  }
return(df_modified)
}
```

2. Run if shuffles haven't already been generated.
```{r}

# Check to see if the column shuffle_results exists. If it does then don't run again.
shuffles <- 1000
spatial_firing_example <- spatial_firing[14,] %>%
  select(cluster_id, session_id, Rates_averaged_rewarded_b, asr_b_o_rewarded_fit_r.squared, asr_b_o_rewarded_fit_slope) %>%
  mutate(shuffle_rates = pmap(list(Rates_averaged_rewarded_b, 30, 90, shuffles), shuffle_rates_example))

```

```{r}
spatial_firing_example <- spatial_firing_example %>%
  unnest_wider(shuffle_rates, names_sep = "_", names_repair = "universal")

```


Function to plot mean and SEM of firing rate as a function of position.
```{r}
position = c(-29:169)
rates = unlist(unlist(spatial_firing_example$Rates_averaged_rewarded_b))

ggplot() +
  geom_point(aes(x=position, y=rates)) +
  theme_classic() +
  annotate("rect", xmin=-30, xmax=0, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=140, xmax=170, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=60, xmax=80, ymin=5,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
  scale_x_continuous(breaks=seq(-30,170,100), expand = c(0, 0)) +
  scale_y_continuous(breaks=seq(5,50,10), expand = c(0, 0)) +
  labs(y = "Mean firing rate (Hz)", x = "Position") +
  theme(axis.text.x = element_text(size=18),
        axis.text.y = element_text(size=18),
        legend.title = element_blank(),
        text = element_text(size=18),
        plot.margin = margin(21, 25, 5, 20))
 ggsave(file = "plots/ExampleShuffled_Real.png",  width = 3.6, height = 2.9) 

```



Function to plot mean and SEM of firing rate as a function of position.
```{r}
position = c(-29:169)
rates = unlist(unlist(spatial_firing_example$shuffle_rates_Rates[2]))

ggplot() +
  geom_point(aes(x=position, y=rates)) +
  theme_classic() +
  annotate("rect", xmin=-30, xmax=0, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=140, xmax=170, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=60, xmax=80, ymin=5,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
  #scale_x_continuous(breaks=seq(-30,170,100), expand = c(0, 0)) +
  #scale_y_continuous(breaks=seq(15,60,10), expand = c(0, 0)) +
  labs(y = "Mean firing rate (Hz)", x = "Position") +
  theme(axis.text.x = element_text(size=18),
        axis.text.y = element_text(size=18),
        legend.title = element_blank(),
        text = element_text(size=18),
        plot.margin = margin(21, 25, 5, 20))
 ggsave(file = "plots/ExampleShuffled_Shuffled.png",  width = 3.6, height = 2.9) 

```


2. Run if shuffles haven't already been generated.
```{r}

# Check to see if the column shuffle_results exists. If it does then don't run again.
shuffles <- 1000
spatial_firing_example <- spatial_firing[14,] %>%
  select(cluster_id, session_id, Rates_averaged_rewarded_b, asr_b_o_rewarded_fit_r.squared, asr_b_o_rewarded_fit_slope) %>%
  mutate(shuffle_results = pmap(list(Rates_averaged_rewarded_b, 30, 90, shuffles), shuffle_rates))

```

2. Run on all neurons
```{r}
spatial_firing_example <- spatial_firing_example %>%
  mutate(shuffle_min_slope = map_dbl(shuffle_results, extract_min_shuffle_slopes),
         shuffle_max_slope = map_dbl(shuffle_results, extract_max_shuffle_slopes))

```


We also want to extract slopes, r2 and pvalues of the 1000 shuffles for each neuron

1. Extract shuffle results (slopes and r2 for each shuffle)
2. run on all neurons
```{r}
spatial_firing_example <- spatial_firing_example %>%
  unnest_wider(shuffle_results, names_sep = "_", names_repair = "universal") 
```

1. extract shuffled values into tibble _each 1000 shuffled datasets are nested for each neuron_
```{r}
shuff_slopes <- tibble(slopes = unlist(spatial_firing_example$shuffle_results_slope), r2 = unlist(spatial_firing_example$shuffle_results_r.squared))
```



Plot distribution of the shuffled data

1. Extract shuffled slopes and rsquared values. This is already done above.

2. Plot in scatter
```{r}
ggplot(data=spatial_firing_example) +
    geom_point(data=shuff_slopes, aes(x = slopes, y = r2)) +
    geom_point(data=spatial_firing_example, aes(x = asr_b_o_rewarded_fit_slope, y = asr_b_o_rewarded_fit_r.squared), color="Red") +
    geom_vline(xintercept = spatial_firing_example$shuffle_min_slope, linetype="dotted", 
                color = "blue", size=1) +
    geom_vline(xintercept = spatial_firing_example$shuffle_max_slope, linetype="dotted", 
                color = "blue", size=1) +  
    xlab("\nslope") +
    ylab("R2") +
    theme_classic() +
    theme(axis.text.x = element_text(size=12),
          axis.text.y = element_text(size=12),
          legend.position="bottom",
          legend.title = element_blank(),
          text = element_text(size=12),
          legend.text=element_text(size=12),
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)))
if (save_figures == 1) {
  ggsave(file = "plots/Outbound_coefficient_scatter_shuffledeg.png", width = 3.5, height = 2.5)
}
```



