---
title: "Figure7"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



### --------------------------------------------------------------------------------------- ###

## Differences in the positional dependance of firing between rewarded trials, run through trials and trials where the animal "tries" 

trial types :
1. rewarded = animal recieves a reward
2. try = speed in the reward zone is within the 95% confidence interval of speed in the reward zone in
rewarded trials
3. run through = speed in the reward zone is outside the 95% confidence interval of speed in the reward zone in rewarded trials


### --------------------------------------------------------------------------------------- ###

First combine hit and miss trials together with an indicator of trial type (hit, try, run)

Function to join firing rates from different trial types and add indicator of the type of trial
```{r}
join_rates <- function(hit, run, try, session_id, cluster_id) {
  if (any(is.na(hit)) | any(is.na(run)) | any(is.na(try))) { 
    return(
      df <- tibble(Rates = rep(NA, times=600), 
               Position = rep(NA, times=600),
               Reward_indicator = c(rep("Rewarded", times=200), rep("Run Through", times=200), rep("Try", times=200)))
    )
  }
  df <- tibble(Rates = c(unlist(hit), unlist(run), unlist(try)), Reward_indicator = c(rep("Rewarded", times=200), rep("Run Through", times=200), rep("Try", times=200)), Position = c(rep(1:200), rep(1:200), rep(1:200)))
  return (df)
}

```

1. Generate firing rate tibble for each cell
```{r}
spatial_firing <- spatial_firing %>%
  mutate(avg_both_asr_b = pmap(list(Rates_averaged_rewarded_b, Rates_averaged_runthru_b, Rates_averaged_try_b, session_id, cluster_id), join_rates))

```

Function to run linear model that takes trial type (hit, try, run) into account and use the car package to extract slope significance
```{r}
compare_models_slope <- function(df, run,try){
 # Check for NAs
  if (any(is.na(run)) | any(is.na(try))) { 
    return(NA)
  }
 df <- df %>%
  filter(Position > 30, Position < 90)
  fit <- lme4::lmer(Rates ~ Position * Reward_indicator + (Position||Reward_indicator), data = df, na.action = na.omit, REML = FALSE) 
  prtAnova <- car::Anova(fit, type="II")
  return (prtAnova$"Pr(>Chisq)"[3][1])
}
```

2. Run linear model on all cells and extract pval
```{r}
spatial_firing <- spatial_firing %>%
  mutate(avg_pval_slope = pmap(list(avg_both_asr_b, Rates_averaged_runthru_b, Rates_averaged_try_b), compare_models_slope))

```

Now we can classify cells based on their significance in the above model

First make function to classify neurons
```{r}
mark_neurons_sig <- function(pval){
  if (any(is.na(pval))) {
    return(NA)
  }
  if( pval < 0.01) {
    return( "Significant" )
  } else if( pval >= 0.01) {
    return( "Not-Significant" )
  } else {
    return("None")
  }
}
```

3. Make new column to identify whether cells are significant
```{r}
spatial_firing <- spatial_firing %>%
  mutate(reward_interaction_id = map(avg_pval_slope, mark_neurons_sig))
```

### ----------------------------------------------------------------------------- ###

We also want to run a simple linear model for each trial type separately so we can extract the coefficients for each variable. 

First, add position to each of the firing rates individually (before we put them all in one tibble, here we make a seperate one for each and add it back into the dataframe)


Function to add position for individual trial type, returns NAs if those trials are not present 
```{r}
add_position <- function(df, session_id, cluster_id) {
  if(all(is.na(df))){
    print(paste0("All NAs. Session: ", session_id, ". Cluster:", cluster_id))
    df <- tibble(Rates = rep(NA, times=200), 
                 Position = rep(NA, times=200))
    return(df)
    }
  df <- tibble(Rates = unlist(df), Position = rep(1:200)) 
  return(df)
}
```

1. Run this on all animals for try and run through trials (we already have coefficients for rewarded data from Figure 2)
```{r}
spatial_firing <- spatial_firing %>%
  mutate(asr_b_try = pmap(list(Rates_averaged_try_b, session_id, cluster_id), add_position),
         asr_b_run = pmap(list(Rates_averaged_runthru_b, session_id, cluster_id), add_position)
         )
```

2. run lm on all cells.
Removes any previously generated results (select), fits the data (mutate) and then adds model outputs as columns to spatial firing (unnest_wider).
```{r}
spatial_firing <- spatial_firing %>%
  select(-contains('asr_b_try_fit_')) %>%
  select(-contains('asr_b_run_fit_')) %>%
  mutate(asr_b_try_fit = pmap(list(asr_b_try, 30, 90), lm_helper)) %>%
  mutate(asr_b_run_fit = pmap(list(asr_b_run, 30, 90), lm_helper)) %>%
  unnest_wider(asr_b_try_fit, names_sep = "_", names_repair = "universal") %>%
  unnest_wider(asr_b_run_fit, names_sep = "_", names_repair = "universal")

```

Linear model results are stored in:
spatial_firing$asr_b_try_fit_pval
spatial_firing$asr_b_try_fit_slope
spatial_firing$asr_b_try_fit_r.squared

Now we can plot the coefficients for each trial type, marked by whether or not the cells are significantly modulated by trial type (hit, try, run)

3. subset by outbound ramps (Figure 2)
```{r}
ramps <- subset(spatial_firing, lm_group_b == "Negative" | lm_group_b == "Positive")
ramps <- subset(ramps, final_model_o_b == "P" | final_model_o_b == "PSA")

```

4. Plot slope coefficient for rewarded trials and run through trials
```{r}
ggplot(data=ramps, aes(x = asr_b_o_rewarded_fit_slope,
                                y = asr_b_run_fit_slope, 
                                fill = factor(unlist(reward_interaction_id)),
                                color = factor(unlist(reward_interaction_id)))) +
    coord_cartesian(xlim=c(-0.55,0.55), y=c(-0.55,0.55)) +
    geom_point(alpha=0.3) +
    scale_fill_manual(values=c("grey", "red", "blue")) +
    scale_color_manual(values=c("grey", "red", "blue")) +
    xlab("\nslope") +
    ylab("R2") +
    theme_classic() +
    theme(axis.text.x = element_text(size=14),
          axis.text.y = element_text(size=14),
          legend.position="bottom", 
          legend.title = element_blank(),
          text = element_text(size=14), 
          legend.text=element_text(size=14), 
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) 
ggsave(file = "plots/SlopeScatter_reward_vs_run.png", width = 4, height = 3.5)
```
,5. Plot slope coefficients for rewarded trials and trials where the animal tries to stop
```{r}
ggplot(data=ramps, aes(x = asr_b_o_rewarded_fit_slope,
                                y = asr_b_try_fit_slope, 
                                fill = factor(unlist(reward_interaction_id)),
                                color = factor(unlist(reward_interaction_id)))) +
    coord_cartesian(xlim=c(-0.55,0.55), y=c(-0.55,0.55)) +
    geom_point(alpha=0.3) +
    scale_fill_manual(values=c("grey", "red", "blue")) +
    scale_color_manual(values=c("grey", "red", "blue")) +
    xlab("\nslope") +
    ylab("R2") +
    theme_classic() +
    theme(axis.text.x = element_text(size=14),
          axis.text.y = element_text(size=14),
          legend.position="bottom", 
          legend.title = element_blank(),
          text = element_text(size=14), 
          legend.text=element_text(size=14), 
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) 
ggsave(file = "plots/SlopeScatter_reward_vs_try.png", width = 4, height = 3.5)
```

3. subset by outbound ramps (Figure 2)
```{r}
ramps <- subset(spatial_firing, lm_group_b == "Negative" | lm_group_b == "Positive")

ramps <- subset(spatial_firing, final_model_o_b == "S" | final_model_o_b == "SA" | final_model_o_b == "A")

```

4. Plot slope coefficient for rewarded trials and run through trials
```{r}
ggplot(data=ramps, aes(x = asr_b_o_rewarded_fit_slope,
                                y = asr_b_run_fit_slope, 
                                fill = factor(unlist(reward_interaction_id)),
                                color = factor(unlist(reward_interaction_id)))) +
    coord_cartesian(xlim=c(-0.35,0.35), y=c(-0.35,0.35)) +
    geom_point(alpha=0.3) +
    scale_fill_manual(values=c("grey", "red", "blue")) +
    scale_color_manual(values=c("grey", "red", "blue")) +
    xlab("\nslope") +
    ylab("R2") +
    theme_classic() +
    theme(axis.text.x = element_text(size=14),
          axis.text.y = element_text(size=14),
          legend.position="bottom", 
          legend.title = element_blank(),
          text = element_text(size=14), 
          legend.text=element_text(size=14), 
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) 
ggsave(file = "plots/SlopeScatter_reward_vs_run_speed.png", width = 4, height = 3.5)
```
,5. Plot slope coefficients for rewarded trials and trials where the animal tries to stop
```{r}
ggplot(data=ramps, aes(x = asr_b_o_rewarded_fit_slope,
                                y = asr_b_try_fit_slope, 
                                fill = factor(unlist(reward_interaction_id)),
                                color = factor(unlist(reward_interaction_id)))) +
    coord_cartesian(xlim=c(-0.35,0.35), y=c(-0.35,0.35)) +
    geom_point(alpha=0.3) +
    scale_fill_manual(values=c("grey", "red", "blue")) +
    scale_color_manual(values=c("grey", "red", "blue")) +
    xlab("\nslope") +
    ylab("R2") +
    theme_classic() +
    theme(axis.text.x = element_text(size=14),
          axis.text.y = element_text(size=14),
          legend.position="bottom", 
          legend.title = element_blank(),
          text = element_text(size=14), 
          legend.text=element_text(size=14), 
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) 
ggsave(file = "plots/SlopeScatter_reward_vs_try_speed.png", width = 4, height = 3.5)
```
### ----------------------------------------------------------------------------------------- ###

Now we want to examine if there are differences in the reset activity between trial types (hit, try, run)

To do this, we can plot population rate for rewarded and failed trials across whole track 


1. Split data based on cue independant/cue dependant (Figure 5) and encoding group (Figure 3) as we are only interested in position neurons here
```{r}
position_neurons <- filter(spatial_firing, cue_group_o == "Positive-PI" | cue_group_o == "Negative-PI", final_model_o_b == "P" )
```

Function to plot data mean and SD of the population data based on the classification, as per Figure 2, and classification as per figure 5, on beaconed trials in the outbound and homebound regions of the track.
```{r}
mean_SD_plots_with_reset <- function(df, group_b, group_h, track_group, x_start = 30, x_end = 90){

 df <- df %>%
  filter(lm_group_b == group_b,
         lm_group_b_h == group_h, 
         reset_group == track_group) %>%
  select(avg_both_asr_b) %>%
  unnest(c(avg_both_asr_b))
 
 df$Rates <- as.double(df$Rates)

 df <- df %>%
   group_by(Position, Reward_indicator) %>%
   dplyr::summarise(mean_b = mean(Rates, na.rm = TRUE),
             se_b = std.error(Rates, na.rm = TRUE))
 
 ggplot(data=df) +
  annotate("rect", xmin=0, xmax=30, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=170, xmax=200, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=90, xmax=110, ymin=5,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
  geom_ribbon(aes(x=Position, y=mean_b, ymin = mean_b - se_b, ymax = mean_b + se_b,
                  fill=factor(Reward_indicator)), alpha=0.1) +
   geom_line(aes(y=mean_b, x=Position, color=factor(Reward_indicator)), alpha=0.5) +
   scale_fill_manual(values=c("black", "red", "blue")) +
   scale_color_manual(values=c("black", "red", "blue")) +
   theme_classic() +
   labs(y = "Mean firing rate (Hz)", x = "Position") +
   xlim(x_start, x_end) +
   theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        text = element_text(size=12))
}
```

2. Subset data by group then average rates for plotting          **Negative Negative Continuous**
```{r}
(NegNegC_plot <- mean_SD_plots_with_reset(position_neurons, "Negative", "Negative", "Continuous",  0, 200))
ggsave(file = "plots/NegNeg_Continuous_failed_PI_justposition.png", width = 4.5, height = 2.5)
```
3. Subset data by group then average rates for plotting          **Negative Negative Reset**
```{r}
(NegNegR_plot <- mean_SD_plots_with_reset(position_neurons, "Negative", "Negative", "Reset",  0, 200))
ggsave(file = "plots/NegNeg_Reset_failed_PI_justposition.png", width = 4.5, height = 2.5)
```

4. Subset data by group then average rates for plotting          **Positive Positive Continuous**
```{r}
(PosPosC_plot <- mean_SD_plots_with_reset(position_neurons, "Positive", "Positive", "Continuous", 0, 200))
ggsave(file = "plots/PosPos_Continuous_failed_PI_justposition.png", width = 4.5, height = 2.5)
```

5. Subset data by group then average rates for plotting          **Positive Positive Reset**
```{r}
(PosPosR_plot <- mean_SD_plots_with_reset(position_neurons, "Positive", "Positive", "Reset", 0, 200))
ggsave(file = "plots/PosPos_Reset_failed_PI_justposition.png", width = 4.5, height = 2.5)
```

Remake the function above to not take reset group as an input
```{r}
mean_SD_plots <- function(df, group_b, group_h, x_start = 30, x_end = 90){
 print(length(df))

 df <- df %>%
  filter(lm_group_b == group_b,
         lm_group_b_h == group_h) %>%
  select(avg_both_asr_b) %>%
  unnest(c(avg_both_asr_b))
 
 df$Rates <- as.double(df$Rates)

 df <- df %>%
   group_by(Position, Reward_indicator) %>%
   dplyr::summarise(mean_b = mean(Rates, na.rm = TRUE),
             se_b = std.error(Rates, na.rm = TRUE))
 
 ggplot(data=df) +
  annotate("rect", xmin=0, xmax=30, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=170, xmax=200, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=90, xmax=110, ymin=5,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
  geom_ribbon(aes(x=Position, y=mean_b, ymin = mean_b - se_b, ymax = mean_b + se_b,
                  fill=factor(Reward_indicator)), alpha=0.1) +
   geom_line(aes(y=mean_b, x=Position, color=factor(Reward_indicator)), alpha=0.5) +
   scale_fill_manual(values=c("black", "red", "blue")) +
   scale_color_manual(values=c("black", "red", "blue")) +
   theme_classic() +
   labs(y = "Mean firing rate (Hz)", x = "Position") +
   xlim(x_start, x_end) +
   theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        text = element_text(size=12))
}
```

6. Subset data by group then average rates for plotting          **Positive Unclassified**
```{r}
(PosUC_plot <- mean_SD_plots(position_neurons, "Positive", "Negative", 0, 200))
ggsave(file = "plots/PosNeg_failed_PI_justposition.png", width = 4.5, height = 2.5)
```
7. Subset data by group then average rates for plotting          **Positive Unclassified**
```{r}
(NegUC_plot <- mean_SD_plots(position_neurons, "Negative", "Positive", 0, 200))
ggsave(file = "plots/NegPos_failed_PI_justposition.png", width = 4.5, height = 2.5)
```

### -------------------------------------------------------------------------------- ###

Repeat above plots but for speed encoding neurons

1. Split data based on cue independant/cue dependant (Figure 5) and speed encoding group (Figure 3) as we are only interested in these neurons here
```{r}
speed_neurons <- filter(spatial_firing, cue_group_o == "Positive-PI" | cue_group_o == "Negative-PI", final_model_o_b == "S" | final_model_o_b == "SA" | final_model_o_b == "A" )
```

2. Subset data by group then average rates for plotting          **Negative Negative Continuous**
```{r}
(NegNegC_plot <- mean_SD_plots_with_reset(speed_neurons, "Negative", "Negative", "Continuous",  0, 200))
ggsave(file = "plots/NegNeg_Continuous_failed_PI_justspeed.png", width = 4.5, height = 2.5)
```
3. Subset data by group then average rates for plotting          **Negative Negative Reset**
```{r}
(NegNegR_plot <- mean_SD_plots_with_reset(speed_neurons, "Negative", "Negative", "Reset",  0, 200))
ggsave(file = "plots/NegNeg_Reset_failed_PI_justspeed.png", width = 4.5, height = 2.5)
```

4. Subset data by group then average rates for plotting          **Positive Positive Continuous**
```{r}
(PosPosC_plot <- mean_SD_plots_with_reset(speed_neurons, "Positive", "Positive", "Continuous", 0, 200))
ggsave(file = "plots/PosPos_Continuous_failed_PI_justspeed.png", width = 4.5, height = 2.5)
```

5. Subset data by group then average rates for plotting          **Positive Positive Reset**
```{r}
(PosPosR_plot <- mean_SD_plots_with_reset(speed_neurons, "Positive", "Positive", "Reset", 0, 200))
ggsave(file = "plots/PosPos_Reset_failed_PI_justspeed.png", width = 4.5, height = 2.5)
```

6. Subset data by group then average rates for plotting          **Positive Unclassified**
```{r}
(PosUC_plot <- mean_SD_plots(speed_neurons, "Positive", "Negative", 0, 200))
ggsave(file = "plots/PosNeg_failed_PI_justspeed.png", width = 4.5, height = 2.5)
```
7. Subset data by group then average rates for plotting          **Positive Unclassified**
```{r}
(NegUC_plot <- mean_SD_plots(speed_neurons, "Negative", "Positive", 0, 200))
ggsave(file = "plots/NegPos_failed_PI_justspeed.png", width = 4.5, height = 2.5)
```


### ------------------------------------------------------------------------------------ ###

## plot average speed vs location for groups of neurons (P, S etc)

1. Write function to add position to speed
```{r}
add_position <- function(hit, try, run) {
  df <- tibble(Speed = c(unlist(hit), unlist(try), unlist(run)), 
               Position = rep(1:200, times=3), 
               Indicator = c(rep("Hit", times=200), rep("Try", times=200), rep("Run", times=200))) 
  return(df)
}
```

2. Run on dataframe : Average across trial types

input columns: 
Speed_mean_rewarded = speed on rewarded beaconed trials
Speed_mean_try =  speed ontry beaconed trials
Speed_mean_runthru = speed on run through trials
```{r}
spatial_firing <- spatial_firing %>%
  mutate(Speed_avg = pmap(list(Speed_mean_rewarded, Speed_mean_try, Speed_mean_runthru), add_position))
```

Then average over selected neurons 

Function to plot data mean and SD of the population data based on the classification, as per Figure 2, on beaconed and non-beaconed trials.
```{r}
mean_speed_plots <- function(df, x_start = 30, x_end = 90){

 df <- df %>%
   select(Speed_avg) %>%
   unnest(c(Speed_avg))

 df <- df %>%
   group_by(Indicator, Position) %>%
   dplyr::summarise(mean_b = mean(Speed, na.rm = TRUE),
             se_b = std.error(Speed, na.rm = TRUE))
 ggplot(data=df) +
  annotate("rect", xmin=0, xmax=30, ymin=10,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=170, xmax=200, ymin=10,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=90, xmax=110, ymin=10,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
  geom_ribbon(aes(x=Position, 
                  y=mean_b, ymin = mean_b - se_b, ymax = mean_b + se_b, 
                  fill=as.factor(Indicator)), alpha=0.1) +
   geom_line(aes(y=mean_b, 
                 x=Position, 
                 color=as.factor(Indicator)), alpha=0.5, n= 100, span=0.2) +
   scale_fill_manual(values=c("black", "red", "blue")) +
   scale_color_manual(values=c("black", "red", "blue")) +
   theme_classic() +
   labs(y = "Mean speed (cm/s)", x = "Position") +
   xlim(x_start, x_end) +
   ylim(10,170) +
   theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        text = element_text(size=12))
 
}
```

3. Split data based on encoding group (Figure 3) as we are only interested in position neurons here
```{r}
position_neurons <- filter(spatial_firing, final_model_o_b == "P" | final_model_o_b == "S" | final_model_o_b == "A" | final_model_o_b == "SA")
```

4. Subset data by group then average rates for plotting          
```{r}
(Pos_speed_plot <- mean_speed_plots(position_neurons,  0, 200))
ggsave(file = "plots/PI_speed.png", width = 4.5, height = 2.5)
```
Function to extract all data. Filter for positions in the reward zone and calculate mean speed for each trial. Do this seperatly for hit, run and try neurons. 
```{r}
average_speed <- function(df) {
  df <-
    tibble(
      Speed = as.numeric(Re(df[[2]])/10),
      Position = as.integer(Re(df[[3]])),
    )

  df <- df %>%
    select(Speed, Position) %>%
    group_by(Position) %>%
    dplyr::summarise(mean_speed = mean(Speed, na.rm = TRUE),
                     se_speed = std.error(Speed, na.rm = TRUE)) 
  return(df)
}
```

1. Run on dataframe : Average across trial types

input columns: 
spikes_in_time_rewarded_b = speed, position and trial number for rewarded beaconed trials
spikes_in_time_try_b =  speed, position and trial number for try beaconed trials
Speed_hist_runthru_b = speed, position and trial number for run through trials
```{r}
spatial_firing <- spatial_firing %>%
  mutate(Speed_mean_rewarded = map(spikes_in_time_rewarded, average_speed),
         Speed_mean_try = map(spikes_in_time_try_b, average_speed),
         Speed_mean_run = map(spikes_in_time_runthru_b, average_speed))
```

```{r}
# The function to use at each step is `mean`.
# The window size is 5
rolling_mean <- rollify(mean, window = 6)

mean_speed_plots <- function(df, x_start = 30, x_end = 90){
  
  hit <- df %>%
    select(Speed_mean_rewarded) %>%
    unnest(Speed_mean_rewarded) %>%
    mutate(rolling_avg = rolling_mean(mean_speed))
  try <- df %>%
    select(Speed_mean_try) %>%
    unnest(Speed_mean_try) %>%
    mutate(rolling_avg = rolling_mean(mean_speed))
  run <- df %>%
    select(Speed_mean_run) %>%
    unnest(Speed_mean_run) %>%
    mutate(rolling_avg = rolling_mean(mean_speed))

  full_df <- tibble(Speed = c(hit$rolling_avg,try$rolling_avg, run$rolling_avg),
               Position = c(hit$Position,try$Position, run$Position),
               Indicator = c(rep("Hit", times=nrow(hit)),rep("Try", times=nrow(try)),rep("Run",times=nrow(run)))
    )

  full_df <- full_df %>%
    group_by(Position, Indicator) %>%
    dplyr::summarise(rolling_mean = mean(Speed, na.rm = TRUE),
                     se_b = std.error(Speed, na.rm = TRUE))
  
  ggplot(data=full_df) +
    annotate("rect", xmin=0, xmax=30, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
    annotate("rect", xmin=170, xmax=200, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
    annotate("rect", xmin=90, xmax=110, ymin=5,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
    geom_ribbon(aes(x=Position, 
                    y=rolling_mean, ymin = rolling_mean - se_b, ymax = rolling_mean + se_b, 
                    fill=as.factor(Indicator)), alpha=0.1) +
    geom_line(aes(y=rolling_mean, 
                  x=Position, 
                  color=as.factor(Indicator)), alpha=0.5, n= 100) +
    scale_fill_manual(values=c("black", "red", "blue")) +
    scale_color_manual(values=c("black", "red", "blue")) +
    theme_classic() +
    labs(y = "Mean speed (cm/s)", x = "Position") +
    xlim(x_start, x_end) +
    #ylim(5,104) +
    theme(axis.text.x = element_text(size=12),
          axis.text.y = element_text(size=12),
          legend.title = element_blank(),
          text = element_text(size=12))
  }
```

4. Subset data by group then average rates for plotting          
```{r}
(Pos_speed_plot <- mean_speed_plots(spatial_firing, 0, 200))
ggsave(file = "plots/PI_speed2.png", width = 4.5, height = 2.5)
```




### ------------------------------------------------------------------------------------ ###

## calculate a histogram of speed in the reward zone

Here we want to see the distribution of speed in the reward zone in the trial types (hit, run, try)

Function to extract all data. Filter for positions in the reward zone and calculate mean speed for each trial. Do this seperatly for hit, run and try neurons. 
```{r}
sum_speed_in_reward_zone <- function(df) {
  df <-
    tibble(
      Rates = as.numeric(Re(df[[1]])),
      Speed = as.numeric(Re(df[[2]])),
      Position = as.numeric(Re(df[[3]])),
      Trials = as.numeric(Re(df[[4]])),
      Types = as.factor(df[[5]])
    )

  df <- df %>%
    select(Speed, Trials, Position) %>%
    filter(Position >= 90, Position <= 110) %>%
    group_by(Trials) %>%
    dplyr::summarise(mean_speed = mean(Speed, na.rm = TRUE),
             se_speed = std.error(Speed, na.rm = TRUE)) 
  #print(df)

  return(df)
}
```

1. Run on dataframe : Average across trial types

input columns: 
spikes_in_time_rewarded_b = speed, position and trial number for rewarded beaconed trials
spikes_in_time_try_b =  speed, position and trial number for try beaconed trials
Speed_hist_runthru_b = speed, position and trial number for run through trials
```{r}
spatial_firing <- spatial_firing %>%
  mutate(Speed_hist_rewarded = map(spikes_in_time_rewarded, sum_speed_in_reward_zone),
         Speed_hist_try = map(spikes_in_time_try_b, sum_speed_in_reward_zone),
         Speed_hist_run = map(spikes_in_time_runthru_b, sum_speed_in_reward_zone))
```


Function to calculate and plot histogram. First takes input column, extracts the average reward zone speed for each trial, then plots for all sessions 
```{r}
histogram_plots <- function(df, name, color){
  
  df <- df %>%
    select(name) %>%
    unnest(name) %>%
    select(mean_speed)

  ggplot(data=df, aes(x = as.vector(mean_speed))) +
    coord_cartesian(xlim=c(0,100)) +
    geom_histogram(aes(y=..density..),binwidth = 2, alpha=0.5, fill=color) +
    labs(y="Density", x="") +
    theme_classic() +
    theme(axis.text.x = element_text(size=12),
          axis.text.y = element_text(size=12),
          text = element_text(size=12), 
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)))
}
```

3. extract only neurons that are driven by path integration (as determined by Figure 4 Analysis)
```{r}
position_neurons <- spatial_firing %>%
  filter(cue_group_o == "Positive-PI" | cue_group_o == "Negative-PI", 
         final_model_o_b == "P" | final_model_o_b == "PS" | final_model_o_b == "PA" | final_model_o_b == "PSA") 
```

4. Plot histogram for rewarded trials
```{r}
(hit_hist_plot <- histogram_plots(position_neurons, "Speed_hist_rewarded", "black"))
ggsave(file = "plots/Mean_rewardzone_speed_rewarded.png",width = 4, height = 2.5)
```
5. Plot histogram for try trials
```{r}
(try_hist_plot <- histogram_plots(position_neurons, "Speed_hist_run", "red"))
ggsave(file = "plots/Mean_rewardzone_speed_run.png",width = 4, height = 2.5)
```

6. Plot histogram for run trials
```{r}
(run_hist_plot <- histogram_plots(position_neurons, "Speed_hist_try", "blue"))
ggsave(file = "plots/Mean_rewardzone_speed_try.png",width = 4, height = 2.5)
```


