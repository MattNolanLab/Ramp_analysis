---
title: "Figure6_Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### ------------------------------------------------------------------------------------------ ### 


## Script aims to determine if ramp activity resets or is continuous across the reward zone in PROBE trials 


### ------------------------------------------------------------------------------------------ ### 

First, classify neurons based on their slope activity in the outbound and homebound region in probe trials (similar to beaconed trials in Figure5_Analysis.Rmd)


i.e. pospos = positive in outbound, positive in homebound
i.e. posneg = positive in outbound, negative in homebound

1. write function to mark cells based on cue_groups
```{r}
mark_track_catagory <- function(outbound, homebound){
  if( outbound == "Positive" & homebound =="Negative") {
    return( "posneg" ) 
  } else if( outbound == "Positive" & homebound =="Positive") {
    return( "pospos" )
  } else if( outbound == "Negative" & homebound =="Positive") {
    return( "negpos" )
  } else if( outbound == "Negative" & homebound =="Negative") {
    return( "negneg" )
  } else if( outbound == "Negative" & homebound =="Unclassified") {
    return( "negnon" )
  } else if( outbound == "Positive" & homebound =="Unclassified") {
    return( "posnon" )
  } else {
    return("None")
  }
}

```

2. run on all cells
```{r}
spatial_firing <- spatial_firing %>%
  mutate( whole_track_catagory_p = map2(lm_group_p, lm_group_p_h, mark_track_catagory))

```


### ------------------------------------------------------------------------------------------ ### 

Now, we want to find out if within pospos and negneg cue_groups - are their firing rate reset or continue across the reward region?

To do this, we will predict the firing rate on the homebound zone from the activity in the outbound. Then find the difference between the predicted and real data to determine if cells have reset or continued. 

First, normalise firing rates. 

1. make function to load rates and normalise
```{r}
normalise_rates <- function(df){
  df <- tibble(Rates = unlist(df), Position = rep(1:200))
  x <- scale(df$Rates, center=TRUE, scale=TRUE)
  return(x)
}

```

2. run on all cells
```{r}
spatial_firing <- spatial_firing %>%
  mutate(normalised_rates_p = map(Rates_averaged_rewarded_p, normalise_rates))
```

Then, predict firing rate in hombound region based on fit from real data in outbound region

Predict mean and confidence intervals for firing rate at the start of the homebound zone (track positions 110 to 115 cm) based on firing in the outbound zone (30 to 90 cm).

2. Run on all neurons
```{r}
spatial_firing <- spatial_firing %>%
  select(-contains('predict_params_p_')) %>%
  mutate(predict_params_p = map(normalised_rates_p, predict_homebound)) %>%
  unnest_wider(predict_params_p, names_sep = "_", names_repair = "universal")

spatial_firing <- spatial_firing %>%
  mutate(offset_p = pmap_chr(list(normalised_rates_p, predict_params_p_lwr, predict_params_p_upr), offset_test),
         predict_diff_p = map2_dbl(normalised_rates_p, predict_params_p_fit, calc_predict_diff))

```


Now, we can classify cells based on their predicted activity. 

1. Function to classify neurons based on offset (Matt code that does it based on prediction)

```{r}
mark_reset_group_predict <- function(df){
  if (is.na(df) ) {
    return( "None" )
  } else if( df == "None") {
    return( "Continuous" )
  } else if( ( df == "Neg" ||  df == "Pos")) {
    return( "Reset" ) 
  }
}

```

2. Run on all cells
```{r}
spatial_firing <- spatial_firing %>%
  mutate(reset_group_p = map(offset_p, mark_reset_group_predict))

```

4. Classify neurons based on apsolute difference between predicted and real as either "Continuous" or "Reset"
```{r}
mark_reset_group <- function(df, id){
  if (is.na(df) ) {
    return( "None" )
  } else if( id == "posneg" | id == "negpos") {
    return( "Switch" ) 
  } else if( (df > -1 & df < 1) & (id == "pospos" | id == "negneg")) {
    return( "Continuous" )
  } else if( (df <= -1 | df >= 1) & (id == "pospos" | id == "negneg")) {
    return( "Reset" ) 
    } else {
    return("None")
  }
}

spatial_firing <- spatial_firing %>%
  mutate(reset_group_p = map2(predict_diff_p, track_catagory_p, mark_reset_group))

```


## catagorised based on predict alone, ignoring slope?

Now, we can classify cells based on their predicted activity. 

1. Function to classify neurons based on predict mean _this is defined in Figure 5_

2. Run on all cells
```{r}
spatial_firing <- spatial_firing %>%
  mutate(reset_group_p = map(predict_diff_p, mark_reset_group))

```


then tag along with the slope _this is defined in Figure 5_

2. Run on all cells 
```{r}
spatial_firing <- spatial_firing %>%
  mutate(track_reset_group_p = pmap(list(lm_group_p, lm_group_p_h, reset_group_p), mark_track_catagory))

```

### ------------------------------------------------------------------------------------------ ### 

## plot bar chart of mean apsolute difference between predicted and real

- do only for neurons that have slopes in outbound zone
- do this for both negative and positive slopes in the outbound zone


1. extract neurons with slope on outbound
```{r}
data <- spatial_firing %>% filter(whole_track_catagory_p == "pospos" | whole_track_catagory_p == "negneg" | whole_track_catagory_p == "posneg"| whole_track_catagory_p == "negpos"| whole_track_catagory_p == "posnon"| whole_track_catagory_p == "negnon")
```

2. extract only neurons that are driven by path integration (as determined by CueAnalysis.0100.Rmd - i.e. Figure 4)
```{r}
pi_data <- subset(data, cue_group_o == "Positive-PI" | cue_group_o == "Negative-PI")
```

3. subset based on position
```{r}
pi_data <-subset(pi_data, final_model_o_b == "P" | final_model_o_b == "PS" | final_model_o_b == "PA" | final_model_o_b == "PSA")
```

4. Plot bar charts 
```{r}

ggplot(data=subset(pi_data,lm_group_p == "Negative"), aes(x = unlist(predict_diff_p), fill=as.factor(unlist(reset_group_p)))) +
  coord_cartesian(xlim=c(-5,5)) +
  geom_histogram(aes(y=..count..), alpha=0.5) +
  scale_fill_manual(values=c("grey","violetred2")) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 3)) +
  labs(y="Count", x="") +
  theme_classic() +
  theme(axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=13),
        legend.position="bottom", 
        legend.title = element_blank(),
        text = element_text(size=13), 
        legend.text=element_text(size=13), 
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) +
ggsave(file = "plots/PredictProbe_homebound_mean_PInegative_pi.png",width = 4, height = 2.5)


ggplot(data=subset(pi_data, lm_group_p == "Positive"), aes(x = unlist(predict_diff_p), fill=as.factor(unlist(reset_group_p)))) +
  coord_cartesian(xlim=c(-5,5)) +
  geom_histogram(aes(y=..count..), alpha=0.5) +
  scale_fill_manual(values=c("grey","chartreuse3")) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 3)) +
  labs(y="Count", x="") +
  theme_classic() +
  theme(axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=13),
        legend.position="bottom", 
        legend.title = element_blank(),
        text = element_text(size=13), 
        legend.text=element_text(size=13), 
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) +
ggsave(file = "plots/PredictProbe_homebound_mean_PIpositive_pi.png",width = 4, height = 2.5)

```

### ------------------------------------------------------------------------------------------ ### 


## plot outbound and homebound slopes for each neuron - seperated by whether they reset or are continuous 

1. Extract reset and continuous neurons
```{r}
reset <- pi_data %>% filter(reset_group_p == "Reset")
continuous <- pi_data %>% filter(reset_group_p == "Continuous")
```

2. Plot scatter of slopes on outbound&homebound
```{r}

ggplot() + 
    geom_jitter(data=continuous,aes(x = as.numeric(unlist(asr_p_o_rewarded_fit_slope)), y = as.numeric(unlist(asr_p_h_rewarded_fit_slope)), color=factor(unlist(lm_group_b)))) +
    geom_point(data=reset,aes(x = as.numeric(unlist(asr_p_o_rewarded_fit_slope)), y = as.numeric(unlist(asr_p_h_rewarded_fit_slope)), color=factor(unlist(lm_group_b))), shape=1) +
    coord_cartesian(ylim = c(-.7,.7), xlim = c(-.7,.7)) +
    geom_abline(intercept = 0, slope = 1, colour = "grey", linetype = "dashed") +
    geom_abline(intercept = 0, slope = -1, colour = "grey", linetype = "dashed") +
    xlab("Outbound slope") +
    ylab("Homebound slope") +
    theme_classic() +
    scale_color_manual(values=c("violetred2", "chartreuse3")) +
    theme(axis.text.x = element_text(size=17),
          axis.text.y = element_text(size=17),
          legend.position="bottom", 
          legend.title = element_blank(),
          text = element_text(size=16), 
          legend.text=element_text(size=16), 
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) 
ggsave(file = "plots/slope_comparison_probe_reset.png", width = 4, height = 4)

```



### -------------------------------------------------------------------------------------------------------------------------------------------------- ###


## Plot average firing rates for each cue_group of neuron

Now we want to plot population rate across whole track for diff groups so we can visualise the average firing rate

cue_groups are as follows :

outbound homebound  reset
    +       +         n
    +       +         y
    +       -         -
    +      non        -
    -       +         -
    -       -         n
    -       -         y
    -      non        -



1. Split data based on cue independant/cue dependant

```{r}
pi_data <- subset(spatial_firing, cue_group_o == "Positive-PI" | cue_group_o == "Negative-PI")
```

3. subset based on position
```{r}
pi_data <-subset(pi_data, final_model_o_b == "P" | final_model_o_b == "PS" | final_model_o_b == "PA" | final_model_o_b == "PSA")
```

# go into dataframe and from each average_rates column : just path integration neurons
```{r}
df <- tibble(Position = rep(1:200, times=nrow(pi_data)), 
             Rates = unlist(pi_data$Rates_averaged_rewarded_p), 
             Outbound_beaconed = rep(pi_data$lm_group_p, each=200), 
             Homebound_beaconed = rep(pi_data$lm_group_p_h, each=200), 
             reset_group = rep(as.character(pi_data$reset_group_p), each=200))

```


```{r}
df_neg_cue <- df %>%
  subset(Outbound_beaconed == "Negative" & Homebound_beaconed == "Negative") %>%
  subset(reset_group == "Continuous") %>%
  group_by(Position) %>%
  dplyr::summarise(mean_b = mean(Rates, na.rm = TRUE), sd_b = std.error(Rates, na.rm = TRUE)) %>%
  mutate(Position = rep(-30:169))
  
```

```{r}
ggplot(data=df_neg_cue) +
  coord_cartesian(ylim = c(5,30)) +
  annotate("rect", xmin=-30, xmax=0, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=140, xmax=170, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=60, xmax=80, ymin=5,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
  geom_ribbon(aes(x=Position, y=mean_b, ymin = mean_b - sd_b, ymax = mean_b + sd_b), fill = "grey70", alpha=0.5) +
  geom_line(aes(y=mean_b, x=Position), color = "black") +
  theme_classic() +
  labs(y = "Mean firing rate (Hz)", x = "Position") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/Negneg_continuous_mean_probe.png", width = 3.5, height = 2.5)

```





```{r}
df_neg_cue <- df %>%
  subset(Outbound_beaconed == "Negative" & Homebound_beaconed == "Negative") %>%
  subset(reset_group == "Reset") %>%
  group_by(Position) %>%
  dplyr::summarise(mean_b = mean(Rates, na.rm = TRUE), sd_b = std.error(Rates, na.rm = TRUE)) %>%
  mutate(Position = rep(-30:169))
  
```

```{r}
ggplot(data=df_neg_cue) +
  annotate("rect", xmin=-30, xmax=0, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=140, xmax=170, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=60, xmax=80, ymin=5,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
  geom_ribbon(aes(x=Position, y=mean_b, ymin = mean_b - sd_b, ymax = mean_b + sd_b), fill = "grey70", alpha=0.5) +
  geom_line(aes(y=mean_b, x=Position), color = "black") +
  theme_classic() +
  labs(y = "Mean firing rate (Hz)", x = "Position") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/Negneg_reset_mean_probe.png", width = 3.5, height = 2.5)

```


```{r}
df_pos_cue <- df %>%
  subset(Outbound_beaconed == "Negative" & Homebound_beaconed == "Positive") %>%
  group_by(Position) %>%
  dplyr::summarise(mean_b = mean(Rates, na.rm = TRUE), sd_b = std.error(Rates, na.rm = TRUE)) %>%
  mutate(Position = rep(-30:169))
  
```



```{r}
ggplot(data=df_pos_cue) +
  annotate("rect", xmin=-30, xmax=0, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=140, xmax=170, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=60, xmax=80, ymin=5,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
  geom_ribbon(aes(x=Position, y=mean_b, ymin = mean_b - sd_b, ymax = mean_b + sd_b), fill = "grey70", alpha=0.5) +
  geom_line(aes(y=mean_b, x=Position), color = "Black") +
  theme_classic() +
  labs(y = "Mean firing rate (Hz)", x = "Position") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/Negpos_mean_probe.png", width = 3.5, height = 2.5)

```



```{r}
df_pos_pi <- df %>%
  subset(Outbound_beaconed == "Positive" & Homebound_beaconed == "Positive") %>%
  subset(reset_group == "Continuous") %>%
  group_by(Position) %>%
  dplyr::summarise(mean_b = mean(Rates, na.rm = TRUE), sd_b = std.error(Rates, na.rm = TRUE)) %>%
  mutate(Position = rep(-30:169))
  
```



```{r}
ggplot(data=df_pos_pi) +
  annotate("rect", xmin=-30, xmax=0, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=140, xmax=170, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=60, xmax=80, ymin=5,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
  geom_ribbon(aes(x=Position, y=mean_b, ymin = mean_b - sd_b, ymax = mean_b + sd_b), fill = "grey70", alpha=0.5) +
  geom_line(aes(y=mean_b, x=Position), color = "black") +
  theme_classic() +
  labs(y = "Mean firing rate (Hz)", x = "Position") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/Pospos_continuous_mean_probe.png", width = 3.5, height = 2.5)


```


```{r}
df_pos_pi <- df %>%
  subset(Outbound_beaconed == "Positive" & Homebound_beaconed == "Positive") %>%
  subset(reset_group == "Reset") %>%
  group_by(Position) %>%
  dplyr::summarise(mean_b = mean(Rates, na.rm = TRUE), sd_b = std.error(Rates, na.rm = TRUE)) %>%
  mutate(Position = rep(-30:169))
  
```


```{r}
ggplot(data=df_pos_pi) +
  annotate("rect", xmin=-30, xmax=0, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=140, xmax=170, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=60, xmax=80, ymin=5,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
  geom_ribbon(aes(x=Position, y=mean_b, ymin = mean_b - sd_b, ymax = mean_b + sd_b), fill = "grey70", alpha=0.5) +
  geom_line(aes(y=mean_b, x=Position), color = "black") +
  theme_classic() +
  labs(y = "Mean firing rate (Hz)", x = "Position") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/Pospos_reset_mean_probe.png", width = 3.5, height = 2.5)


```


```{r}
df_pos_pi <- df %>%
  subset(Outbound_beaconed == "Positive" & Homebound_beaconed == "Negative") %>%
  group_by(Position) %>%
  dplyr::summarise(mean_b = mean(Rates, na.rm = TRUE), sd_b = std.error(Rates, na.rm = TRUE)) %>%
  mutate(Position = rep(-30:169))
  
```


```{r}
ggplot(data=df_pos_pi) +
  annotate("rect", xmin=-30, xmax=0, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=140, xmax=170, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=60, xmax=80, ymin=5,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
  geom_ribbon(aes(x=Position, y=mean_b, ymin = mean_b - sd_b, ymax = mean_b + sd_b), fill = "grey70", alpha=0.5) +
  geom_line(aes(y=mean_b, x=Position), color = "black") +
  theme_classic() +
  labs(y = "Mean firing rate (Hz)", x = "Position") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/Posneg_mean_probe.png", width = 3.5, height = 2.5)


```


```{r}
df_pos_pi <- df %>%
  subset(Outbound_beaconed == "Positive" & Homebound_beaconed == "Unclassified") %>%
  group_by(Position) %>%
  dplyr::summarise(mean_b = mean(Rates, na.rm = TRUE), sd_b = std.error(Rates, na.rm = TRUE)) %>%
  mutate(Position = rep(-30:169))
  
```


```{r}
ggplot(data=df_pos_pi) +
  annotate("rect", xmin=-30, xmax=0, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=140, xmax=170, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=60, xmax=80, ymin=5,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
  geom_ribbon(aes(x=Position, y=mean_b, ymin = mean_b - sd_b, ymax = mean_b + sd_b), fill = "grey70", alpha=0.5) +
  geom_line(aes(y=mean_b, x=Position), color = "black") +
  theme_classic() +
  labs(y = "Mean firing rate (Hz)", x = "Position") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/posnon_mean_probe.png", width = 3.5, height = 2.5)


```


```{r}
df_pos_pi <- df %>%
  subset(Outbound_beaconed == "Negative" & Homebound_beaconed == "Unclassified") %>%
  group_by(Position) %>%
  dplyr::summarise(mean_b = mean(Rates, na.rm = TRUE), sd_b = std.error(Rates, na.rm = TRUE)) %>%
  mutate(Position = rep(-30:169))
  
```


```{r}
ggplot(data=df_pos_pi) +
  annotate("rect", xmin=-30, xmax=0, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=140, xmax=170, ymin=5,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=60, xmax=80, ymin=5,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
  geom_ribbon(aes(x=Position, y=mean_b, ymin = mean_b - sd_b, ymax = mean_b + sd_b), fill = "grey70", alpha=0.5) +
  geom_line(aes(y=mean_b, x=Position), color = "black") +
  theme_classic() +
  labs(y = "Mean firing rate (Hz)", x = "Position") +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.title = element_blank(),
        text = element_text(size=12))
ggsave(file = "plots/negnon_mean_probe.png", width = 3.5, height = 2.5)


```


### ------------------------------------------------------------------------------------------------------------------- ###


### Plot Sankey Diagrams

##
```{r}
pi_data <- subset(spatial_firing, cue_group_o == "Positive-PI" | cue_group_o == "Negative-PI")
```

3. subset based on position
```{r}
pi_data <-subset(spatial_firing, final_model_o_b == "P" | final_model_o_b == "PS" | final_model_o_b == "PA" | final_model_o_b == "PSA")
```


```{r}
pospos_r <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Positive" & reset_group == "Reset")
pospos_c <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Positive" & reset_group == "Continuous")
posneg <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Negative")
negpos <-subset(pi_data, lm_group_b == "Negative" & lm_group_b_h == "Positive")
negneg_r <-subset(pi_data, lm_group_b == "Negative" & lm_group_b_h == "Negative" & reset_group == "Reset")
negneg_c <-subset(pi_data, lm_group_b == "Negative" & lm_group_b_h == "Negative" & reset_group == "Continuous")

```

```{r}

pospos_posneg <-nrow(subset(pospos_c, lm_group_nb == "Positive" & lm_group_nb_h == "Negative"))
pospos_negpos <-nrow(subset(pospos_c, lm_group_nb == "Negative" & lm_group_nb_h == "Positive"))
pospos_negnon <-nrow(subset(pospos_c, lm_group_nb == "Negative" & lm_group_nb_h == "Unclassified"))
pospos_posnon <-nrow(subset(pospos_c, lm_group_nb == "Positive" & lm_group_nb_h == "Unclassified"))
pospos_pospos <-nrow(subset(pospos_c, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Continuous"))
pospos_negneg <-nrow(subset(pospos_c, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Continuous"))
pospos_pospos_r <-nrow(subset(pospos_c, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Reset"))
pospos_negneg_r <-nrow(subset(pospos_c, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Reset"))

negpos_posneg <-nrow(subset(negpos, lm_group_nb == "Positive" & lm_group_nb_h == "Negative"))
negpos_negpos <-nrow(subset(negpos, lm_group_nb == "Negative" & lm_group_nb_h == "Positive"))
negpos_negnon <-nrow(subset(negpos, lm_group_nb == "Negative" & lm_group_nb_h == "Unclassified"))
negpos_posnon <-nrow(subset(negpos, lm_group_nb == "Positive" & lm_group_nb_h == "Unclassified"))
negpos_pospos <-nrow(subset(negpos, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Continuous"))
negpos_negneg <-nrow(subset(negpos, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Continuous"))
negpos_pospos_r <-nrow(subset(negpos, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Reset"))
negpos_negneg_r <-nrow(subset(negpos, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Reset"))

posneg_posneg <-nrow(subset(posneg, lm_group_nb == "Positive" & lm_group_nb_h == "Negative"))
posneg_negpos <-nrow(subset(posneg, lm_group_nb == "Negative" & lm_group_nb_h == "Positive"))
posneg_negnon <-nrow(subset(posneg, lm_group_nb == "Negative" & lm_group_nb_h == "Unclassified"))
posneg_posnon <-nrow(subset(posneg, lm_group_nb == "Positive" & lm_group_nb_h == "Unclassified"))
posneg_pospos <-nrow(subset(posneg, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Continuous"))
posneg_negneg <-nrow(subset(posneg, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Continuous"))
posneg_pospos_r <-nrow(subset(posneg, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Reset"))
posneg_negneg_r <-nrow(subset(posneg, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Reset"))

negneg_posneg <-nrow(subset(negneg_c, lm_group_nb == "Positive" & lm_group_nb_h == "Negative"))
negneg_negpos <-nrow(subset(negneg_c, lm_group_nb == "Negative" & lm_group_nb_h == "Positive"))
negneg_negnon <-nrow(subset(negneg_c, lm_group_nb == "Negative" & lm_group_nb_h == "Unclassified"))
negneg_posnon <-nrow(subset(negneg_c, lm_group_nb == "Positive" & lm_group_nb_h == "Unclassified"))
negneg_pospos <-nrow(subset(negneg_c, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Continuous"))
negneg_negneg <-nrow(subset(negneg_c, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Continuous"))
negneg_pospos_r <-nrow(subset(negneg_c, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Reset"))
negneg_negneg_r <-nrow(subset(negneg_c, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Reset"))

pospos_r_posneg <-nrow(subset(pospos_r, lm_group_nb == "Positive" & lm_group_nb_h == "Negative"))
pospos_r_negpos <-nrow(subset(pospos_r, lm_group_nb == "Negative" & lm_group_nb_h == "Positive"))
pospos_r_negnon <-nrow(subset(pospos_r, lm_group_nb == "Negative" & lm_group_nb_h == "Unclassified"))
pospos_r_posnon <-nrow(subset(pospos_r, lm_group_nb == "Positive" & lm_group_nb_h == "Unclassified"))
pospos_r_pospos <-nrow(subset(pospos_r, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Continuous"))
pospos_r_negneg <-nrow(subset(pospos_r, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Continuous"))
pospos_r_pospos_r <-nrow(subset(pospos_r, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Reset"))
pospos_r_negneg_r <-nrow(subset(pospos_r, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Reset"))

negneg_r_posneg <-nrow(subset(negneg_r, lm_group_nb == "Positive" & lm_group_nb_h == "Negative"))
negneg_r_negpos <-nrow(subset(negneg_r, lm_group_nb == "Negative" & lm_group_nb_h == "Positive"))
negneg_r_negnon <-nrow(subset(negneg_r, lm_group_nb == "Negative" & lm_group_nb_h == "Unclassified"))
negneg_r_posnon <-nrow(subset(negneg_r, lm_group_nb == "Positive" & lm_group_nb_h == "Unclassified"))
negneg_r_pospos <-nrow(subset(negneg_r, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Continuous"))
negneg_r_negneg <-nrow(subset(negneg_r, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Continuous"))
negneg_r_pospos_r <-nrow(subset(negneg_r, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Reset"))
negneg_r_negneg_r <-nrow(subset(negneg_r, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Reset"))

```



```{r}

data_long <- tibble(value=c(pospos_pospos, pospos_posneg, pospos_negpos,pospos_posnon, pospos_negnon, pospos_negneg, pospos_negneg_r, pospos_pospos_r,
                            
                            negpos_pospos, negpos_posneg, negpos_negpos, negpos_posnon, negpos_negnon, negpos_negneg, negpos_negneg_r, negpos_pospos_r,
                            
                            posneg_pospos, posneg_posneg, posneg_negpos, posneg_posnon, posneg_negnon, posneg_negneg, posneg_negneg_r, posneg_pospos_r,
                            
                            negneg_pospos, negneg_posneg, negneg_negpos, negneg_posnon, negneg_negnon, negneg_negneg, negneg_negneg_r, negneg_pospos_r,
                            
                            pospos_r_pospos, pospos_r_posneg, pospos_r_negpos, pospos_r_posnon, pospos_r_negnon, pospos_r_negneg, pospos_r_negneg_r, pospos_pospos_r,
                            
                            negneg_r_pospos, negneg_r_posneg, negneg_r_negpos, negneg_r_posnon, negneg_r_negnon, negneg_r_negneg, negneg_r_negneg_r,negneg_r_pospos_r),
                    
                      source= c("+ +","+ +", "+ +", "+ +", "+ +", "+ +", "+ +", "+ +",
                                "- +","- +", "- +", "- +", "- +", "- +", "- +", "- +",
                                "+ -","+ -", "+ -", "+ -",  "+ -", "+ -", "+ -", "+ -",
                                "- -","- -", "- -", "- -", "- -", "- -", "- -", "- -",
                                "+ + R","+ + R", "+ + R", "+ + R", "+ + R", "+ + R", "+ + R", "+ + R",
                                "- - R","- - R", "- - R", "- - R", "- - R", "- - R", "- - R", "- - R"),
                    
                     target= c(" + +"," + -"," - +"," + non"," - non"," - -", " - - R", " + + R",
                               " + +"," + -"," - +" ," + non"," - non", " - -", " - - R", " + + R",
                               " + +"," + -"," - +" ," + non"," - non", " - -", " - - R", " + + R",
                               " + +"," + -"," - +" ," + non"," - non", " - -", " - - R", " + + R",
                               " + +"," + -"," - +" ," + non"," - non"," - -", " - - R", " + + R",
                               " + +", " + -", " - +" ," + non"," - non", " - -", " - - R", " + + R" ))


data_long <- data_long %>% 
  filter(value > 0)                           
                    
```




```{r}
pospos <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Positive")
posneg <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Negative")
negpos <-subset(pi_data, lm_group_b == "Negative" & lm_group_b_h == "Positive")
negneg <-subset(pi_data, lm_group_b == "Negative" & lm_group_b_h == "Negative")
posnon <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Unclassified")
negnon <-subset(pi_data, lm_group_b == "Negative" & lm_group_b_h == "Unclassified")

```

```{r}
pospos_posneg <-nrow(subset(pospos, lm_group_nb == "Positive" & lm_group_nb_h == "Negative"))
pospos_negpos <-nrow(subset(pospos, lm_group_nb == "Negative" & lm_group_nb_h == "Positive"))
pospos_negnon <-nrow(subset(pospos, lm_group_nb == "Negative" & lm_group_nb_h == "Unclassified"))
pospos_posnon <-nrow(subset(pospos, lm_group_nb == "Positive" & lm_group_nb_h == "Unclassified"))
pospos_pospos <-nrow(subset(pospos, lm_group_nb == "Positive" & lm_group_nb_h == "Positive"))
pospos_negneg <-nrow(subset(pospos, lm_group_nb == "Negative" & lm_group_nb_h == "Negative"))

negpos_posneg <-nrow(subset(negpos, lm_group_nb == "Positive" & lm_group_nb_h == "Negative"))
negpos_negpos <-nrow(subset(negpos, lm_group_nb == "Negative" & lm_group_nb_h == "Positive"))
negpos_negnon <-nrow(subset(negpos, lm_group_nb == "Negative" & lm_group_nb_h == "Unclassified"))
negpos_posnon <-nrow(subset(negpos, lm_group_nb == "Positive" & lm_group_nb_h == "Unclassified"))
negpos_pospos <-nrow(subset(negpos, lm_group_nb == "Positive" & lm_group_nb_h == "Positive"))
negpos_negneg <-nrow(subset(negpos, lm_group_nb == "Negative" & lm_group_nb_h == "Negative"))

posneg_posneg <-nrow(subset(posneg, lm_group_nb == "Positive" & lm_group_nb_h == "Negative"))
posneg_negpos <-nrow(subset(posneg, lm_group_nb == "Negative" & lm_group_nb_h == "Positive"))
posneg_negnon <-nrow(subset(posneg, lm_group_nb == "Negative" & lm_group_nb_h == "Unclassified"))
posneg_posnon <-nrow(subset(posneg, lm_group_nb == "Positive" & lm_group_nb_h == "Unclassified"))
posneg_pospos <-nrow(subset(posneg, lm_group_nb == "Positive" & lm_group_nb_h == "Positive"))
posneg_negneg <-nrow(subset(posneg, lm_group_nb == "Negative" & lm_group_nb_h == "Negative"))

negneg_posneg <-nrow(subset(negneg, lm_group_nb == "Positive" & lm_group_nb_h == "Negative"))
negneg_negpos <-nrow(subset(negneg, lm_group_nb == "Negative" & lm_group_nb_h == "Positive"))
negneg_negnon <-nrow(subset(negneg, lm_group_nb == "Negative" & lm_group_nb_h == "Unclassified"))
negneg_posnon <-nrow(subset(negneg, lm_group_nb == "Positive" & lm_group_nb_h == "Unclassified"))
negneg_pospos <-nrow(subset(negneg, lm_group_nb == "Positive" & lm_group_nb_h == "Positive"))
negneg_negneg <-nrow(subset(negneg, lm_group_nb == "Negative" & lm_group_nb_h == "Negative"))

negnon_posneg <-nrow(subset(negnon, lm_group_nb == "Positive" & lm_group_nb_h == "Negative"))
negnon_negpos <-nrow(subset(negnon, lm_group_nb == "Negative" & lm_group_nb_h == "Positive"))
negnon_negnon <-nrow(subset(negnon, lm_group_nb == "Negative" & lm_group_nb_h == "Unclassified"))
negnon_posnon <-nrow(subset(negnon, lm_group_nb == "Positive" & lm_group_nb_h == "Unclassified"))
negnon_pospos <-nrow(subset(negnon, lm_group_nb == "Positive" & lm_group_nb_h == "Positive"))
negnon_negneg <-nrow(subset(negnon, lm_group_nb == "Negative" & lm_group_nb_h == "Negative"))

posnon_posneg <-nrow(subset(posnon, lm_group_nb == "Positive" & lm_group_nb_h == "Negative"))
posnon_negpos <-nrow(subset(posnon, lm_group_nb == "Negative" & lm_group_nb_h == "Positive"))
posnon_negnon <-nrow(subset(posnon, lm_group_nb == "Negative" & lm_group_nb_h == "Unclassified"))
posnon_posnon <-nrow(subset(posnon, lm_group_nb == "Positive" & lm_group_nb_h == "Unclassified"))
posnon_pospos <-nrow(subset(posnon, lm_group_nb == "Positive" & lm_group_nb_h == "Positive"))
posnon_negneg <-nrow(subset(posnon, lm_group_nb == "Negative" & lm_group_nb_h == "Negative"))

```

```{r}

data_long <- tibble(value=c(pospos_pospos, pospos_posneg, pospos_negpos,pospos_posnon, pospos_negnon, pospos_negneg,
                            
                            negpos_pospos, negpos_posneg, negpos_negpos, negpos_posnon, negpos_negnon, negpos_negneg,
                            
                            posneg_pospos, posneg_posneg, posneg_negpos, posneg_posnon, posneg_negnon, posneg_negneg,

                            posnon_pospos, posnon_posneg, posnon_negpos, posnon_posnon, posnon_negnon, posnon_negneg,

                            negnon_pospos, negnon_posneg, negnon_negpos, negnon_posnon, negnon_negnon, negnon_negneg,

                            negneg_pospos, negneg_posneg, negneg_negpos, negneg_posnon, negneg_negnon, negneg_negneg),
                    
                      source= c("+ +","+ +", "+ +", "+ +", "+ +", "+ +",
                                "- +","- +", "- +", "- +", "- +", "- +",
                                "+ -","+ -", "+ -", "+ -",  "+ -", "+ -",
                                "+ non","+ non", "+ non", "+ non",  "+ non", "+ non",
                                "- non","- non", "- non", "- non", "- non", "- non",
                                "- -","- -", "- -", "- -", "- -", "- -"),
                    
                     target= c(" + +"," + -"," - +"," + non"," - non"," - -",
                               " + +"," + -"," - +" ," + non"," - non", " - -",
                               " + +"," + -"," - +" ," + non"," - non", " - -",
                               " + +"," + -"," - +" ," + non"," - non", " - -",
                               " + +"," + -"," - +" ," + non"," - non", " - -",
                               " + +"," + -"," - +" ," + non"," - non", " - -"))


data_long <- data_long %>% 
  filter(value > 0)                           
                    
```

```{r}
# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(name=c(as.character(data_long$source), as.character(data_long$target)) %>% unique())
 
```

```{r}
# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
data_long$IDsource=match(data_long$source, nodes$name)-1 
data_long$IDtarget=match(data_long$target, nodes$name)-1
```

```{r}
# prepare colour scale
ColourScal ='d3.scaleOrdinal() .range(["#FDE725FF","#B4DE2CFF","#6DCD59FF","#35B779FF","#1F9E89FF","#26828EFF","#31688EFF","#3E4A89FF","#482878FF","#440154FF"])'

# Make the Network
sankeyNetwork(Links = data_long, Nodes = nodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name", LinkGroup='source',
              sinksRight=FALSE, colourScale=ColourScal,
              nodeWidth=40, fontSize=13, nodePadding=20)
#ggsave(file = "plots/model_movement.png", width = 24, height = 18)

```








```{r}
pospos_r <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Positive" & reset_group == "Reset")
pospos_c <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Positive" & reset_group == "Continuous")
negneg_r <-subset(pi_data, lm_group_b == "Negative" & lm_group_b_h == "Negative" & reset_group == "Reset")
negneg_c <-subset(pi_data, lm_group_b == "Negative" & lm_group_b_h == "Negative" & reset_group == "Continuous")

```

```{r}

pospos_pospos <-nrow(subset(pospos_c, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Continuous"))
pospos_negneg <-nrow(subset(pospos_c, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Continuous"))
pospos_pospos_r <-nrow(subset(pospos_c, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Reset"))
pospos_negneg_r <-nrow(subset(pospos_c, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Reset"))

negneg_pospos <-nrow(subset(negneg_c, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Continuous"))
negneg_negneg <-nrow(subset(negneg_c, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Continuous"))
negneg_pospos_r <-nrow(subset(negneg_c, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Reset"))
negneg_negneg_r <-nrow(subset(negneg_c, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Reset"))

pospos_r_pospos <-nrow(subset(pospos_r, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Continuous"))
pospos_r_negneg <-nrow(subset(pospos_r, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Continuous"))
pospos_r_pospos_r <-nrow(subset(pospos_r, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Reset"))
pospos_r_negneg_r <-nrow(subset(pospos_r, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Reset"))

negneg_r_pospos <-nrow(subset(negneg_r, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Continuous"))
negneg_r_negneg <-nrow(subset(negneg_r, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Continuous"))
negneg_r_pospos_r <-nrow(subset(negneg_r, lm_group_nb == "Positive" & lm_group_nb_h == "Positive" & reset_group_nb == "Reset"))
negneg_r_negneg_r <-nrow(subset(negneg_r, lm_group_nb == "Negative" & lm_group_nb_h == "Negative" & reset_group_nb == "Reset"))

```



```{r}

data_long <- tibble(value=c(pospos_pospos, pospos_negneg, pospos_negneg_r, pospos_pospos_r,
                            
                            negneg_pospos, negneg_negneg, negneg_negneg_r, negneg_pospos_r,
                            
                            pospos_r_pospos, pospos_r_negneg, pospos_r_negneg_r, pospos_pospos_r,
                            
                            negneg_r_pospos, negneg_r_negneg, negneg_r_negneg_r,negneg_r_pospos_r),
                    
                      source= c("+ +", "+ +", "+ +", "+ +",
                                "- -", "- -", "- -", "- -",
                                "+ + R", "+ + R", "+ + R", "+ + R",
                                "- - R", "- - R", "- - R", "- - R"),
                    
                     target= c(" + +"," - -", " - - R", " + + R",
                               " + +", " - -", " - - R", " + + R",
                               " + +"," - -", " - - R", " + + R",
                               " + +", " - -", " - - R", " + + R" ))


data_long <- data_long %>% 
  filter(value > 0)                           
                    
```

```{r}
# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(name=c(as.character(data_long$source), as.character(data_long$target)) %>% unique())
 
```

```{r}
# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
data_long$IDsource=match(data_long$source, nodes$name)-1 
data_long$IDtarget=match(data_long$target, nodes$name)-1
```

```{r}
# prepare colour scale
ColourScal ='d3.scaleOrdinal() .range(["#FDE725FF","#B4DE2CFF","#6DCD59FF","#35B779FF","#1F9E89FF","#26828EFF","#31688EFF","#3E4A89FF","#482878FF","#440154FF"])'

# Make the Network
sankeyNetwork(Links = data_long, Nodes = nodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name", LinkGroup='source',
              sinksRight=FALSE, colourScale=ColourScal,
              nodeWidth=40, fontSize=13, nodePadding=20)
#ggsave(file = "plots/model_movement.png", width = 24, height = 18)

```