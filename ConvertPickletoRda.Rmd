---
title: "ConvertPickletoRda"
author: "Sarah Tennant"
date: "28/01/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### ----------------------------------------------------------------------------------------------- ###

## This code loads dataframes with spatial firing of neurons in the virtual reality

Aim:We want to load dataframes from python output which are in pickled format, and save them in Rs dataframe format (.Rda). 

### ----------------------------------------------------------------------------------------------- ###


First we need to set up the python environment. This is so we can call a python script from R that loads the pickled dataframes and sends it back to the R workspace. 
The python environment needs to be >v.3 as 2.7 (system python) doesnt have Pandas package which is needed to open dataframes

```{r}

require(reticulate) # package that allows R to call python code
Sys.setenv(RETICULATE_PYTHON = "/usr/local/bin/python/bin/python") 

```


### ----------------------------------------------------------------------------------------------- ###

### LOAD ALL MICE ALL DAYS DATAFRAMES

### ----------------------------------------------------------------------------------------------- ###

## Loading dataframe for all mice and days (all curated cells from one animal/multiple animals)

1. load python code to load pickle dataframe
```{r}
source_python("pickle_reader.py") # run python script which loads the dataframes - should be in working directory

```

2. Load frame for each cohort
```{r}
dataframe_to_load <- "data/Alldays_cohort_1.pkl" # name of the pickled dataframe want to load 
spatial_firing1 <- read_pickle_file(file.path(dataframe_to_load)) # function to call in the python code

dataframe_to_load <- "data/Alldays_cohort_2.pkl" 
source_python("pickle_reader.py") 
spatial_firing2 <- read_pickle_file(file.path(dataframe_to_load)) 

dataframe_to_load <- "data/Alldays_cohort_3.pkl"  
source_python("pickle_reader.py") 
spatial_firing3 <- read_pickle_file(file.path(dataframe_to_load)) 

dataframe_to_load <- "data/Alldays_cohort_4.pkl" 
source_python("pickle_reader.py") 
spatial_firing4 <- read_pickle_file(file.path(dataframe_to_load)) 

```

3. Concatinate cohorts together
```{r}
spatial_firing <- rbind(spatial_firing1, spatial_firing2, spatial_firing3, spatial_firing4)
```

4. Save concatinated dataframes
```{r}
saveRDS(spatial_firing, file="PythonOutput_Concat.Rda")

```


## Loading specific column for all mice and days
```{r}
dataframe_to_load <- "data/Alldays_cohort_1_speed.pkl" # name of the pickled dataframe want to load 
spatial_firing1 <- read_pickle_file(file.path(dataframe_to_load)) # function to call in the python code
spatial_firing1 <- select(spatial_firing1,c('speed_CI_rewarded', 'speed_CI_try', 'speed_CI_run'))

dataframe_to_load <- "data/Alldays_cohort_2_speed.pkl" 
source_python("pickle_reader.py") 
spatial_firing2 <- read_pickle_file(file.path(dataframe_to_load)) 
spatial_firing2 <- select(spatial_firing2,c('speed_CI_rewarded', 'speed_CI_try', 'speed_CI_run'))

dataframe_to_load <- "data/Alldays_cohort_3_speed.pkl"  
source_python("pickle_reader.py") 
spatial_firing3 <- read_pickle_file(file.path(dataframe_to_load)) 
spatial_firing3 <- select(spatial_firing3,c('speed_CI_rewarded', 'speed_CI_try', 'speed_CI_run'))

dataframe_to_load <- "data/Alldays_cohort_4_speed.pkl" 
source_python("pickle_reader.py") 
spatial_firing4 <- read_pickle_file(file.path(dataframe_to_load)) 
spatial_firing4 <- select(spatial_firing4,c('speed_CI_rewarded', 'speed_CI_try', 'speed_CI_run'))

```

1. Concatinate cohorts together
```{r}
spatial_firing_speed <- rbind(spatial_firing1, spatial_firing2, spatial_firing3, spatial_firing4)
```

2. Concatinate with main dataframe
```{r}
spatial_firing <- cbind(spatial_firing, spatial_firing_speed)

```


```{r}
spatial_firing <- spatial_firing %>%
  select(-contains(c('speed_CI_rewarded', 'speed_CI_try', 'speed_CI_run')))
  
  

```

