---
title: "RampCodes_Figure4"
author: "Sarah Tennant & Matt Nolan"
date: "20/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### ------------------------------------------------------------------------------------------ ### 


## Script aims to evaluate the dependence of firing rates on the reward zone cues and to evaluate properties of neurons with similar firing rate trajectories in the presence and absence of these cues.


### ------------------------------------------------------------------------------------------ ### 

First, classify neurons based on their slope activity in the outbound and homebound region in probe trials (similar to beaconed trials in Figure1_Analysis.Rmd)

i.e. pospos = positive in outbound, positive in homebound
i.e. posneg = positive in outbound, negative in homebound

.

```{r}
# Use function 'mark_track_category' previously used in Figure 1
spatial_firing <- spatial_firing %>%
  mutate(track_category_p = map2(lm_group_p, lm_group_p_h, mark_track_category))

# Find predicted rates after the reward zone based on rates before the reward zone
spatial_firing <- spatial_firing %>%
  mutate(normalised_rates_p = map(Rates_averaged_rewarded_p, normalise_rates))

spatial_firing <- spatial_firing %>%
  select(-contains('predict_params_p_')) %>%
  mutate(predict_params_p = map(normalised_rates_p, predict_homebound)) %>%
  unnest_wider(predict_params_p,
               names_sep = "_",
               names_repair = "universal")

spatial_firing <- spatial_firing %>%
  mutate(
    offset_p = pmap_chr(
      list(
        normalised_rates_p,
        predict_params_p_lwr,
        predict_params_p_upr
      ),
      offset_test
    ),
    predict_diff_p = map2_dbl(normalised_rates_p, predict_params_p_fit, calc_predict_diff)
  )

# Classify cells based on their predicted activity using function 'mark_reset_group_predict' defined in Figure 1.

spatial_firing <- spatial_firing %>%
  mutate(reset_group_p = map(offset_p, mark_reset_group_predict))

```


### ------------------------------------------------------------------------------------------ ### 

Does the firing rate slope before or after the reward zone differ between beaconed and probe trials?

Subset spatial firing to contain only cells that have probe trial data and where the number of trials in the session  is >= 60.
```{r}
sum_unlist <- function(df) {sum(unlist(df), na.rm=TRUE)}
spatial_firing_probe_only <-
  subset(spatial_firing, max_trial_number >= 60) %>%
  mutate(asr_p_sum = map_dbl(Rates_averaged_rewarded_p, sum_unlist)) %>%
  subset(asr_p_sum != 0) %>%
  filter(lm_group_b == "Positive" | lm_group_b == "Negative") 
```

We ask first for all neurons that on beaconed trials have are classified with positive or negative slopes on the track segment before the reward zone.


Plot scatter of slopes after the reward zone on beaconed & probe
```{r}
b_vs_p_o_slope_plot(spatial_firing_probe_only)

if (save_figures == 1) {
 ggsave(file = "plots/slope_comparison_outbound.png", width = 4, height = 4) 
}


b_vs_p_h_slope_plot(spatial_firing_probe_only)

if (save_figures == 1) {
 ggsave(file = "plots/slope_comparison_homebound.png", width = 4, height = 4) 
}
```


Calculate r2 and p value for liner correlation of the above data
```{r}
model <- lm(asr_b_o_rewarded_fit_slope ~ asr_p_o_rewarded_fit_slope, data = spatial_firing_probe_only)
summary(model)
# get the model parameters
params <- select(glance(model), r.squared, p.value)

model <- lm(asr_b_h_rewarded_fit_slope ~ asr_p_h_rewarded_fit_slope, data = spatial_firing_probe_only)
summary(model)
# get the model parameters
params <- select(glance(model), r.squared, p.value)

```



We ask the same question foucssing on positional neurons (P, PA, PS, PSA) that on beaconed trials have are classified with positive or negative slopes on the track segment before the reward zone.
```{r}
spatial_firing_probe_only %>%
  filter(final_model_o_b == "P" | final_model_o_b == "PS" | final_model_o_b == "PA" | final_model_o_b == "PSA") %>%
  b_vs_p_o_slope_plot()

if (save_figures == 1) {
 ggsave(file = "plots/slope_comparison_outbound.png", width = 4, height = 4) 
}


spatial_firing_probe_only %>%
  filter(final_model_o_b == "P" | final_model_o_b == "PS" | final_model_o_b == "PA" | final_model_o_b == "PSA") %>%
  b_vs_p_h_slope_plot()

if (save_figures == 1) {
 ggsave(file = "plots/slope_comparison_homebound.png", width = 4, height = 4) 
}
```



Calculate r2 and p value for liner correlation of the above data
```{r}
model <- lm(asr_b_o_rewarded_fit_slope ~ asr_p_o_rewarded_fit_slope, data = spatial_firing_probe_only %>%
  filter(final_model_o_b == "P" | final_model_o_b == "PS" | final_model_o_b == "PA" | final_model_o_b == "PSA") )
summary(model)
# get the model parameters
params <- select(glance(model), r.squared, p.value)

model <- lm(asr_b_h_rewarded_fit_slope ~ asr_p_h_rewarded_fit_slope, data = spatial_firing_probe_only %>%
  filter(final_model_o_b == "P" | final_model_o_b == "PS" | final_model_o_b == "PA" | final_model_o_b == "PSA") )
summary(model)
# get the model parameters
params <- select(glance(model), r.squared, p.value)
```



### -------------------------------------------------------------------------------------------------------------------------------------------------- ###


## Plot average firing rates for neurons with firing rate profile (e.g. ++, +-, etc) that doesn't change when the reward zone cues are removed.



```{r}
b <- spatial_firing_probe_only %>% plot_beaconed_vs_probe("Negative", "Negative", "Unclassified", "Unclassified")

if (save_figures == 1) {
  ggsave(file = "plots/Negneg_probe_JustB.png",width = 3.6, height = 2.9)
}


spatial_firing_high %>% plot_beaconed_vs_probe("Negative", "Negative", "Unclassified", "Negative")

if (save_figures == 1) {
  ggsave(file = "plots/Negneg_probe_outboundchange.png",width = 3.6, height = 2.9)
}


spatial_firing_high %>% plot_beaconed_vs_probe("Negative", "Negative", "Negative", "Unclassified")

if (save_figures == 1) {
  ggsave(file = "plots/Negneg_probe_homeboundchange.png",width = 3.6, height = 2.9)
}

# -/- on beaconed and probe trials
spatial_firing_high %>% plot_beaconed_vs_probe("Negative", "Negative", "Negative", "Negative")


if (save_figures == 1) {
  ggsave(file = "plots/Negneg_probe_BandP.png", width = 3.6, height = 2.9)
}
```




```{r}
# -/+ on probe trials
spatial_firing_high %>% plot_beaconed_vs_probe("Positive", "Negative", "Unclassified", "Unclassified")

if (save_figures == 1) {
  ggsave(file = "plots/PosNeg_probe_JustB.png", width = 3.6, height = 2.9)
}


spatial_firing_high %>% plot_beaconed_vs_probe("Positive", "Negative", "Unclassified", "Negative")

if (save_figures == 1) {
  ggsave(file = "plots/PosNeg_probe_outboundchange.png", width = 3.6, height = 2.9)
}


spatial_firing_high %>% plot_beaconed_vs_probe("Positive", "Negative", "Positive", "Unclassified")

if (save_figures == 1) {
  ggsave(file = "plots/PosNeg_probe_homeboundchange.png", width = 3.6, height = 2.9)
}


# -/+ on beaconed and probe trials
spatial_firing_high %>% plot_beaconed_vs_probe("Positive", "Negative", "Positive", "Negative")


if (save_figures == 1) {
  ggsave(file = "plots/PosNeg_probe_BandP.png",  width = 3.6, height = 2.9)
}

```





```{r}
# +/+ on probe trials
spatial_firing_high %>% plot_beaconed_vs_probe("Positive", "Positive", "Unclassified", "Unclassified")

if (save_figures == 1) {
  ggsave(file = "plots/Pospos_probe_JustB.png", width = 3.6, height = 2.9) 
}


spatial_firing_high %>% plot_beaconed_vs_probe("Positive", "Positive", "Unclassified", "Positive")

if (save_figures == 1) {
  ggsave(file = "plots/Pospos_probe_outboundchange.png", width = 3.6, height = 2.9) 
}


spatial_firing_high %>% plot_beaconed_vs_probe("Positive", "Positive", "Positive", "Unclassified")

if (save_figures == 1) {
  ggsave(file = "plots/Pospos_probe_homeboundchange.png", width = 3.6, height = 2.9) 
}

#+/+ on beaconed and probe trials
spatial_firing_high %>% plot_beaconed_vs_probe("Positive", "Positive", "Positive", "Positive")

if (save_figures == 1) {
  ggsave(file = "plots/Pospos_probe_BandP.png",  width = 3.6, height = 2.9) 
}

```



```{r}
# +/- on probe trials
spatial_firing_high %>% plot_beaconed_vs_probe("Negative", "Positive", "Unclassified", "Unclassified")

if (save_figures == 1) {
  ggsave(file = "plots/NegPos_probe_JustP.png", width = 3.6, height = 2.9)
}


spatial_firing_high %>% plot_beaconed_vs_probe("Negative", "Positive", "Unclassified", "Positive")

if (save_figures == 1) {
  ggsave(file = "plots/NegPos_probe_outboundchange.png", width = 3.6, height = 2.9)
}



spatial_firing_high %>% plot_beaconed_vs_probe("Negative", "Positive", "Negative", "Unclassified")

if (save_figures == 1) {
  ggsave(file = "plots/NegPos_probe_homeboundchange.png", width = 3.6, height = 2.9)
}


# +/- on beaconed and probe trials
spatial_firing_high %>% plot_beaconed_vs_probe("Negative", "Positive", "Negative", "Positive")

if (save_figures == 1) {
  ggsave(file = "plots/NegPos_probe_BandP.png",  width = 3.6, height = 2.9)
}
```


```{r}
# +/UC on probe trials
spatial_firing_high %>% plot_beaconed_vs_probe("Positive", "Unclassified", "Positive", "Unclassified")

if (save_figures == 1) {
  ggsave(file = "plots/posnon_probe_BandP.png",  width = 3.6, height = 2.9)
}

# +/UC on probe trials
spatial_firing_high %>% plot_beaconed_vs_probe("Positive", "Unclassified", "Unclassified", "Unclassified")

if (save_figures == 1) {
  ggsave(file = "plots/posnon_probe_JustB.png",  width = 3.6, height = 2.9)
}
```



```{r}
# -/UC on probe trials
spatial_firing_high %>% plot_beaconed_vs_probe("Positive", "Negative", "Negative", "Unclassified")

if (save_figures == 1) {
  ggsave(file = "plots/negnon_probe_JustP.png",  width = 3.6, height = 2.9)
}
```


This should now be in Figure 5. Check Figure 5 and then delete.
```{r}
# -/- on beaconed but not probe trials
spatial_firing_high  %>%
  filter(final_model_o_b == "P" | final_model_o_b == "PS" | final_model_o_b == "PA" | final_model_o_b == "PSA") %>%
  extract_cols_for_plot() %>%
  filter(Outbound_beaconed_b == "Positive" | Outbound_beaconed_b == "Negative") %>%
  filter(Outbound_beaconed_b == "Negative" & Homebound_beaconed_b == "Negative") %>%
  filter(Outbound_beaconed_p == "Negative" | Homebound_beaconed_p == "Unclassified") %>%
  group_by(Position) %>%
  dplyr::summarise(mean_r = mean(Rates, na.rm = TRUE),
                   sem_r = std.error(Rates, na.rm = TRUE),
                   mean_c = mean(Rates_c, na.rm = TRUE),
                   sem_c = std.error(Rates_c, na.rm = TRUE)) %>%
  mutate(Position = rep(-29:170)) %>%
  mean_SEM_plots_comp()

if (save_figures == 1) {
  ggsave(file = "plots/Negneg_probe_negUNonProbe.png",  width = 3.6, height = 2.9)
}

# -/- on beaconed but not probe trials
spatial_firing_high  %>%
  filter(final_model_o_b == "P" | final_model_o_b == "PS" | final_model_o_b == "PA" | final_model_o_b == "PSA") %>%
  extract_cols_for_plot() %>%
  filter(Outbound_beaconed_b == "Positive" | Outbound_beaconed_b == "Negative") %>%
  filter(Outbound_beaconed_b == "Positive" & Homebound_beaconed_b == "Positive") %>%
  filter(Outbound_beaconed_p == "Positive" | Homebound_beaconed_p == "Unclassified") %>%
  group_by(Position) %>%
  dplyr::summarise(mean_r = mean(Rates, na.rm = TRUE),
                   sem_r = std.error(Rates, na.rm = TRUE),
                   mean_c = mean(Rates_c, na.rm = TRUE),
                   sem_c = std.error(Rates_c, na.rm = TRUE)) %>%
  mutate(Position = rep(-29:170)) %>%
  mean_SEM_plots_comp()



if (save_figures == 1) {
  ggsave(file = "plots/Pospos_reset_probe_negUNonProbe.png",  width = 3.6, height = 2.9)
}

```


### ------------------------------------------------------------------------------------------------------------------- ###

We want to know about whether the slope classification of neurons on beaconed trials is maintained on probe trials.

We first ask this question for all neurons whose classification is independent of the reward zone cue.

1. Split by position neurons (Figure 2)
```{r}
position_cells <- subset(spatial_firing_high , final_model_o_b == "P" | final_model_o_b == "PS" | final_model_o_b == "PA" | final_model_o_b == "PSA")
```

2. Select cells that have slopes on both the beaconed and non-beaconed (Figure 1)
```{r}
pi_data <- subset(spatial_firing_high, lm_group_b == "Positive" | lm_group_b == "Negative")
```

The groups we want to consider are +/+(O), +/+(C), +/-, -/-(O), -/-(C) and -/+. In addition for probe trials there will be a group 'other' for activity that is no longer in one of these categories.

3. Split by linear model result (figure 1) in outbound and homebound region for beaconed trials
```{r}
pospos <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Positive")
posneg <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Negative")
negpos <-subset(pi_data, lm_group_b == "Negative" & lm_group_b_h == "Positive")
negneg <-subset(pi_data, lm_group_b == "Negative" & lm_group_b_h == "Negative")
posnon <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Unclassified")
negnon <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Unclassified")

#pospos <-subset(pi_data, track_category == "pospos")
#posneg <-subset(pi_data, track_category == "posneg")
#negpos <-subset(pi_data, track_category == "negpos")
#negneg <-subset(pi_data, track_category == "negneg")
#posnon <-subset(pi_data, track_category == "posnon")
#negnon <-subset(pi_data, track_category == "negnon")


```

# test
```{r}
x <- (nrow(pospos) + nrow(negneg) + nrow(posneg) + (nrow(negpos) +nrow(posnon) + nrow(negnon)))
```

3. Split by linear model result (figure 5) in outbound and homebound region for beaconed trials
```{r}
# Beaconed: pospos
# stays the same
pospos_pospos <-nrow(subset(pospos, lm_group_p == "Positive" & lm_group_p_h == "Positive"))

# homebound changes
pospos_posneg <-nrow(subset(pospos, lm_group_p == "Positive" & lm_group_p_h == "Negative"))
pospos_posnon <-nrow(subset(pospos, lm_group_p == "Positive" & lm_group_p_h == "Unclassified"))

# outbound changes
pospos_negpos <-nrow(subset(pospos, lm_group_p == "Negative" & lm_group_p_h == "Positive"))
pospos_negnon <-nrow(subset(pospos, lm_group_p == "Negative" & lm_group_p_h == "Unclassified"))
pospos_negneg <-nrow(subset(pospos, lm_group_p == "Negative" & lm_group_p_h == "Negative"))


# Beaconed: posneg
posneg_posneg <-nrow(subset(posneg, lm_group_p == "Positive" & lm_group_p_h == "Negative"))

posneg_posnon <-nrow(subset(posneg, lm_group_p == "Positive" & lm_group_p_h == "Unclassified"))
posneg_pospos <-nrow(subset(posneg, lm_group_p == "Positive" & lm_group_p_h == "Positive"))

posneg_negpos <-nrow(subset(posneg, lm_group_p == "Negative" & lm_group_p_h == "Positive"))
posneg_negnon <-nrow(subset(posneg, lm_group_p == "Negative" & lm_group_p_h == "Unclassified"))
posneg_negneg <-nrow(subset(posneg, lm_group_p == "Negative" & lm_group_p_h == "Negative"))


# Beaconed: negneg
# stays the same
negneg_negneg <-nrow(subset(negneg, lm_group_p == "Negative" & lm_group_p_h == "Negative"))

# homebound changes
negneg_negpos <-nrow(subset(negneg, lm_group_p == "Negative" & lm_group_p_h == "Positive"))
negneg_negnon <-nrow(subset(negneg, lm_group_p == "Negative" & lm_group_p_h == "Unclassified"))

# outbound changes
negneg_posneg <-nrow(subset(negneg, lm_group_p == "Positive" & lm_group_p_h == "Negative"))
negneg_posnon <-nrow(subset(negneg, lm_group_p == "Positive" & lm_group_p_h == "Unclassified"))
negneg_pospos <-nrow(subset(negneg, lm_group_p == "Positive" & lm_group_p_h == "Positive"))


# Beaconed: negpos
# stays the same
negpos_negpos <-nrow(subset(negpos, lm_group_p == "Negative" & lm_group_p_h == "Positive"))

# homebound changes
negpos_negnon <-nrow(subset(negpos, lm_group_p == "Negative" & lm_group_p_h == "Unclassified"))
negpos_negneg <-nrow(subset(negpos, lm_group_p == "Negative" & lm_group_p_h == "Negative"))

# Outbound changes
negpos_posneg <-nrow(subset(negpos, lm_group_p == "Positive" & lm_group_p_h == "Negative"))
negpos_posnon <-nrow(subset(negpos, lm_group_p == "Positive" & lm_group_p_h == "Unclassified"))
negpos_pospos <-nrow(subset(negpos, lm_group_p == "Positive" & lm_group_p_h == "Positive"))


# Beaconed: posnon
posnon_posneg <-nrow(subset(posnon, lm_group_p == "Positive" & lm_group_p_h == "Negative"))

posnon_posnon <-nrow(subset(posnon, lm_group_p == "Positive" & lm_group_p_h == "Unclassified"))
posnon_pospos <-nrow(subset(posnon, lm_group_p == "Positive" & lm_group_p_h == "Positive"))

posnon_negpos <-nrow(subset(posnon, lm_group_p == "Negative" & lm_group_p_h == "Positive"))
posnon_negnon <-nrow(subset(posnon, lm_group_p == "Negative" & lm_group_p_h == "Unclassified"))
posnon_negneg <-nrow(subset(posnon, lm_group_p == "Negative" & lm_group_p_h == "Negative"))

# Beaconed: negnon
# stays the same
negnon_negpos <-nrow(subset(negnon, lm_group_p == "Negative" & lm_group_p_h == "Positive"))

# homebound changes
negnon_negnon <-nrow(subset(negnon, lm_group_p == "Negative" & lm_group_p_h == "Unclassified"))
negnon_negneg <-nrow(subset(negnon, lm_group_p == "Negative" & lm_group_p_h == "Negative"))

# Outbound changes
negnon_posneg <-nrow(subset(negnon, lm_group_p == "Positive" & lm_group_p_h == "Negative"))
negnon_posnon <-nrow(subset(negnon, lm_group_p == "Positive" & lm_group_p_h == "Unclassified"))
negnon_pospos <-nrow(subset(negnon, lm_group_p == "Positive" & lm_group_p_h == "Positive"))

```



```{r}

data_long <-
  tibble(
    value = c(
    
      posneg_pospos,
      posneg_posneg,
      posneg_negpos,
      posneg_posnon,
      posneg_negnon,
      posneg_negneg,
      
      pospos_pospos,
      pospos_posneg,
      pospos_negpos,
      pospos_posnon,
      pospos_negnon,
      pospos_negneg,
      
      negpos_pospos,
      negpos_posneg,
      negpos_negpos,
      negpos_posnon,
      negpos_negnon,
      negpos_negneg,
      
      negneg_pospos,
      negneg_posneg,
      negneg_negpos,
      negneg_posnon,
      negneg_negnon,
      negneg_negneg
    ),
    
    source = c(
      "+ -",
      "+ -",
      "+ -",
      "+ -",
      "+ -",
      "+ -",
      "+ +",
      "+ +",
      "+ +",
      "+ +",
      "+ +",
      "+ +",
      "- +",
      "- +",
      "- +",
      "- +",
      "- +",
      "- +",
      "- -",
      "- -",
      "- -",
      "- -",
      "- -",
      "- -"
    ),
    
    target = c(
      " + +",
      " + -",
      " - +" ,
      " + non",
      " - non",
      " - -",
      " + +",
      " + -",
      " - +" ,
      " + non",
      " - non",
      " - -",
      " + +",
      " + -",
      " - +" ,
      " + non",
      " - non",
      " - -",
      " + +",
      " + -",
      " - +" ,
      " + non",
      " - non",
      " - -"
    )
  )


data_long <- data_long %>%
  filter(value > 0)                           
                    
```


```{r}
# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(name=c(as.character(data_long$source), as.character(data_long$target)) %>% unique())
 
```

```{r}
# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
data_long$IDsource=match(data_long$source, nodes$name)-1 
data_long$IDtarget=match(data_long$target, nodes$name)-1
```

```{r}
# prepare colour scale
ColourScal ='d3.scaleOrdinal() .range(["#66cd00","#EE3A8C", "#6DCD59FF","#35B779FF","#1F9E89FF","#26828EFF","#31688EFF","#3E4A89FF","#482878FF","#440154FF"])'

# Make the Network
sankeyNetwork(Links = data_long, Nodes = nodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name", LinkGroup='source',
              sinksRight=FALSE, colourScale=ColourScal,
              nodeWidth=40, fontSize=13, nodePadding=20)

if (save_figures == 1) {
  ggsave(file = "plots/model_movement.png", width = 24, height = 18)
}
```





### ------------------------------------------------------------------------------------------ ### 

## Calculate number of neurons that areset/switch/continuous across outbound and homebound

1. First, select cells that are position encoding (figure 2)
```{r}
pi_data <- subset(spatial_firing, final_model_o_b == "P" | final_model_o_b == "PS" | final_model_o_b == "PA" | final_model_o_b == "PSA")
```

3. For this group of neurons, find numbers of cells that fit different patterns of outbound/homebound slope
```{r}
pospos <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Positive")
posneg <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Negative")
negpos <-subset(pi_data, lm_group_b == "Negative" & lm_group_b_h == "Positive")
negneg <-subset(pi_data, lm_group_b == "Negative" & lm_group_b_h == "Negative")
posnon <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Unclassified")
negnon <-subset(pi_data, lm_group_b == "Negative" & lm_group_b_h == "Unclassified")
nonpos <-subset(pi_data, lm_group_b == "Unclassified" & lm_group_b_h == "Positive")
nonneg <-subset(pi_data, lm_group_b == "Unclassified" & lm_group_b_h == "Negative")

```

```{r}
total_cells <- (nrow(pospos) + nrow(negneg) + nrow(posneg) + nrow(negpos) + nrow(posnon) + nrow(negnon) + nrow(nonpos) + nrow(nonneg))
```

5. for +- and -+ groups as classified on beaconed trials, how many are the same on probe?
```{r}
posneg_same_probe <-subset(posneg, lm_group_p == "Positive" & lm_group_p_h == "Negative")
negpos_same_probe <-subset(negpos, lm_group_p == "Negative" & lm_group_p_h == "Positive")

negneg_same_probe <-subset(negneg, lm_group_p == "Negative" & lm_group_p_h == "Negative")
pospos_same_probe <-subset(pospos, lm_group_p == "Positive" & lm_group_p_h == "Positive")

posnon_same_probe <-subset(posnon, lm_group_p == "Positive" & lm_group_p_h == "Unclassified")
negnon_same_probe <-subset(negnon, lm_group_p == "Negative" & lm_group_p_h == "Unclassified")

nonpos_same_probe <-subset(nonpos, lm_group_p == "Unclassified" & lm_group_p_h == "Positive")
nonneg_same_probe <-subset(nonneg, lm_group_p == "Unclassified" & lm_group_p_h == "Negative")

```

```{r}
total_cells_same_on_probe <- (nrow(pospos_same_probe) + nrow(negneg_same_probe) +
                                nrow(posnon_same_probe) + nrow(negnon_same_probe) +
                                nrow(nonpos_same_probe) + nrow(nonneg_same_probe) +
                                nrow(posneg_same_probe) + nrow(negpos_same_probe))
```



### ------------------------------------------------------------------------------------------ ### 

## Plot coefficients for Figure 4I



_Plot coefficients for just position cells_


6a. Plot coefficients for cells classified in Figure 1 as having a positive slope and in Figure 2 as having significant fit coefficients for position only.

```{r}
# this cell requires data_coef made in Figure 2 Analysis Rmd
data_coef_pos_allp <- data_coef %>%
  subset(group == "P" | group == "PS" | group == "PSA" | group == "PA") %>%
  subset(lm_result == "Positive")

(pos_SA_coef_plot <- standard_plot(data_coef_pos_allp))
if (save_figures == 1) {
  ggsave(file = "plots/CoefficientValues_PositiveAllPositioncells.png", width = 3, height = 2.5)
}
```



6b. Plot coefficients for cells classified in Figure 1 as having a negative slope and in Figure 2 as having significant fit coefficients for position only.

```{r}
data_coef_neg_allp <- data_coef %>%
  subset(group == "P" | group == "PS" | group == "PSA" | group == "PA") %>%
  subset(lm_result == "Negative")

(neg_SA_coef_plot <- standard_plot(data_coef_neg_allp))
if (save_figures == 1) {
  ggsave(file = "plots/CoefficientValues_NegativeAllPositioncells.png", width = 3, height = 2.5)
}
```










### ------------------------------------------------------------------------------------------ ### 

## Calculate number of neurons that areset/switch/continuous across outbound and homebound


3. For this group of neurons, find numbers of cells that fit different patterns of outbound/homebound slope
```{r}
pospos <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Positive")
posneg <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Negative")
negpos <-subset(pi_data, lm_group_b == "Negative" & lm_group_b_h == "Positive")
negneg <-subset(pi_data, lm_group_b == "Negative" & lm_group_b_h == "Negative")
posnon <-subset(pi_data, lm_group_b == "Positive" & lm_group_b_h == "Unclassified")
negnon <-subset(pi_data, lm_group_b == "Negative" & lm_group_b_h == "Unclassified")
nonpos <-subset(pi_data, lm_group_b == "Unclassified" & lm_group_b_h == "Positive")
nonneg <-subset(pi_data, lm_group_b == "Unclassified" & lm_group_b_h == "Negative")

```

4. for +- and -+ groups as classified on beaconed trials, how many are the same on probe?
```{r}
posneg_same_probe <-subset(posneg, lm_group_p == "Positive" & lm_group_p_h == "Negative")
negpos_same_probe <-subset(negpos, lm_group_p == "Negative" & lm_group_p_h == "Positive")

negneg_same_probe <-subset(negneg, lm_group_p == "Negative" & lm_group_p_h == "Negative")
pospos_same_probe <-subset(pospos, lm_group_p == "Positive" & lm_group_p_h == "Positive")

posnon_same_probe <-subset(posnon, lm_group_p == "Positive" & lm_group_p_h == "Unclassified")
negnon_same_probe <-subset(negnon, lm_group_p == "Negative" & lm_group_p_h == "Unclassified")

nonpos_same_probe <-subset(nonpos, lm_group_p == "Unclassified" & lm_group_p_h == "Positive")
nonneg_same_probe <-subset(nonneg, lm_group_p == "Unclassified" & lm_group_p_h == "Negative")

all_same_data <- bind_rows(posneg_same_probe, negpos_same_probe, negneg_same_probe, pospos_same_probe, posnon_same_probe, negnon_same_probe, nonpos_same_probe, nonneg_same_probe)
```


```{r}
posneg_diff_probe <-subset(posneg, lm_group_p != "Positive" | lm_group_p_h != "Negative")
negpos_diff_probe <-subset(negpos, lm_group_p != "Negative" | lm_group_p_h != "Positive")

negneg_diff_probe <-subset(negneg, lm_group_p != "Negative" | lm_group_p_h != "Negative")
pospos_diff_probe <-subset(pospos, lm_group_p != "Positive" | lm_group_p_h != "Positive")

posnon_diff_probe <-subset(posnon, lm_group_p != "Positive" | lm_group_p_h != "Unclassified")
negnon_diff_probe <-subset(negnon, lm_group_p != "Negative" | lm_group_p_h != "Unclassified")

all_diff_data <-  bind_rows(posneg_diff_probe, negpos_diff_probe, negneg_diff_probe, pospos_diff_probe, posnon_diff_probe, negnon_diff_probe)


```

```{r}
col1 <- rep("same", times = nrow(all_same_data))
all_same_data <- cbind(all_same_data, col1)

col1 <- rep("diff", times = nrow(all_diff_data))
all_diff_data <- cbind(all_diff_data, col1)

```

```{r}
all_data <- bind_rows(all_same_data, all_diff_data)
```

```{r}
data <- all_data  %>%
  select(Mouse, cohort, session_id, col1) %>%
  dplyr::group_by(Mouse, cohort, col1, .drop=FALSE) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::mutate(proportion = round(n / sum(n)*100, 2)) 

data <- data  %>%
  select(Mouse, cohort, col1, n, proportion) %>%
  dplyr::group_by(col1, .drop=FALSE) %>%
  dplyr::summarise(mean = mean(proportion), sd = std.error(proportion))


```

```{r}
spatial_firing_save <- select(spatial_firing,c('session_id', 'cluster_id', 'Mouse', 'Day', 'Day_numeric',  'cohort', 'number_of_rewards', 'max_trial_number', 'spikes_in_time', 'Rates_averaged_rewarded_b', 'Rates_averaged_rewarded_nb', 'Rates_averaged_rewarded_p', 'lm_group_b', 'lm_group_nb', 'lm_group_p', 'final_model_o_b', 'lm_group_b_h', 'lm_group_nb_h', 'lm_group_p_h'))
```

```{r}
if (save_results == 1) {
  saveRDS(spatial_firing, "SpatialFiring_with_1000_shuffles.Rda")
}
```



```{r}
spatial_firing_save <- select(spatial_firing,c('session_id', 'cluster_id', 'Mouse', 'Day', 'Day_numeric',  'cohort', 'number_of_rewards', 'max_trial_number', 'spikes_in_time', 'Rates_averaged_rewarded_b', 'Rates_averaged_rewarded_nb', 'Rates_averaged_rewarded_p', 'lm_group_b', 'lm_group_nb', 'lm_group_p', 'final_model_o_b', 'lm_group_b_h', 'lm_group_nb_h', 'lm_group_p_h', 'asr_b_o_rewarded_fit_slope', 'asr_b_o_rewarded_fit_r.squared', 'asr_b_h_rewarded_fit_slope', 'asr_b_h_rewarded_fit_r.squared', 'asr_p_o_rewarded_fit_slope', 'asr_p_o_rewarded_fit_r.squared', 'asr_p_h_rewarded_fit_slope', 'asr_p_h_rewarded_fit_r.squared'))
```

## Save to csv file _this is for matching to plots from python_
```{r}
spatial_firing_save <- tibble(session_id = spatial_firing_save$session_id,
                              cluster_id = spatial_firing_save$cluster_id,
                              lm_group_b =  as.character(spatial_firing_save$lm_group_b),
                              lm_group_nb =  as.character(spatial_firing_save$lm_group_nb),
                              lm_group_p =  as.character(spatial_firing_save$lm_group_p),
                              final_model_o_b =  as.character(spatial_firing_save$final_model_o_b),
                              lm_group_b_h =  as.character(spatial_firing_save$lm_group_b_h),
                              lm_group_nb_h =  as.character(spatial_firing_save$lm_group_nb_h),
                              lm_group_p_h =  as.character(spatial_firing_save$lm_group_p_h),
                              r_squared_outbound_b =  spatial_firing_save$asr_b_o_rewarded_fit_r.squared,
                              slope_outbound_b =  spatial_firing_save$asr_b_o_rewarded_fit_slope,
                              r_squared_homebound_b =  spatial_firing_save$asr_b_h_rewarded_fit_r.squared,
                              slope_homebound_b =  spatial_firing_save$asr_b_h_rewarded_fit_slope,                                                    r_squared_outbound_p =  spatial_firing_save$asr_p_o_rewarded_fit_r.squared,
                              slope_outbound_p =  spatial_firing_save$asr_p_o_rewarded_fit_slope,
                              r_squared_homebound_p =  spatial_firing_save$asr_p_h_rewarded_fit_r.squared,
                              slope_homebound_p =  spatial_firing_save$asr_p_h_rewarded_fit_slope         )

if (save_results == 1) {
  write.table(spatial_firing_save, "data_out/AllMice_LinearModelResults.txt", quote=FALSE, sep="\t")
}
```





### ------------------------------------------------------------------------------------------ ### 




### Calculate average stop histogram for all mice, sessions and plot


1. Subset data by group         
```{r}

df <-  
  tibble(average_stops = unlist(spatial_firing$average_stops), 
            average_stops_p = unlist(spatial_firing$average_stops_p))


```

2. Average rates
```{r}
df <- df %>%
  mutate(Position = rep(-30:169, times = nrow(spatial_firing))) %>%
  group_by(Position) %>%
  dplyr::summarise(mean_r = mean(as.numeric(average_stops), na.rm =TRUE), sem_r = std.error(as.numeric(average_stops)), 
                   mean_nb = mean(as.numeric(average_stops_p), na.rm =TRUE), sem_nb = std.error(as.numeric(average_stops_p))) 

```

3. Plot
```{r}
ggplot(data=df) +
  annotate("rect", xmin=-30, xmax=0, ymin=0,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=140, xmax=170, ymin=0,ymax=Inf, alpha=0.2, fill="Grey60") +
  annotate("rect", xmin=60, xmax=80, ymin=0,ymax=Inf, alpha=0.2, fill="Chartreuse4") +
  geom_line(aes(y=mean_r, x=Position), color = "Black") +
  geom_line(aes(y=mean_nb, x=Position), color = "Blue") +
  scale_x_continuous(breaks=seq(-30,170,100), expand = c(0, 0)) +
  labs(y = "Stops (cm)", x = "Location (cm)") +
  theme_classic() +
  theme(axis.text.x = element_text(size=18),
      axis.text.y = element_text(size=18),
      legend.title = element_blank(),
      text = element_text(size=18),
      plot.margin = margin(21, 25, 5, 20))
if (save_figures == 1) {
  ggsave(file = "plots/stops_mean.png", width = 3.6, height = 2.9)
}
```


