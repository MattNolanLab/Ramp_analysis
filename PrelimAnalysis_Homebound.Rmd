---
title: "Untitled"
author: "Sarah Tennant"
date: "05/03/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### ----------------------------------------------------------------------------------------- ###


```{r}
source("Functions_Homebound_LMER.R")

```



# Remove NA's and clusters with no data on probe trials

1. Write function to sum rates
```{r}
sum_rates <- function(df){
  #if(all(is.na(as.numeric(df$Rates[110:170]))))
    #return(0)
  x = sum(as.numeric(df$Rates[110:170]), na.rm=TRUE)     
}
```

2. Run on dataframe 
```{r}

spatial_firing <- spatial_firing %>% 
  mutate(asr_b_reward_sum = map(asr_b_rewarded, sum_rates)) %>% 
  mutate(asr_p_reward_sum = map(asr_p_rewarded, sum_rates)) %>% 
  mutate(asr_nb_reward_sum = map(asr_nb_rewarded, sum_rates)) 
  #mutate(asr_fail_sum = map(asr_b_failed, sum_rates)) 

```

3. Remove NA's and clusters with no data on probe trials
```{r}
spatial_firing <- spatial_firing %>% 
  filter(asr_b_reward_sum > 0 & asr_nb_reward_sum > 0)

spatial_firing <- spatial_firing %>% 
  filter(asr_p_reward_sum > 0)
```

### ----------------------------------------------------------------------------------------- ###


# Identification of ramp cells in dataset

Next we want to perform LM on each cluster to analyse firing rate verses location.
- Make a new columns in dataframe for output of linear model
- Fit the model from average rates versus location for each cluster
- Then put the results into new columns of the dataframe

Do this for each trial type: beaconed, non-beaconed and probe:
Do the same as above but with the start of the track.


```{r}
lm_helper <- function(df, bins){
  df_mod <- lm(Rates ~ Position, data = df[bins,], na.action=na.exclude)
}
```



```{r}
#Next we want to perform LM on each cluster to analyse firing rate verses location.
#- Make a new columns in dataframe for output of linear model
#- Fit the model from average rates versus location for each cluster
#- Then put the results into new columns of the dataframe

lm_analysis <- function(df, spike_rate_col, startbin = 110, endbin = 170) {
  spike_rate_col <- enquo(spike_rate_col)
  out_name <- sym(paste0(quo_name(spike_rate_col)))
  sr_unnest_name <- sym(paste0(quo_name(spike_rate_col), "_unnest"))
  fit_name <- sym(paste0(quo_name(out_name), "_fit"))
  glance_name <- sym(paste0(quo_name(out_name), "_glance"))
  r2_name <- sym(paste0(quo_name(out_name), "_r2_h"))
  Pval_name <- sym(paste0(quo_name(out_name), "_Pval_h"))
  slope_name <- sym(paste0(quo_name(out_name), "_slope_h"))
  intercept_name <- sym(paste0(quo_name(out_name), "_intercept_h"))
  df <- df %>%
    mutate(!!fit_name := map(!!spike_rate_col, bins=c(startbin:endbin), lm_helper),
           !!glance_name := map(!!fit_name, glance),
           !!r2_name := map_dbl(!!glance_name, ~.$r.squared),
           !!Pval_name := map_dbl(!!glance_name, ~.$p.value),
           !!slope_name := map_dbl(!!fit_name, ~.$coefficients[2]),
           !!intercept_name := map_dbl(!!fit_name, ~.$coefficients[1]))
}
```

# Run on all cells

```{r}

spatial_firing <- spatial_firing %>%
  lm_analysis(asr_b_rewarded, 110, 170) %>%
  lm_analysis(asr_p_rewarded, 110, 170) %>%
  lm_analysis(asr_nb_rewarded, 110, 170)
  #lm_analysis(shuff_asr_nb, 110, 170) %>%
  #lm_analysis(shuff_asr_p, 110, 170)

```


### ----------------------------------------------------------------------------------------- ###

## Find limits of shuffled data

# Quantiles/percentiles
```{r}
slopes <- as.numeric(na.omit(spatial_firing$shuff_asr_b_slope_h))
r2 <- as.numeric(na.omit(spatial_firing$shuff_asr_b_r2_h))

min_slope_h <- quantile(slopes, c(.05, .95)) [[1]][1]
max_slope_h <- quantile(slopes, c(.05, .95)) [[2]][1]
max_r2_h <- quantile(r2, c(.025, .975)) [[2]][1]
```


### ----------------------------------------------------------------------------------------- ###

## Mark neurons by lm result

```{r}

spatial_firing <- spatial_firing %>%
  mutate(lm_result_h_b = pmap(list(asr_b_rewarded_Pval_h, asr_b_rewarded_r2_h, asr_b_rewarded_slope_h,max_r2_h, max_slope_h, min_slope_h), select_final_lm_result)) %>%
  mutate(lm_result_h_nb = pmap(list(asr_nb_rewarded_Pval_h, asr_nb_rewarded_r2_h, asr_nb_rewarded_slope_h,max_r2_h, max_slope_h, min_slope_h), select_final_lm_result)) %>%
  mutate(lm_result_h_p = pmap(list(asr_b_rewarded_Pval_h, asr_b_rewarded_r2_h, asr_b_rewarded_slope_h,max_r2_h, max_slope_h, min_slope_h), select_final_lm_result)) 

```


### ----------------------------------------------------------------------------------------- ###


### Subset according to shuffled data

## Subsetting dataset based on LM r-squared value

Now we want to continue analysis in cells that show a linear relationship between firing rate and position.
First, find the cells with r2 values > 0.25 : where the LM model fits the data well

```{r}

homebound_ramps <- spatial_firing %>%
  filter(lm_result_h_b != "None")

```



# PLOT LINEAR MODEL RESULTS FOR BEACONED TRIALS


## Distribution of firing rates accross population with > r2 values
## then we might want to see if there is any difference in firing rates in cells with r2 value > 2
- arrange data
- plot heatmap of firing rate against position 
- stack clusters and plot
- normalise with group_by cluster id
- stack and plot
- do this for start and end of track ramps


First, reorder the dataframe with ramps according to slope.
_For start ramps, steepest slope should be negative - thus will have the highest cluster id_

```{r}
homebound_ramps_data<-homebound_ramps[order(homebound_ramps$asr_b_rewarded_slope_h),]
start_ramp_number = nrow(homebound_ramps_data)
new_cluster_id = seq(from = 1, to = start_ramp_number, by = 1)
homebound_ramps_data <- cbind(homebound_ramps_data, new_cluster_id)
```


Then we want to look at the distribution of these firing proeprty variables in our ramp cell dataset. 
_to examine only ramp/distance cells we are looking only at neurons that had slope > 0.15 from using a GLM on firing rate and distance_

Prep data:
1. Filter dataset for slope to get only ramp cells
2. Create marker for whether is start or end of track firing cells
3. Concatenate frames so all ramps are in one frame

```{r}
end_ramps <- subset(homebound_ramps_data, lm_result_h_b == "Positive")
ramp_id=rep("end_ramps", times= nrow(end_ramps))
binary_ramp_id = rep(4, times= nrow(end_ramps))
end_ramps <- cbind(end_ramps, ramp_id, binary_ramp_id)

from_reward_ramps <- subset(homebound_ramps_data, lm_result_h_b == "Negative")
ramp_id=rep("start", times= nrow(from_reward_ramps))
binary_ramp_id = rep(1, times= nrow(from_reward_ramps))
from_reward_ramps <- cbind(from_reward_ramps, ramp_id, binary_ramp_id)

homebound_ramps_final <- bind_rows(end_ramps, from_reward_ramps)

```


Then, we want to take a look at the distribution of slopes and r squared values [for firing rates versus location] in our dataset.  as an iniplot LM results from firing rates taken from the start of the track (30 - 90 cm).
> Plot shuffled and real data

```{r}
return_b_shuffle_lm_results <- function(df){
  tibble(
    Trial_type = factor(c(rep(c("Real","Shuffled"), each =nrow(df)))),
    Slopes = c(df$asr_b_rewarded_slope_h, df$shuff_asr_b_slope_h), 
    r2 = c(df$asr_b_rewarded_r2_h, df$shuff_asr_b_r2_h), 
    pval = c(df$asr_b_rewarded_Pval_h, df$shuff_asr_b_Pval_h), 
    id = c(df$cluster_id, df$cluster_id))
}

lm_results <- return_b_shuffle_lm_results(na.omit(spatial_firing))

lm_results_ramps <- tibble(Ramp_type = c(as.character(end_ramps$ramp_id), as.character(from_reward_ramps$ramp_id)),
    Slopes = c(end_ramps$asr_b_rewarded_slope_h, from_reward_ramps$asr_b_rewarded_slope_h), 
    r2 = c(end_ramps$asr_b_rewarded_r2_h, from_reward_ramps$asr_b_rewarded_r2_h), 
    id = c(end_ramps$cluster_id, from_reward_ramps$cluster_id))


lm_plot_start <- ggplot(data=lm_results_ramps, aes(x = Slopes, y = r2, color=factor(Ramp_type))) + 
    coord_cartesian(xlim = c(-1,1), ylim = c(0,1)) +
    geom_point(alpha=.4) +
    geom_point(data=lm_results, aes(x = Slopes, y = r2, color=factor(Trial_type))) +
    geom_point(data=lm_results_ramps, aes(x = Slopes, y = r2, color=factor(Ramp_type)),alpha=.4) +
    xlab("\nslope") +
    ylab("R2") +
    theme_classic() +
    scale_color_manual(values=c("deepskyblue3", "grey82", "grey32","mediumpurple3")) +
    theme(axis.text.x = element_text(size=12),
          axis.text.y = element_text(size=12),
          legend.position="bottom", 
          legend.title = element_blank(),
          text = element_text(size=12), 
          legend.text=element_text(size=12), 
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) 

lm_plot_start <- lm_plot_start + geom_vline(xintercept = min_slope_h , linetype="dotted", 
                color = "blue", size=.6)
lm_plot_start <- lm_plot_start + geom_vline(xintercept = max_slope_h, linetype="dotted", 
                color = "blue", size=.6)
lm_plot_start <- lm_plot_start + geom_hline(yintercept = max_r2_h, linetype="dotted", 
                color = "red", size=.6)

ggsave(file = "plots/shuff_lm_homebound_rewarded.png", width = 4, height = 5)

```




# find proportions for above.
# end of track

```{r}

#spatial <-subset(spatial_firing, lm_result_h_b != "None")
reward <- nrow(subset(spatial_firing, lm_result_h_b == "Negative"))/nrow(spatial_firing)*100
end <- nrow(subset(spatial_firing, lm_result_h_b == "Positive"))/nrow(spatial_firing)*100
nonslope <- nrow(subset(spatial_firing, lm_result_h_b == "NoSlope" |  lm_result_h_b == "None"))/nrow(spatial_firing)*100

proportions_mixed_ramps <- tibble(perc=c(end, reward, nonslope), ramp_id= c("FromReward", "End", "Unclassified"),ramp_type = c("FromReward", "End", "Unclassified"))

#reward_num <- nrow(subset(spatial_firing, lm_result_h_b == "Negative"))
#end_num <- nrow(subset(spatial_firing, lm_result_h_b == "Positive"))

```

```{r}
ggplot(proportions_mixed_ramps, aes(x= ramp_type, y = perc, fill=factor(ramp_id))) +
  geom_bar(stat="identity",width = 0.9, alpha = .4) +
  labs(y = "Percent") +
  scale_fill_manual(values=c("deepskyblue3","mediumpurple3", "grey2")) +
  theme_classic() +
  theme(axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        legend.position="bottom", 
        legend.title = element_blank(),
        text = element_text(size=16), 
        legend.text=element_text(size=16), 
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) +

ggsave(file = "plots/LMEnd_cellproportions_reward.png", width = 3, height = 5.5)

```







### RUN model without interactions

2. Run on all cells 
```{r}

spatial_firing <- spatial_firing  %>%
  mutate(h_pos_b = map(spikes_in_time, car_pos_b)) %>%
  mutate(h_speed_b = map(spikes_in_time, car_speed_b)) %>%
  mutate(h_accel_b = map(spikes_in_time, car_accel_b)) %>%
  mutate(h_pos_nb = map(spikes_in_time, car_pos_nb)) %>%
  mutate(h_speed_nb = map(spikes_in_time, car_speed_nb)) %>%
  mutate(h_accel_nb = map(spikes_in_time, car_accel_nb)) %>%
  mutate(h_pos_p = map(spikes_in_time, car_pos_p)) %>%
  mutate(h_speed_p = map(spikes_in_time, car_speed_p)) %>%
  mutate(h_accel_p = map(spikes_in_time, car_accel_p))

```


4. Compare models and select best one

```{r}

model_comparison <- function(null_pos, null_speed, null_accel){
  pval <- 0.01
  if( is.na(null_pos) | is.na(null_accel) | is.na(null_speed)) {
    return( "None" )
  
  } else if( null_pos < pval & null_accel > pval & null_speed > pval) {
    return( "P" )
    
  } else if( null_pos > pval & null_accel > pval & null_speed < pval) {
    return( "S" ) 
    
  } else if( null_pos > pval & null_accel < pval & null_speed > pval) {
    return( "A" )
    
  } else if( null_pos < pval & null_accel > pval & null_speed < pval) {
    return("PS")
    
  } else if( null_pos < pval & null_accel < pval & null_speed > pval) {
    return( "PA" )
        
  } else if( null_pos > pval & null_accel < pval & null_speed < pval) {
    return("SA")

  } else if( null_pos < pval & null_accel < pval & null_speed < pval) {
    return("PSA")
    
  } else {
    return("None")
  }
}

spatial_firing <- spatial_firing %>%
    mutate(final_model_h_b  = pmap(list(h_pos_b, h_speed_b, h_accel_b), model_comparison)) %>%
    mutate(final_model_h_nb  = pmap(list(h_pos_nb, h_speed_nb, h_accel_nb), model_comparison)) %>%
    mutate(final_model_h_p  = pmap(list(h_pos_p, h_speed_p, h_accel_p), model_comparison))
             
```





```{r}
spatial_firing_save <- subset(spatial_firing, select = c("session_id", "cluster_id", "lm_result_o_rewarded", "lm_result_o_rewarded_nb","lm_result_o_rewarded_p", "lm_result_h_b", "lm_result_h_nb","lm_result_h_p"))

#"predict_mse", "predict_mse_p","predict_results", "predict_results_p"
spatial_firing_save <- tibble(session_id = spatial_firing_save$session_id, cluster_id = spatial_firing_save$cluster_id, lm_result_b_outbound =  as.character(spatial_firing_save$lm_result_o_rewarded), lm_result_b_homebound =  as.character(spatial_firing_save$lm_result_h_b), lm_result_nb_outbound =  as.character(spatial_firing_save$lm_result_o_rewarded_nb), lm_result_nb_homebound =  as.character(spatial_firing_save$lm_result_h_nb), lm_result_p_outbound =  as.character(spatial_firing_save$lm_result_o_rewarded_p), lm_result_p_homebound =  as.character(spatial_firing_save$lm_result_h_p))

write.table(spatial_firing_save, "all_results_linearmodel.txt", quote=FALSE, sep="\t")
```

```{r}


spatial_firing_save <- subset(spatial_firing, select = c("session_id", "cluster_id", "lm_result_o_b", "lm_result_h_b", "final_model_o_b", "final_model_h_b"))

#"predict_mse", "predict_mse_p","predict_results", "predict_results_p"
spatial_firing_save <- tibble(session_id = spatial_firing_save$session_id, cluster_id = spatial_firing_save$cluster_id, lm_result_outbound =  as.character(spatial_firing_save$lm_result_o_b), lm_result_homebound =  as.character(spatial_firing_save$lm_result_h_b), lmer_result_outbound =  as.character(spatial_firing_save$final_model_o_b), lmer_result_homebound =  as.character(spatial_firing_save$final_model_h_b))

write.table(spatial_firing_save, "all_results_linearmodel.txt", quote=FALSE, sep="\t")

```



```{r}

# extracting diff models 

pos <-subset(spatial_firing, lm_result_h_b == "Positive")
neg <-subset(spatial_firing, lm_result_h_b == "Negative")
none <-subset(spatial_firing, lm_result_h_b == "None")

```


```{r}

P_positive <- nrow(subset(pos, final_model_h_b == "P"))/nrow(pos)*100
P_negative <- nrow(subset(neg, final_model_h_b == "P"))/nrow(neg)*100
P_none <- nrow(subset(none,final_model_h_b == "P"))/nrow(none)*100

S_positive <- nrow(subset(pos,final_model_h_b == "S"))/nrow(pos)*100
S_negative <- nrow(subset(neg,final_model_h_b == "S"))/nrow(neg)*100
S_none <- nrow(subset(none,final_model_h_b == "S"))/nrow(none)*100

A_positive <- nrow(subset(pos,final_model_h_b == "A"))/nrow(pos)*100
A_negative <- nrow(subset(neg,final_model_h_b == "A"))/nrow(neg)*100
A_none <- nrow(subset(none,final_model_h_b == "A"))/nrow(none)*100

P_S_positive <- nrow(subset(pos,final_model_h_b == "PS"))/nrow(pos)*100
P_S_negative <- nrow(subset(neg,final_model_h_b == "PS"))/nrow(neg)*100
P_S_none <- nrow(subset(none,final_model_h_b == "PS"))/nrow(none)*100

P_A_positive <- nrow(subset(pos ,final_model_h_b == "PA"))/nrow(pos)*100
P_A_negative <- nrow(subset(neg ,final_model_h_b == "PA"))/nrow(neg)*100
P_A_none <- nrow(subset(none,final_model_h_b == "PA"))/nrow(none)*100

S_A_positive <- nrow(subset(pos ,final_model_h_b == "SA"))/nrow(pos)*100
S_A_negative <- nrow(subset(neg ,final_model_h_b == "SA"))/nrow(neg)*100
S_A_none <- nrow(subset(none,final_model_h_b == "SA"))/nrow(none)*100

P_S_A_positive <- nrow(subset(pos ,final_model_h_b == "PSA"))/nrow(pos)*100
P_S_A_negative <- nrow(subset(neg ,final_model_h_b == "PSA"))/nrow(neg)*100
P_S_A_none <- nrow(subset(none ,final_model_h_b == "PSA"))/nrow(none)*100

NONE_positive <- nrow(subset(pos ,final_model_h_b == "None"))/nrow(pos)*100
NONE_negative <- nrow(subset(neg ,final_model_h_b == "None"))/nrow(neg)*100
NONE_none <- nrow(subset(none ,final_model_h_b == "None"))/nrow(none)*100


mixed_ramps <- tibble(perc=c(P_positive,P_negative,P_none,S_positive, S_negative, S_none, A_positive,A_negative,A_none,  P_S_positive, P_S_negative,P_S_none, P_A_positive, P_A_negative, P_A_none, S_A_positive, S_A_negative, S_A_none,P_S_A_positive, P_S_A_negative, P_S_A_none, NONE_positive,NONE_negative, NONE_none), 
                      
                      ramp_id= c("P","P","P", 
                                 "S", "S", "S", 
                                 "A", "A", "A",
                                 "PS", "PS", "PS", 
                                 "PA", "PA", "PA", 
                                 "SA", "SA", "SA", 
                                 "PAS", "PAS","PAS",
                                 "None","None", "None"), 
                      ramp_type= c("Positive", "Negative", "No slope","Positive", "Negative", "No slope", "Positive", "Negative", "No slope","Positive", "Negative" ,"No slope","Positive", "Negative","No slope","Positive", "Negative","No slope", "Positive", "Negative", "No slope", "Positive", "Negative", "No slope" ))


```





7. Plot model results

```{r}
# plot data
level_order <- c("P", "S", "A", "PS", "PA", "SA", "PAS", "None")
ggplot(mixed_ramps, aes(x= factor(ramp_type), y = perc, fill=factor(ramp_id, level = level_order))) +
  geom_bar(stat="identity",width = 0.9, alpha = .7) +
  labs(y = "Percent of neurons identified using LM") +
  scale_fill_manual(values=c("deeppink1","indianred3", "steelblue3", "darkred", "orchid", "lightseagreen", "darkgreen", "grey32")) +

  #scale_fill_brewer(palette= "RdYlBu") +
  theme_classic() +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.position="bottom", 
        legend.title = element_blank(),
        text = element_text(size=12), 
        legend.text=element_text(size=12), 
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) +
ggsave(file = "plots/cell_proportions-lmmodel_homebound_beaconed.png", width = 4, height = 4.5)


```











```{r}

# extracting diff models 

pos <-subset(spatial_firing, lm_result_h_nb == "Positive")
neg <-subset(spatial_firing, lm_result_h_nb == "Negative")
none <-subset(spatial_firing, lm_result_h_nb == "None")

```


```{r}

P_positive <- nrow(subset(pos, final_model_h_nb == "P"))/nrow(pos)*100
P_negative <- nrow(subset(neg, final_model_h_nb == "P"))/nrow(neg)*100
P_none <- nrow(subset(none,final_model_h_nb == "P"))/nrow(none)*100

S_positive <- nrow(subset(pos,final_model_h_nb == "S"))/nrow(pos)*100
S_negative <- nrow(subset(neg,final_model_h_nb == "S"))/nrow(neg)*100
S_none <- nrow(subset(none,final_model_h_nb == "S"))/nrow(none)*100

A_positive <- nrow(subset(pos,final_model_h_nb == "A"))/nrow(pos)*100
A_negative <- nrow(subset(neg,final_model_h_nb == "A"))/nrow(neg)*100
A_none <- nrow(subset(none,final_model_h_nb == "A"))/nrow(none)*100

P_S_positive <- nrow(subset(pos,final_model_h_nb == "PS"))/nrow(pos)*100
P_S_negative <- nrow(subset(neg,final_model_h_nb == "PS"))/nrow(neg)*100
P_S_none <- nrow(subset(none,final_model_h_nb == "PS"))/nrow(none)*100

P_A_positive <- nrow(subset(pos ,final_model_h_nb == "PA"))/nrow(pos)*100
P_A_negative <- nrow(subset(neg ,final_model_h_nb == "PA"))/nrow(neg)*100
P_A_none <- nrow(subset(none,final_model_h_nb == "PA"))/nrow(none)*100

S_A_positive <- nrow(subset(pos ,final_model_h_nb == "SA"))/nrow(pos)*100
S_A_negative <- nrow(subset(neg ,final_model_h_nb == "SA"))/nrow(neg)*100
S_A_none <- nrow(subset(none,final_model_h_nb == "SA"))/nrow(none)*100

P_S_A_positive <- nrow(subset(pos ,final_model_h_nb == "PSA"))/nrow(pos)*100
P_S_A_negative <- nrow(subset(neg ,final_model_h_nb == "PSA"))/nrow(neg)*100
P_S_A_none <- nrow(subset(none ,final_model_h_nb == "PSA"))/nrow(none)*100

NONE_positive <- nrow(subset(pos ,final_model_h_nb == "None"))/nrow(pos)*100
NONE_negative <- nrow(subset(neg ,final_model_h_nb == "None"))/nrow(neg)*100
NONE_none <- nrow(subset(none ,final_model_h_nb == "None"))/nrow(none)*100



mixed_ramps <- tibble(perc=c(P_positive,P_negative,P_none,S_positive, S_negative, S_none, A_positive,A_negative,A_none,  P_S_positive, P_S_negative,P_S_none, P_A_positive, P_A_negative, P_A_none, S_A_positive, S_A_negative, S_A_none,P_S_A_positive, P_S_A_negative, P_S_A_none, NONE_positive,NONE_negative, NONE_none), 
                      
                      ramp_id= c("P","P","P", 
                                 "S", "S", "S", 
                                 "A", "A", "A",
                                 "PS", "PS", "PS", 
                                 "PA", "PA", "PA", 
                                 "SA", "SA", "SA", 
                                 "PAS", "PAS","PAS",
                                 "None","None", "None"), 
                      ramp_type= c("Positive", "Negative", "No slope","Positive", "Negative", "No slope", "Positive", "Negative", "No slope","Positive", "Negative" ,"No slope","Positive", "Negative","No slope","Positive", "Negative","No slope", "Positive", "Negative", "No slope", "Positive", "Negative", "No slope" ))


```





7. Plot model results

```{r}
# plot data
level_order <- c("P", "S", "A", "PS", "PA","SA", "PAS", "None")
ggplot(mixed_ramps, aes(x= factor(ramp_type), y = perc, fill=factor(ramp_id, level = level_order))) +
  geom_bar(stat="identity",width = 0.9, alpha = .7) +
  labs(y = "Percent of neurons identified using LM") +
  scale_fill_manual(values=c("deeppink1","indianred3", "steelblue3", "darkred", "orchid", "lightseagreen", "darkgreen", "grey32")) +

  #scale_fill_brewer(palette= "RdYlBu") +
  theme_classic() +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.position="bottom", 
        legend.title = element_blank(),
        text = element_text(size=12), 
        legend.text=element_text(size=12), 
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) +
ggsave(file = "plots/cell_proportions-lmmodel_homebound_nonbeaconed.png", width = 4, height = 4.5)

```







```{r}

# extracting diff models 

pos <-subset(spatial_firing_start, lm_result_h_p == "Positive")
neg <-subset(spatial_firing_start, lm_result_h_p == "Negative")
none <-subset(spatial_firing_start, lm_result_h_p == "None")

```


```{r}

P_positive <- nrow(subset(pos, final_model_h_p == "P"))/nrow(pos)*100
P_negative <- nrow(subset(neg, final_model_h_p == "P"))/nrow(neg)*100
P_none <- nrow(subset(none,final_model_h_p == "P"))/nrow(none)*100

S_positive <- nrow(subset(pos,final_model_h_p == "S"))/nrow(pos)*100
S_negative <- nrow(subset(neg,final_model_h_p == "S"))/nrow(neg)*100
S_none <- nrow(subset(none,final_model_h_p == "S"))/nrow(none)*100

A_positive <- nrow(subset(pos,final_model_h_p == "A"))/nrow(pos)*100
A_negative <- nrow(subset(neg,final_model_h_p == "A"))/nrow(neg)*100
A_none <- nrow(subset(none,final_model_h_p == "A"))/nrow(none)*100

P_S_positive <- nrow(subset(pos,final_model_h_p == "PS"))/nrow(pos)*100
P_S_negative <- nrow(subset(neg,final_model_h_p == "PS"))/nrow(neg)*100
P_S_none <- nrow(subset(none,final_model_h_p == "PS"))/nrow(none)*100

P_A_positive <- nrow(subset(pos ,final_model_h_p == "PA"))/nrow(pos)*100
P_A_negative <- nrow(subset(neg ,final_model_h_p == "PA"))/nrow(neg)*100
P_A_none <- nrow(subset(none,final_model_h_p == "PA"))/nrow(none)*100

S_A_positive <- nrow(subset(pos ,final_model_h_p == "SA"))/nrow(pos)*100
S_A_negative <- nrow(subset(neg ,final_model_h_p == "SA"))/nrow(neg)*100
S_A_none <- nrow(subset(none,final_model_h_p == "SA"))/nrow(none)*100

P_S_A_positive <- nrow(subset(pos ,final_model_h_p == "PSA"))/nrow(pos)*100
P_S_A_negative <- nrow(subset(neg ,final_model_h_p == "PSA"))/nrow(neg)*100
P_S_A_none <- nrow(subset(none ,final_model_h_p == "PSA"))/nrow(none)*100

NONE_positive <- nrow(subset(pos ,final_model_h_p == "None"))/nrow(pos)*100
NONE_negative <- nrow(subset(neg ,final_model_h_p == "None"))/nrow(neg)*100
NONE_none <- nrow(subset(none ,final_model_h_p == "None"))/nrow(none)*100



mixed_ramps <- tibble(perc=c(P_positive,P_negative,P_none,S_positive, S_negative, S_none, A_positive,A_negative,A_none,  P_S_positive, P_S_negative,P_S_none, P_A_positive, P_A_negative, P_A_none, S_A_positive, S_A_negative, S_A_none,P_S_A_positive, P_S_A_negative, P_S_A_none, NONE_positive,NONE_negative, NONE_none), 
                      
                      ramp_id= c("P","P","P", 
                                 "S", "S", "S", 
                                 "A", "A", "A",
                                 "PS", "PS", "PS", 
                                 "PA", "PA", "PA", 
                                 "SA", "SA", "SA", 
                                 "PAS", "PAS","PAS",
                                 "None","None", "None"), 
                      ramp_type= c("Positive", "Negative", "No slope","Positive", "Negative", "No slope", "Positive", "Negative", "No slope","Positive", "Negative" ,"No slope","Positive", "Negative","No slope","Positive", "Negative","No slope", "Positive", "Negative", "No slope", "Positive", "Negative", "No slope" ))

```





7. Plot model results

```{r}
# plot data
level_order <- c("P", "S", "A", "PS", "PA","SA", "PAS", "None")
ggplot(mixed_ramps, aes(x= factor(ramp_type), y = perc, fill=factor(ramp_id, level = level_order))) +
  geom_bar(stat="identity",width = 0.9, alpha = .7) +
  labs(y = "Percent of neurons identified using LM") +
  scale_fill_manual(values=c("deeppink1","indianred3", "steelblue3", "darkred", "orchid", "lightseagreen", "darkgreen", "grey32")) +

  #scale_fill_brewer(palette= "RdYlBu") +
  theme_classic() +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.position="bottom", 
        legend.title = element_blank(),
        text = element_text(size=12), 
        legend.text=element_text(size=12), 
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) +
ggsave(file = "plots/cell_proportions-lmmodel_homebound_probe.png", width = 4, height = 4.5)


```











### ----------------------------------------------------------------------------------------- ###

## Movement between group plots
## BEACONED TRIALS

##  lm to lmer model

```{r}
# positive homebound slopes
P <-subset(spatial_firing, final_model_o_b == "P")
S <-subset(spatial_firing, final_model_o_b == "S")
PS <-subset(spatial_firing, final_model_o_b == "PS")
PSA <-subset(spatial_firing, final_model_o_b == "PSA")
A <-subset(spatial_firing, final_model_o_b == "A")
PA <-subset(spatial_firing, final_model_o_b == "PA")
None <-subset(spatial_firing, final_model_o_b == "None")

```

```{r}

pos_s <-nrow(subset(P, final_model_h_b == "S"))
pos_p <-nrow(subset(P, final_model_h_b == "P"))
pos_pa <-nrow(subset(P, final_model_h_b == "PA"))
pos_ps <-nrow(subset(P, final_model_h_b == "PS"))
pos_pas <-nrow(subset(P, final_model_h_b == "PSA"))
pos_a <-nrow(subset(P, final_model_h_b == "A"))
pos_none <-nrow(subset(P, final_model_h_b == "None"))

speed_s <-nrow(subset(S, final_model_h_b == "S"))
speed_p <-nrow(subset(S, final_model_h_b == "P"))
speed_pa <-nrow(subset(S, final_model_h_b == "PA"))
speed_ps <-nrow(subset(S, final_model_h_b == "PS"))
speed_pas <-nrow(subset(S, final_model_h_b == "PSA"))
speed_a <-nrow(subset(S, final_model_h_b == "A"))
speed_none <-nrow(subset(S, final_model_h_b == "None"))

pos_speed_s <-nrow(subset(PS, final_model_h_b == "S"))
pos_speed_p <-nrow(subset(PS, final_model_h_b == "P"))
pos_speed_pa <-nrow(subset(PS, final_model_h_b == "PA"))
pos_speed_ps <-nrow(subset(PS, final_model_h_b == "PS"))
pos_speed_pas <-nrow(subset(PS, final_model_h_b == "PSA"))
pos_speed_a <-nrow(subset(PS, final_model_h_b == "A"))
pos_speed_none <-nrow(subset(PS, final_model_h_b == "None"))

pos_int_s <-nrow(subset(PA, final_model_h_b == "S"))
pos_int_p <-nrow(subset(PA, final_model_h_b == "P"))
pos_int_pa <-nrow(subset(PA, final_model_h_b == "PA"))
pos_int_ps <-nrow(subset(PA, final_model_h_b == "PS"))
pos_int_pas <-nrow(subset(PA, final_model_h_b == "PSA"))
pos_int_a <-nrow(subset(PA, final_model_h_b == "A"))
pos_int_none <-nrow(subset(PA, final_model_h_b == "None"))

pos_speed_int_s <-nrow(subset(PSA, final_model_h_b == "S"))
pos_speed_int_p <-nrow(subset(PSA, final_model_h_b == "P"))
pos_speed_int_pa <-nrow(subset(PSA, final_model_h_b == "PA"))
pos_speed_int_ps <-nrow(subset(PSA, final_model_h_b == "PS"))
pos_speed_int_pas <-nrow(subset(PSA, final_model_h_b == "PSA"))
pos_speed_int_a <-nrow(subset(PSA, final_model_h_b == "A"))
pos_speed_int_none <-nrow(subset(PSA, final_model_h_b == "None"))

int_s <-nrow(subset(A, final_model_h_b == "S"))
int_p <-nrow(subset(A, final_model_h_b == "P"))
int_pa <-nrow(subset(A, final_model_h_b == "PA"))
int_ps <-nrow(subset(A, final_model_h_b == "PS"))
int_pas <-nrow(subset(A, final_model_h_b == "PSA"))
int_a <-nrow(subset(A, final_model_h_b == "A"))
int_none <-nrow(subset(A, final_model_h_b == "None"))

none_s <-nrow(subset(None, final_model_h_b == "S"))
none_p <-nrow(subset(None, final_model_h_b == "P"))
none_pa <-nrow(subset(None, final_model_h_b == "PA"))
none_ps <-nrow(subset(None, final_model_h_b == "PS"))
none_pas <-nrow(subset(None, final_model_h_b == "PSA"))
none_a <-nrow(subset(None, final_model_h_b == "A"))
none_none <-nrow(subset(None, final_model_h_b == "None"))
```

```{r}

data_long <- tibble(value=c(pos_s,pos_p,pos_ps, pos_pa, pos_pas, pos_a, pos_none, speed_s,speed_p,speed_ps, speed_pa, speed_pas, speed_a, speed_none,pos_speed_s, pos_speed_p,pos_speed_ps, pos_speed_pa, pos_speed_pas, pos_speed_a, pos_speed_none,pos_speed_int_s, pos_speed_int_p,pos_speed_int_ps, pos_speed_int_pa, pos_speed_int_pas, pos_speed_int_a, pos_speed_int_none, pos_int_s, pos_int_p,pos_int_ps, pos_int_pa, pos_int_pas, pos_int_a, pos_int_none, int_s, int_p,int_ps, int_ps, int_pas, int_a, int_none, none_s, none_p,int_ps, none_pa, none_pas, none_a, none_none), 
                    
                      source= c("P","P", "P", "P", "P", "P", "P","S", "S", "S", "S", "S", "S", "S", "PS", "PS", "PS", "PS", "PS", "PS", "PS", "PS", "PSA", "PSA", "PSA", "PSA", "PSA", "PSA","PA", "PA", "PA", "PA", "PA", "PA", "PA","A", "A", "A", "A", "A", "A", "A","none", "none", "none", "none", "none", "none", "none"),
                     target= c(" S"," P", " PS", " PA", " PSA", " A", " None"," S"," P", " PS", " PA", " PSA", " A", " None", " S"," P", " PS", " PA", " PSA", " A", " None"," S"," P", " PS", " PA", " PSA", " A", " None", " S"," P", " PS", " PA", " PSA", " A", " None", " S"," P", " PS", " PA", " PSA", " A", " None"," S"," P", " PS", " PA", " PSA", " A", " None"))


data_long <- data_long %>% 
  filter(value > 0)                    
                    
```

```{r}
# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(name=c(as.character(data_long$source), as.character(data_long$target)) %>% unique())
 
```

```{r}
# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
data_long$IDsource=match(data_long$source, nodes$name)-1 
data_long$IDtarget=match(data_long$target, nodes$name)-1
```

```{r}
# prepare colour scale
ColourScal ='d3.scaleOrdinal() .range(["#FDE725FF","#B4DE2CFF","#6DCD59FF","#35B779FF","#1F9E89FF","#26828EFF","#31688EFF","#3E4A89FF","#482878FF","#440154FF"])'

# Make the Network
sankeyNetwork(Links = data_long, Nodes = nodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name", LinkGroup='source',
              sinksRight=FALSE, colourScale=ColourScal,
              nodeWidth=40, fontSize=13, nodePadding=20)
#ggsave(file = "plots/model_movement.png", width = 24, height = 18)

```


#### Movement between lm groups (positive/negative slopes)

```{r}
P <-subset(spatial_firing_start, final_model_o_b == "P" | final_model_h_b == "P")
A <-subset(spatial_firing_start, final_model_o_b == "A" | final_model_h_b == "A")

```

```{r}
# positive homebound slopes
pos <-subset(spatial_firing, lm_result_o_b == "Positive")
neg <-subset(spatial_firing, lm_result_o_b == "Negative")
None <-subset(spatial_firing, lm_result_o_b == "None")

```

```{r}
pos_pos <-nrow(subset(pos, lm_result_h_b == "Positive"))
pos_neg <-nrow(subset(pos, lm_result_h_b == "Negative"))
pos_none <-nrow(subset(pos, lm_result_h_b == "None"))

neg_pos <-nrow(subset(neg, lm_result_h_b == "Positive"))
neg_neg <-nrow(subset(neg, lm_result_h_b == "Negative"))
neg_none <-nrow(subset(neg, lm_result_h_b == "None"))

none_pos <-nrow(subset(None, lm_result_h_b == "Positive"))
none_neg <-nrow(subset(None, lm_result_h_b == "Negative"))
none_none <-nrow(subset(None, lm_result_h_b == "None"))
```


```{r}
data_long <- tibble(value=c(pos_pos, pos_neg, pos_none, neg_pos,neg_neg, neg_none, none_pos, none_neg, none_none), 
                    
                      source= c("Positive","Positive", "Positive", "Negative", "Negative", "Negative", "None","None", "None"),
                     target= c(" Positive"," Negative", " None"," Positive"," Negative", " None"," Positive"," Negative", " None"))


data_long <- data_long %>% 
  filter(value > 0)                    
                    
```

```{r}
# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(name=c(as.character(data_long$source), as.character(data_long$target)) %>% unique())
 
```

```{r}
# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
data_long$IDsource=match(data_long$source, nodes$name)-1 
data_long$IDtarget=match(data_long$target, nodes$name)-1
```

```{r}
# prepare colour scale
ColourScal ='d3.scaleOrdinal() .range(["#FDE725FF","#B4DE2CFF","#6DCD59FF","#35B779FF","#1F9E89FF","#26828EFF","#31688EFF","#3E4A89FF","#482878FF","#440154FF"])'

# Make the Network
sankeyNetwork(Links = data_long, Nodes = nodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name", LinkGroup='source',
              sinksRight=FALSE, colourScale=ColourScal,
              nodeWidth=40, fontSize=13, nodePadding=20)
#ggsave(file = "plots/model_movement.png", width = 24, height = 18)

```









### NON BEACONED TRIALS

##  lm to lmer model

```{r}
# positive homebound slopes
P <-subset(spatial_firing, final_model_o_nb == "P")
S <-subset(spatial_firing, final_model_o_nb == "S")
PS <-subset(spatial_firing, final_model_o_nb == "PS")
PSA <-subset(spatial_firing, final_model_o_nb == "PSA")
A <-subset(spatial_firing, final_model_o_nb == "A")
PA <-subset(spatial_firing, final_model_o_nb == "PA")
None <-subset(spatial_firing, final_model_o_nb == "None")

```

```{r}

pos_s <-nrow(subset(P, final_model_h_nb == "S"))
pos_p <-nrow(subset(P, final_model_h_nb == "P"))
pos_pa <-nrow(subset(P, final_model_h_nb == "PA"))
pos_ps <-nrow(subset(P, final_model_h_nb == "PS"))
pos_pas <-nrow(subset(P, final_model_h_nb == "PSA"))
pos_a <-nrow(subset(P, final_model_h_nb == "A"))
pos_none <-nrow(subset(P, final_model_h_nb == "None"))

speed_s <-nrow(subset(S, final_model_h_nb == "S"))
speed_p <-nrow(subset(S, final_model_h_nb == "P"))
speed_pa <-nrow(subset(S, final_model_h_nb == "PA"))
speed_ps <-nrow(subset(S, final_model_h_nb == "PS"))
speed_pas <-nrow(subset(S, final_model_h_nb == "PSA"))
speed_a <-nrow(subset(S, final_model_h_nb == "A"))
speed_none <-nrow(subset(S, final_model_h_nb == "None"))

pos_speed_s <-nrow(subset(PS, final_model_h_nb == "S"))
pos_speed_p <-nrow(subset(PS, final_model_h_nb == "P"))
pos_speed_pa <-nrow(subset(PS, final_model_h_nb == "PA"))
pos_speed_ps <-nrow(subset(PS, final_model_h_nb == "PS"))
pos_speed_pas <-nrow(subset(PS, final_model_h_nb == "PSA"))
pos_speed_a <-nrow(subset(PS, final_model_h_nb == "A"))
pos_speed_none <-nrow(subset(PS, final_model_h_nb == "None"))

pos_int_s <-nrow(subset(PA, final_model_h_nb == "S"))
pos_int_p <-nrow(subset(PA, final_model_h_nb == "P"))
pos_int_pa <-nrow(subset(PA, final_model_h_nb == "PA"))
pos_int_ps <-nrow(subset(PA, final_model_h_nb == "PS"))
pos_int_pas <-nrow(subset(PA, final_model_h_nb == "PSA"))
pos_int_a <-nrow(subset(PA, final_model_h_nb == "A"))
pos_int_none <-nrow(subset(PA, final_model_h_nb == "None"))

pos_speed_int_s <-nrow(subset(PSA, final_model_h_nb == "S"))
pos_speed_int_p <-nrow(subset(PSA, final_model_h_nb == "P"))
pos_speed_int_pa <-nrow(subset(PSA, final_model_h_nb == "PA"))
pos_speed_int_ps <-nrow(subset(PSA, final_model_h_nb == "PS"))
pos_speed_int_pas <-nrow(subset(PSA, final_model_h_nb == "PSA"))
pos_speed_int_a <-nrow(subset(PSA, final_model_h_nb == "A"))
pos_speed_int_none <-nrow(subset(PSA, final_model_h_nb == "None"))

int_s <-nrow(subset(A, final_model_h_nb == "S"))
int_p <-nrow(subset(A, final_model_h_nb == "P"))
int_pa <-nrow(subset(A, final_model_h_nb == "PA"))
int_ps <-nrow(subset(A, final_model_h_nb == "PS"))
int_pas <-nrow(subset(A, final_model_h_nb == "PSA"))
int_a <-nrow(subset(A, final_model_h_nb == "A"))
int_none <-nrow(subset(A, final_model_h_nb == "None"))

none_s <-nrow(subset(None, final_model_h_nb == "S"))
none_p <-nrow(subset(None, final_model_h_nb == "P"))
none_pa <-nrow(subset(None, final_model_h_nb == "PA"))
none_ps <-nrow(subset(None, final_model_h_nb == "PS"))
none_pas <-nrow(subset(None, final_model_h_nb == "PSA"))
none_a <-nrow(subset(None, final_model_h_nb == "A"))
none_none <-nrow(subset(None, final_model_h_nb == "None"))
```

```{r}

data_long <- tibble(value=c(pos_s,pos_p,pos_ps, pos_pa, pos_pas, pos_a, pos_none, speed_s,speed_p,speed_ps, speed_pa, speed_pas, speed_a, speed_none,pos_speed_s, pos_speed_p,pos_speed_ps, pos_speed_pa, pos_speed_pas, pos_speed_a, pos_speed_none,pos_speed_int_s, pos_speed_int_p,pos_speed_int_ps, pos_speed_int_pa, pos_speed_int_pas, pos_speed_int_a, pos_speed_int_none, pos_int_s, pos_int_p,pos_int_ps, pos_int_pa, pos_int_pas, pos_int_a, pos_int_none, int_s, int_p,int_ps, int_ps, int_pas, int_a, int_none, none_s, none_p,int_ps, none_pa, none_pas, none_a, none_none), 
                    
                      source= c("P","P", "P", "P", "P", "P", "P","S", "S", "S", "S", "S", "S", "S", "PS", "PS", "PS", "PS", "PS", "PS", "PS", "PS", "PSA", "PSA", "PSA", "PSA", "PSA", "PSA","PA", "PA", "PA", "PA", "PA", "PA", "PA","A", "A", "A", "A", "A", "A", "A","none", "none", "none", "none", "none", "none", "none"),
                     target= c(" S"," P", " PS", " PA", " PSA", " A", " None"," S"," P", " PS", " PA", " PSA", " A", " None", " S"," P", " PS", " PA", " PSA", " A", " None"," S"," P", " PS", " PA", " PSA", " A", " None", " S"," P", " PS", " PA", " PSA", " A", " None", " S"," P", " PS", " PA", " PSA", " A", " None"," S"," P", " PS", " PA", " PSA", " A", " None"))


data_long <- data_long %>% 
  filter(value > 0)                    
                    
```

```{r}
# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(name=c(as.character(data_long$source), as.character(data_long$target)) %>% unique())
 
```

```{r}
# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
data_long$IDsource=match(data_long$source, nodes$name)-1 
data_long$IDtarget=match(data_long$target, nodes$name)-1
```

```{r}
# prepare colour scale
ColourScal ='d3.scaleOrdinal() .range(["#FDE725FF","#B4DE2CFF","#6DCD59FF","#35B779FF","#1F9E89FF","#26828EFF","#31688EFF","#3E4A89FF","#482878FF","#440154FF"])'

# Make the Network
sankeyNetwork(Links = data_long, Nodes = nodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name", LinkGroup='source',
              sinksRight=FALSE, colourScale=ColourScal,
              nodeWidth=40, fontSize=13, nodePadding=20)
#ggsave(file = "plots/model_movement.png", width = 24, height = 18)

```


#### Movement between lm groups (positive/negative slopes)

```{r}
P <-subset(spatial_firing_start, final_model_o_nb == "P" | final_model_h_nb == "P")
A <-subset(spatial_firing_start, final_model_o_nb == "A" | final_model_h_nb == "A")

```

```{r}
# positive homebound slopes
pos <-subset(spatial_firing, lm_result_o_nb == "Positive")
neg <-subset(spatial_firing, lm_result_o_nb == "Negative")
None <-subset(spatial_firing, lm_result_o_nb == "None")

```

```{r}

pos_pos <-nrow(subset(pos, lm_result_h_nb == "Positive"))
pos_neg <-nrow(subset(pos, lm_result_h_nb == "Negative"))
pos_none <-nrow(subset(pos, lm_result_h_nb == "None"))

neg_pos <-nrow(subset(neg, lm_result_h_nb == "Positive"))
neg_neg <-nrow(subset(neg, lm_result_h_nb == "Negative"))
neg_none <-nrow(subset(neg, lm_result_h_nb == "None"))

none_pos <-nrow(subset(None, lm_result_h_nb == "Positive"))
none_neg <-nrow(subset(None, lm_result_h_nb == "Negative"))
none_none <-nrow(subset(None, lm_result_h_nb == "None"))


```


```{r}

data_long <- tibble(value=c(pos_pos, pos_neg, pos_none, neg_pos,neg_neg, neg_none, none_pos, none_neg, none_none), 
                    
                      source= c("Positive","Positive", "Positive", "Negative", "Negative", "Negative", "None","None", "None"),
                     target= c(" Positive"," Negative", " None"," Positive"," Negative", " None"," Positive"," Negative", " None"))


data_long <- data_long %>% 
  filter(value > 0)                    
                    
```

```{r}
# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(name=c(as.character(data_long$source), as.character(data_long$target)) %>% unique())
 
```

```{r}
# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
data_long$IDsource=match(data_long$source, nodes$name)-1 
data_long$IDtarget=match(data_long$target, nodes$name)-1
```

```{r}
# prepare colour scale
ColourScal ='d3.scaleOrdinal() .range(["#FDE725FF","#B4DE2CFF","#6DCD59FF","#35B779FF","#1F9E89FF","#26828EFF","#31688EFF","#3E4A89FF","#482878FF","#440154FF"])'

# Make the Network
sankeyNetwork(Links = data_long, Nodes = nodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name", LinkGroup='source',
              sinksRight=FALSE, colourScale=ColourScal,
              nodeWidth=40, fontSize=13, nodePadding=20)
#ggsave(file = "plots/model_movement.png", width = 24, height = 18)

```






### NON BEACONED TRIALS

##  lm to lmer model

```{r}
# positive homebound slopes
P <-subset(spatial_firing, final_model_o_p == "P")
S <-subset(spatial_firing, final_model_o_p == "S")
PS <-subset(spatial_firing, final_model_o_p == "PS")
PSA <-subset(spatial_firing, final_model_o_p == "PSA")
A <-subset(spatial_firing, final_model_o_p == "A")
PA <-subset(spatial_firing, final_model_o_p == "PA")
None <-subset(spatial_firing, final_model_o_p == "None")

```

```{r}

pos_s <-nrow(subset(P, final_model_h_p == "S"))
pos_p <-nrow(subset(P, final_model_h_p == "P"))
pos_pa <-nrow(subset(P, final_model_h_p == "PA"))
pos_ps <-nrow(subset(P, final_model_h_p == "PS"))
pos_pas <-nrow(subset(P, final_model_h_p == "PSA"))
pos_a <-nrow(subset(P, final_model_h_p == "A"))
pos_none <-nrow(subset(P, final_model_h_p == "None"))

speed_s <-nrow(subset(S, final_model_h_p == "S"))
speed_p <-nrow(subset(S, final_model_h_p == "P"))
speed_pa <-nrow(subset(S, final_model_h_p == "PA"))
speed_ps <-nrow(subset(S, final_model_h_p == "PS"))
speed_pas <-nrow(subset(S, final_model_h_p == "PSA"))
speed_a <-nrow(subset(S, final_model_h_p == "A"))
speed_none <-nrow(subset(S, final_model_h_p == "None"))

pos_speed_s <-nrow(subset(PS, final_model_h_p == "S"))
pos_speed_p <-nrow(subset(PS, final_model_h_p == "P"))
pos_speed_pa <-nrow(subset(PS, final_model_h_p == "PA"))
pos_speed_ps <-nrow(subset(PS, final_model_h_p == "PS"))
pos_speed_pas <-nrow(subset(PS, final_model_h_p == "PSA"))
pos_speed_a <-nrow(subset(PS, final_model_h_p == "A"))
pos_speed_none <-nrow(subset(PS, final_model_h_p == "None"))

pos_int_s <-nrow(subset(PA, final_model_h_p == "S"))
pos_int_p <-nrow(subset(PA, final_model_h_p == "P"))
pos_int_pa <-nrow(subset(PA, final_model_h_p == "PA"))
pos_int_ps <-nrow(subset(PA, final_model_h_p == "PS"))
pos_int_pas <-nrow(subset(PA, final_model_h_p == "PSA"))
pos_int_a <-nrow(subset(PA, final_model_h_p == "A"))
pos_int_none <-nrow(subset(PA, final_model_h_p == "None"))

pos_speed_int_s <-nrow(subset(PSA, final_model_h_p == "S"))
pos_speed_int_p <-nrow(subset(PSA, final_model_h_p == "P"))
pos_speed_int_pa <-nrow(subset(PSA, final_model_h_p == "PA"))
pos_speed_int_ps <-nrow(subset(PSA, final_model_h_p == "PS"))
pos_speed_int_pas <-nrow(subset(PSA, final_model_h_p == "PSA"))
pos_speed_int_a <-nrow(subset(PSA, final_model_h_p == "A"))
pos_speed_int_none <-nrow(subset(PSA, final_model_h_p == "None"))

int_s <-nrow(subset(A, final_model_h_p == "S"))
int_p <-nrow(subset(A, final_model_h_p == "P"))
int_pa <-nrow(subset(A, final_model_h_p == "PA"))
int_ps <-nrow(subset(A, final_model_h_p == "PS"))
int_pas <-nrow(subset(A, final_model_h_p == "PSA"))
int_a <-nrow(subset(A, final_model_h_p == "A"))
int_none <-nrow(subset(A, final_model_h_p == "None"))

none_s <-nrow(subset(None, final_model_h_p == "S"))
none_p <-nrow(subset(None, final_model_h_p == "P"))
none_pa <-nrow(subset(None, final_model_h_p == "PA"))
none_ps <-nrow(subset(None, final_model_h_p == "PS"))
none_pas <-nrow(subset(None, final_model_h_p == "PSA"))
none_a <-nrow(subset(None, final_model_h_p == "A"))
none_none <-nrow(subset(None, final_model_h_p == "None"))
```

```{r}

data_long <- tibble(value=c(pos_s,pos_p,pos_ps, pos_pa, pos_pas, pos_a, pos_none, speed_s,speed_p,speed_ps, speed_pa, speed_pas, speed_a, speed_none,pos_speed_s, pos_speed_p,pos_speed_ps, pos_speed_pa, pos_speed_pas, pos_speed_a, pos_speed_none,pos_speed_int_s, pos_speed_int_p,pos_speed_int_ps, pos_speed_int_pa, pos_speed_int_pas, pos_speed_int_a, pos_speed_int_none, pos_int_s, pos_int_p,pos_int_ps, pos_int_pa, pos_int_pas, pos_int_a, pos_int_none, int_s, int_p,int_ps, int_ps, int_pas, int_a, int_none, none_s, none_p,int_ps, none_pa, none_pas, none_a, none_none), 
                    
                      source= c("P","P", "P", "P", "P", "P", "P","S", "S", "S", "S", "S", "S", "S", "PS", "PS", "PS", "PS", "PS", "PS", "PS", "PS", "PSA", "PSA", "PSA", "PSA", "PSA", "PSA","PA", "PA", "PA", "PA", "PA", "PA", "PA","A", "A", "A", "A", "A", "A", "A","none", "none", "none", "none", "none", "none", "none"),
                     target= c(" S"," P", " PS", " PA", " PSA", " A", " None"," S"," P", " PS", " PA", " PSA", " A", " None", " S"," P", " PS", " PA", " PSA", " A", " None"," S"," P", " PS", " PA", " PSA", " A", " None", " S"," P", " PS", " PA", " PSA", " A", " None", " S"," P", " PS", " PA", " PSA", " A", " None"," S"," P", " PS", " PA", " PSA", " A", " None"))


data_long <- data_long %>% 
  filter(value > 0)                    
                    
```

```{r}
# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(name=c(as.character(data_long$source), as.character(data_long$target)) %>% unique())
 
```

```{r}
# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
data_long$IDsource=match(data_long$source, nodes$name)-1 
data_long$IDtarget=match(data_long$target, nodes$name)-1
```

```{r}
# prepare colour scale
ColourScal ='d3.scaleOrdinal() .range(["#FDE725FF","#B4DE2CFF","#6DCD59FF","#35B779FF","#1F9E89FF","#26828EFF","#31688EFF","#3E4A89FF","#482878FF","#440154FF"])'

# Make the Network
sankeyNetwork(Links = data_long, Nodes = nodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name", LinkGroup='source',
              sinksRight=FALSE, colourScale=ColourScal,
              nodeWidth=40, fontSize=13, nodePadding=20)
#ggsave(file = "plots/model_movement.png", width = 24, height = 18)

```


#### Movement between lm groups (positive/negative slopes)

```{r}
P <-subset(spatial_firing_start, final_model_o_b == "P" | final_model_h_b == "P")
A <-subset(spatial_firing_start, final_model_o_b == "A" | final_model_h_b == "A")

```


```{r}
pathint <-subset(spatial_firing, group == "Negative-PI" | group == "Positive-PI" )

```


```{r}
# positive homebound slopes
pos <-subset(pathint, lm_result_o_p == "Positive")
neg <-subset(pathint, lm_result_o_p == "Negative")
None <-subset(pathint, lm_result_o_p == "None")

```

```{r}

pos_pos <-nrow(subset(pos, lm_result_h_p == "Positive"))
pos_neg <-nrow(subset(pos, lm_result_h_p == "Negative"))
pos_none <-nrow(subset(pos, lm_result_h_p == "None"))

neg_pos <-nrow(subset(neg, lm_result_h_p == "Positive"))
neg_neg <-nrow(subset(neg, lm_result_h_p == "Negative"))
neg_none <-nrow(subset(neg, lm_result_h_p == "None"))

none_pos <-nrow(subset(None, lm_result_h_p == "Positive"))
none_neg <-nrow(subset(None, lm_result_h_p == "Negative"))
none_none <-nrow(subset(None, lm_result_h_p == "None"))


```


```{r}

data_long <- tibble(value=c(pos_pos, pos_neg, pos_none, neg_pos,neg_neg, neg_none, none_pos, none_neg, none_none), 
                    
                      source= c("Positive","Positive", "Positive", "Negative", "Negative", "Negative", "None","None", "None"),
                     target= c(" Positive"," Negative", " None"," Positive"," Negative", " None"," Positive"," Negative", " None"))


data_long <- data_long %>% 
  filter(value > 0)                    
                    
```

```{r}
# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(name=c(as.character(data_long$source), as.character(data_long$target)) %>% unique())
 
```

```{r}
# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
data_long$IDsource=match(data_long$source, nodes$name)-1 
data_long$IDtarget=match(data_long$target, nodes$name)-1
```

```{r}
# prepare colour scale
ColourScal ='d3.scaleOrdinal() .range(["#FDE725FF","#B4DE2CFF","#6DCD59FF","#35B779FF","#1F9E89FF","#26828EFF","#31688EFF","#3E4A89FF","#482878FF","#440154FF"])'

# Make the Network
sankeyNetwork(Links = data_long, Nodes = nodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name", LinkGroup='source',
              sinksRight=FALSE, colourScale=ColourScal,
              nodeWidth=40, fontSize=13, nodePadding=20)
#ggsave(file = "plots/model_movement.png", width = 24, height = 18)

```




##### ---------------------------------------- ####




# define grouping
```{r}
pos_pos <-subset(spatial_firing, lm_result_o_p == "Positive" & lm_result_h_p == "Positive")
pos_neg <-subset(spatial_firing, lm_result_o_p == "Positive" & lm_result_h_p == "Negative")
pos_none <-subset(spatial_firing, lm_result_o_p == "Positive" & lm_result_h_p == "None")

neg_pos <-subset(spatial_firing, lm_result_o_p == "Negative" & lm_result_h_p == "Positive")
neg_neg <-subset(spatial_firing, lm_result_o_p == "Negative" & lm_result_h_p == "Negative")
neg_none <-subset(spatial_firing, lm_result_o_p == "Negative" & lm_result_h_p == "None")

none_pos <-subset(spatial_firing, lm_result_o_p == "None" & lm_result_h_p == "Positive")
none_neg <-subset(spatial_firing, lm_result_o_p == "None" & lm_result_h_p == "Negative")
none_none <-subset(spatial_firing, lm_result_o_p == "None" & lm_result_h_p == "None")
```



```{r}
pos_s <-nrow(subset(pos_pos, final_model_o_p == "S"))/nrow(pos_pos)*100
pos_p <-nrow(subset(pos_pos, final_model_o_p == "P"))/nrow(pos_pos)*100
pos_pa <-nrow(subset(pos_pos, final_model_o_p == "PA"))/nrow(pos_pos)*100
pos_ps <-nrow(subset(pos_pos, final_model_o_p == "PS"))/nrow(pos_pos)*100
pos_pas <-nrow(subset(pos_pos, final_model_o_p == "PSA"))/nrow(pos_pos)*100
pos_a <-nrow(subset(pos_pos, final_model_o_p == "A"))/nrow(pos_pos)*100
pos_sa <-nrow(subset(pos_pos, final_model_o_p == "SA"))/nrow(pos_pos)*100
pos_n <-nrow(subset(pos_pos, final_model_o_p == "None"))/nrow(pos_pos)*100

speed_s <-nrow(subset(pos_neg, final_model_o_p == "S"))/nrow(pos_neg)*100
speed_p <-nrow(subset(pos_neg, final_model_o_p == "P"))/nrow(pos_neg)*100
speed_pa <-nrow(subset(pos_neg, final_model_o_p == "PA"))/nrow(pos_neg)*100
speed_ps <-nrow(subset(pos_neg, final_model_o_p == "PS"))/nrow(pos_neg)*100
speed_pas <-nrow(subset(pos_neg, final_model_o_p == "PSA"))/nrow(pos_neg)*100
speed_a <-nrow(subset(pos_neg, final_model_o_p == "A"))/nrow(pos_neg)*100
speed_sa <-nrow(subset(pos_neg, final_model_o_p == "SA"))/nrow(pos_neg)*100
speed_none <-nrow(subset(pos_neg, final_model_o_p == "None"))/nrow(pos_neg)*100

pos_speed_s <-nrow(subset(pos_none, final_model_o_p == "S"))/nrow(pos_none)*100
pos_speed_p <-nrow(subset(pos_none, final_model_o_p == "P"))/nrow(pos_none)*100
pos_speed_pa <-nrow(subset(pos_none, final_model_o_p == "PA"))/nrow(pos_none)*100
pos_speed_ps <-nrow(subset(pos_none, final_model_o_p == "PS"))/nrow(pos_none)*100
pos_speed_pas <-nrow(subset(pos_none, final_model_o_p == "PSA"))/nrow(pos_none)*100
pos_speed_a <-nrow(subset(pos_none, final_model_o_p == "A"))/nrow(pos_none)*100
pos_speed_sa <-nrow(subset(pos_none, final_model_o_p == "SA"))/nrow(pos_none)*100
pos_speed_none <-nrow(subset(pos_none, final_model_o_p == "None"))/nrow(pos_none)*100

pos_int_s <-nrow(subset(neg_pos, final_model_o_p == "S"))/nrow(neg_pos)*100
pos_int_p <-nrow(subset(neg_pos, final_model_o_p == "P"))/nrow(neg_pos)*100
pos_int_pa <-nrow(subset(neg_pos, final_model_o_p == "PA"))/nrow(neg_pos)*100
pos_int_ps <-nrow(subset(neg_pos, final_model_o_p == "PS"))/nrow(neg_pos)*100
pos_int_pas <-nrow(subset(neg_pos, final_model_o_p == "PSA"))/nrow(neg_pos)*100
pos_int_a <-nrow(subset(neg_pos, final_model_o_p == "A"))/nrow(neg_pos)*100
pos_int_sa <-nrow(subset(neg_pos, final_model_o_p == "SA"))/nrow(neg_pos)*100
pos_int_none <-nrow(subset(neg_pos, final_model_o_p == "None"))/nrow(neg_pos)*100

pos_speed_int_s <-nrow(subset(neg_neg, final_model_o_p == "S"))/nrow(neg_neg)*100
pos_speed_int_p <-nrow(subset(neg_neg, final_model_o_p == "P"))/nrow(neg_neg)*100
pos_speed_int_pa <-nrow(subset(neg_neg, final_model_o_p == "PA"))/nrow(neg_neg)*100
pos_speed_int_ps <-nrow(subset(neg_neg, final_model_o_p == "PS"))/nrow(neg_neg)*100
pos_speed_int_pas <-nrow(subset(neg_neg, final_model_o_p == "PSA"))/nrow(neg_neg)*100
pos_speed_int_a <-nrow(subset(neg_neg, final_model_o_p == "A"))/nrow(neg_neg)*100
pos_speed_int_sa <-nrow(subset(neg_neg, final_model_o_p == "SA"))/nrow(neg_neg)*100
pos_speed_int_none <-nrow(subset(neg_neg, final_model_o_p == "None"))/nrow(neg_neg)*100

int_s <-nrow(subset(neg_none, final_model_o_p == "S"))/nrow(neg_none)*100
int_p <-nrow(subset(neg_none, final_model_o_p == "P"))/nrow(neg_none)*100
int_pa <-nrow(subset(neg_none, final_model_o_p == "PA"))/nrow(neg_none)*100
int_ps <-nrow(subset(neg_none, final_model_o_p == "PS"))/nrow(neg_none)*100
int_pas <-nrow(subset(neg_none, final_model_o_p == "PSA"))/nrow(neg_none)*100
int_a <-nrow(subset(neg_none, final_model_o_p == "A"))/nrow(neg_none)*100
int_sa <-nrow(subset(neg_none, final_model_o_p == "SA"))/nrow(neg_none)*100
int_none <-nrow(subset(neg_none, final_model_o_p == "None"))/nrow(neg_none)*100

none_s <-nrow(subset(none_pos, final_model_o_p == "S"))/nrow(none_pos)*100
none_p <-nrow(subset(none_pos, final_model_o_p == "P"))/nrow(none_pos)*100
none_pa <-nrow(subset(none_pos, final_model_o_p == "PA"))/nrow(none_pos)*100
none_ps <-nrow(subset(none_pos, final_model_o_p == "PS"))/nrow(none_pos)*100
none_pas <-nrow(subset(none_pos, final_model_o_p == "PSA"))/nrow(none_pos)*100
none_a <-nrow(subset(none_pos, final_model_o_p == "A"))/nrow(none_pos)*100
none_sa <-nrow(subset(none_pos, final_model_o_p == "SA"))/nrow(none_pos)*100
none_n <-nrow(subset(none_pos, final_model_o_p == "None"))/nrow(none_pos)*100

none_neg_s <-nrow(subset(none_neg, final_model_o_p == "S"))/nrow(none_neg)*100
none_neg_p <-nrow(subset(none_neg, final_model_o_p == "P"))/nrow(none_neg)*100
none_neg_pa <-nrow(subset(none_neg, final_model_o_p == "PA"))/nrow(none_neg)*100
none_neg_ps <-nrow(subset(none_neg, final_model_o_p == "PS"))/nrow(none_neg)*100
none_neg_pas <-nrow(subset(none_neg, final_model_o_p == "PSA"))/nrow(none_neg)*100
none_neg_a <-nrow(subset(none_neg, final_model_o_p == "A"))/nrow(none_neg)*100
none_neg_sa <-nrow(subset(none_neg, final_model_o_p == "SA"))/nrow(none_neg)*100
none_neg_none <-nrow(subset(none_neg, final_model_o_p == "None"))/nrow(none_neg)*100

none_n_s <-nrow(subset(none_none, final_model_o_p == "S"))/nrow(none_none)*100
none_n_p <-nrow(subset(none_none, final_model_o_p == "P"))/nrow(none_none)*100
none_n_pa <-nrow(subset(none_none, final_model_o_p == "PA"))/nrow(none_none)*100
none_n_ps <-nrow(subset(none_none, final_model_o_p == "PS"))/nrow(none_none)*100
none_n_pas <-nrow(subset(none_none, final_model_o_p == "PSA"))/nrow(none_none)*100
none_n_a <-nrow(subset(none_none, final_model_o_p == "A"))/nrow(none_none)*100
none_n_sa <-nrow(subset(none_none, final_model_o_p == "SA"))/nrow(none_none)*100
none_n_none <-nrow(subset(none_none, final_model_o_p == "None"))/nrow(none_none)*100
```


```{r}

mixed_ramps <- tibble(perc=c(pos_s,pos_p,pos_pa,pos_ps, pos_pas, pos_a,pos_sa, pos_n,
                             speed_s,speed_p,speed_pa,speed_ps, speed_pas, speed_a, speed_sa,speed_none,
                             pos_speed_s,pos_speed_p,pos_speed_pa,pos_speed_ps, pos_speed_pas, pos_speed_a,pos_speed_sa, pos_speed_none,
                             pos_int_s,pos_int_p,pos_int_pa,pos_int_ps, pos_int_pas, pos_int_a, pos_int_sa,pos_int_none,
                             pos_speed_int_s,pos_speed_int_p,pos_speed_int_pa,pos_speed_int_ps, pos_speed_int_pas, pos_speed_int_a, pos_speed_int_sa, pos_speed_int_none,
                             int_s,int_p,int_pa,int_ps, int_pas, int_a, int_sa,int_none,
                             none_s,none_p,none_pa,none_ps, none_pas, none_a, none_sa,none_n,
                             none_neg_s,none_neg_p,none_neg_pa,none_neg_ps, none_neg_pas, none_neg_a, none_neg_sa,none_neg_none), 
                      
                      ramp_id= c("S","P","PA","PS","PAS","A","SA","None", 
                                 "S","P","PA","PS","PAS","A","SA","None", 
                                 "S","P","PA","PS","PAS","A","SA","None",
                                 "S","P","PA","PS","PAS","A","SA","None", 
                                 "S","P","PA","PS","PAS","A","SA","None", 
                                 "S","P","PA","PS","PAS","A","SA","None", 
                                 "S","P","PA","PS","PAS","A","SA","None", 
                                 "S","P","PA","PS","PAS","A","SA","None"), 
                      
                      ramp_type= c("Positive-Positive", "Positive-Positive", "Positive-Positive", "Positive-Positive", "Positive-Positive", "Positive-Positive", "Positive-Positive", "Positive-Positive",
                                   "Positive-Negative", "Positive-Negative", "Positive-Negative", "Positive-Negative", "Positive-Negative", "Positive-Negative", "Positive-Negative", "Positive-Negative",
                                   "Positive-None","Positive-None", "Positive-None", "Positive-None", "Positive-None", "Positive-None", "Positive-None", "Positive-None",
                                   "Negative-Positive", "Negative-Positive","Negative-Positive", "Negative-Positive", "Negative-Positive", "Negative-Positive", "Negative-Positive", "Negative-Positive",
                                   "Negative-Negative", "Negative-Negative","Negative-Negative", "Negative-Negative", "Negative-Negative", "Negative-Negative", "Negative-Negative", "Negative-Negative",
                                   "Negative-None", "Negative-None","Negative-None", "Negative-None", "Negative-None", "Negative-None", "Negative-None", "Negative-None",
                                   "None-Positive", "None-Positive", "None-Positive", "None-Positive", "None-Positive", "None-Positive", "None-Positive", "None-Positive", 
                                   "None-Negative", "None-Negative","None-Negative", "None-Negative", "None-Negative", "None-Negative", "None-Negative", "None-Negative"))

```





7. Plot model results

```{r}
# plot data
level_order <- c("P", "S", "A", "PS", "PA","SA", "PAS", "None")
ggplot(mixed_ramps, aes(x= factor(ramp_type), y = perc, fill=factor(ramp_id, level = level_order))) +
  geom_bar(stat="identity",width = 0.9, alpha = .7) +
  labs(y = "Percent") +
  scale_fill_manual(values=c("deeppink1","indianred3", "steelblue3", "darkred", "orchid", "lightseagreen", "darkgreen", "grey32")) +

  #scale_fill_brewer(palette= "RdYlBu") +
  theme_classic() +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.position="bottom", 
        legend.title = element_blank(),
        text = element_text(size=12), 
        legend.text=element_text(size=12), 
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))
ggsave(file = "plots/cell_proportions-groups.png", width = 4, height = 4.5)


```



### same as above for homebound


```{r}
pos_s <-nrow(subset(pos_pos, final_model_h_p == "S"))/nrow(pos_pos)*100
pos_p <-nrow(subset(pos_pos, final_model_h_p == "P"))/nrow(pos_pos)*100
pos_pa <-nrow(subset(pos_pos, final_model_h_p == "PA"))/nrow(pos_pos)*100
pos_ps <-nrow(subset(pos_pos, final_model_h_p == "PS"))/nrow(pos_pos)*100
pos_pas <-nrow(subset(pos_pos, final_model_h_p == "PSA"))/nrow(pos_pos)*100
pos_a <-nrow(subset(pos_pos, final_model_h_p == "A"))/nrow(pos_pos)*100
pos_sa <-nrow(subset(pos_pos, final_model_h_p == "SA"))/nrow(pos_pos)*100
pos_n <-nrow(subset(pos_pos, final_model_h_p == "None"))/nrow(pos_pos)*100

speed_s <-nrow(subset(pos_neg, final_model_h_p == "S"))/nrow(pos_neg)*100
speed_p <-nrow(subset(pos_neg, final_model_h_p == "P"))/nrow(pos_neg)*100
speed_pa <-nrow(subset(pos_neg, final_model_h_p == "PA"))/nrow(pos_neg)*100
speed_ps <-nrow(subset(pos_neg, final_model_h_p == "PS"))/nrow(pos_neg)*100
speed_pas <-nrow(subset(pos_neg, final_model_h_p == "PSA"))/nrow(pos_neg)*100
speed_a <-nrow(subset(pos_neg, final_model_h_p == "A"))/nrow(pos_neg)*100
speed_sa <-nrow(subset(pos_neg, final_model_h_p == "SA"))/nrow(pos_neg)*100
speed_none <-nrow(subset(pos_neg, final_model_h_p == "None"))/nrow(pos_neg)*100

pos_speed_s <-nrow(subset(pos_none, final_model_h_p == "S"))/nrow(pos_none)*100
pos_speed_p <-nrow(subset(pos_none, final_model_h_p == "P"))/nrow(pos_none)*100
pos_speed_pa <-nrow(subset(pos_none, final_model_h_p == "PA"))/nrow(pos_none)*100
pos_speed_ps <-nrow(subset(pos_none, final_model_h_p == "PS"))/nrow(pos_none)*100
pos_speed_pas <-nrow(subset(pos_none, final_model_h_p == "PSA"))/nrow(pos_none)*100
pos_speed_a <-nrow(subset(pos_none, final_model_h_p == "A"))/nrow(pos_none)*100
pos_speed_sa <-nrow(subset(pos_none, final_model_h_p == "SA"))/nrow(pos_none)*100
pos_speed_none <-nrow(subset(pos_none, final_model_h_p == "None"))/nrow(pos_none)*100

pos_int_s <-nrow(subset(neg_pos, final_model_h_p == "S"))/nrow(neg_pos)*100
pos_int_p <-nrow(subset(neg_pos, final_model_h_p == "P"))/nrow(neg_pos)*100
pos_int_pa <-nrow(subset(neg_pos, final_model_h_p == "PA"))/nrow(neg_pos)*100
pos_int_ps <-nrow(subset(neg_pos, final_model_h_p == "PS"))/nrow(neg_pos)*100
pos_int_pas <-nrow(subset(neg_pos, final_model_h_p == "PSA"))/nrow(neg_pos)*100
pos_int_a <-nrow(subset(neg_pos, final_model_h_p == "A"))/nrow(neg_pos)*100
pos_int_sa <-nrow(subset(neg_pos, final_model_h_p == "SA"))/nrow(neg_pos)*100
pos_int_none <-nrow(subset(neg_pos, final_model_h_p == "None"))/nrow(neg_pos)*100

pos_speed_int_s <-nrow(subset(neg_neg, final_model_h_p == "S"))/nrow(neg_neg)*100
pos_speed_int_p <-nrow(subset(neg_neg, final_model_h_p == "P"))/nrow(neg_neg)*100
pos_speed_int_pa <-nrow(subset(neg_neg, final_model_h_p == "PA"))/nrow(neg_neg)*100
pos_speed_int_ps <-nrow(subset(neg_neg, final_model_h_p == "PS"))/nrow(neg_neg)*100
pos_speed_int_pas <-nrow(subset(neg_neg, final_model_h_p == "PSA"))/nrow(neg_neg)*100
pos_speed_int_a <-nrow(subset(neg_neg, final_model_h_p == "A"))/nrow(neg_neg)*100
pos_speed_int_sa <-nrow(subset(neg_neg, final_model_h_p == "SA"))/nrow(neg_neg)*100
pos_speed_int_none <-nrow(subset(neg_neg, final_model_h_p == "None"))/nrow(neg_neg)*100

int_s <-nrow(subset(neg_none, final_model_h_p == "S"))/nrow(neg_none)*100
int_p <-nrow(subset(neg_none, final_model_h_p == "P"))/nrow(neg_none)*100
int_pa <-nrow(subset(neg_none, final_model_h_p == "PA"))/nrow(neg_none)*100
int_ps <-nrow(subset(neg_none, final_model_h_p == "PS"))/nrow(neg_none)*100
int_pas <-nrow(subset(neg_none, final_model_h_p == "PSA"))/nrow(neg_none)*100
int_a <-nrow(subset(neg_none, final_model_h_p == "A"))/nrow(neg_none)*100
int_sa <-nrow(subset(neg_none, final_model_h_p == "SA"))/nrow(neg_none)*100
int_none <-nrow(subset(neg_none, final_model_h_p == "None"))/nrow(neg_none)*100

none_s <-nrow(subset(none_pos, final_model_h_p == "S"))/nrow(none_pos)*100
none_p <-nrow(subset(none_pos, final_model_h_p == "P"))/nrow(none_pos)*100
none_pa <-nrow(subset(none_pos, final_model_h_p == "PA"))/nrow(none_pos)*100
none_ps <-nrow(subset(none_pos, final_model_h_p == "PS"))/nrow(none_pos)*100
none_pas <-nrow(subset(none_pos, final_model_h_p == "PSA"))/nrow(none_pos)*100
none_a <-nrow(subset(none_pos, final_model_h_p == "A"))/nrow(none_pos)*100
none_sa <-nrow(subset(none_pos, final_model_h_p == "SA"))/nrow(none_pos)*100
none_n <-nrow(subset(none_pos, final_model_h_p == "None"))/nrow(none_pos)*100

none_neg_s <-nrow(subset(none_neg, final_model_h_p == "S"))/nrow(none_neg)*100
none_neg_p <-nrow(subset(none_neg, final_model_h_p == "P"))/nrow(none_neg)*100
none_neg_pa <-nrow(subset(none_neg, final_model_h_p == "PA"))/nrow(none_neg)*100
none_neg_ps <-nrow(subset(none_neg, final_model_h_p == "PS"))/nrow(none_neg)*100
none_neg_pas <-nrow(subset(none_neg, final_model_h_p == "PSA"))/nrow(none_neg)*100
none_neg_a <-nrow(subset(none_neg, final_model_h_p == "A"))/nrow(none_neg)*100
none_neg_sa <-nrow(subset(none_neg, final_model_h_p == "SA"))/nrow(none_neg)*100
none_neg_none <-nrow(subset(none_neg, final_model_h_p == "None"))/nrow(none_neg)*100

none_n_s <-nrow(subset(none_none, final_model_h_p == "S"))/nrow(none_none)*100
none_n_p <-nrow(subset(none_none, final_model_h_p == "P"))/nrow(none_none)*100
none_n_pa <-nrow(subset(none_none, final_model_h_p == "PA"))/nrow(none_none)*100
none_n_ps <-nrow(subset(none_none, final_model_h_p == "PS"))/nrow(none_none)*100
none_n_pas <-nrow(subset(none_none, final_model_h_p == "PSA"))/nrow(none_none)*100
none_n_a <-nrow(subset(none_none, final_model_h_p == "A"))/nrow(none_none)*100
none_n_sa <-nrow(subset(none_none, final_model_h_p == "SA"))/nrow(none_none)*100
none_n_none <-nrow(subset(none_none, final_model_h_p == "None"))/nrow(none_none)*100
```


```{r}

mixed_ramps <- tibble(perc=c(pos_s,pos_p,pos_pa,pos_ps, pos_pas, pos_a,pos_sa, pos_n,
                             speed_s,speed_p,speed_pa,speed_ps, speed_pas, speed_a, speed_sa,speed_none,
                             pos_speed_s,pos_speed_p,pos_speed_pa,pos_speed_ps, pos_speed_pas, pos_speed_a,pos_speed_sa, pos_speed_none,
                             pos_int_s,pos_int_p,pos_int_pa,pos_int_ps, pos_int_pas, pos_int_a, pos_int_sa,pos_int_none,
                             pos_speed_int_s,pos_speed_int_p,pos_speed_int_pa,pos_speed_int_ps, pos_speed_int_pas, pos_speed_int_a, pos_speed_int_sa, pos_speed_int_none,
                             int_s,int_p,int_pa,int_ps, int_pas, int_a, int_sa,int_none,
                             none_s,none_p,none_pa,none_ps, none_pas, none_a, none_sa,none_n,
                             none_neg_s,none_neg_p,none_neg_pa,none_neg_ps, none_neg_pas, none_neg_a, none_neg_sa,none_neg_none), 
                      
                      ramp_id= c("S","P","PA","PS","PAS","A","SA","None", 
                                 "S","P","PA","PS","PAS","A","SA","None", 
                                 "S","P","PA","PS","PAS","A","SA","None",
                                 "S","P","PA","PS","PAS","A","SA","None", 
                                 "S","P","PA","PS","PAS","A","SA","None", 
                                 "S","P","PA","PS","PAS","A","SA","None", 
                                 "S","P","PA","PS","PAS","A","SA","None", 
                                 "S","P","PA","PS","PAS","A","SA","None"), 
                      
                      ramp_type= c("Positive-Positive", "Positive-Positive", "Positive-Positive", "Positive-Positive", "Positive-Positive", "Positive-Positive", "Positive-Positive", "Positive-Positive",
                                   "Positive-Negative", "Positive-Negative", "Positive-Negative", "Positive-Negative", "Positive-Negative", "Positive-Negative", "Positive-Negative", "Positive-Negative",
                                   "Positive-None","Positive-None", "Positive-None", "Positive-None", "Positive-None", "Positive-None", "Positive-None", "Positive-None",
                                   "Negative-Positive", "Negative-Positive","Negative-Positive", "Negative-Positive", "Negative-Positive", "Negative-Positive", "Negative-Positive", "Negative-Positive",
                                   "Negative-Negative", "Negative-Negative","Negative-Negative", "Negative-Negative", "Negative-Negative", "Negative-Negative", "Negative-Negative", "Negative-Negative",
                                   "Negative-None", "Negative-None","Negative-None", "Negative-None", "Negative-None", "Negative-None", "Negative-None", "Negative-None",
                                   "None-Positive", "None-Positive", "None-Positive", "None-Positive", "None-Positive", "None-Positive", "None-Positive", "None-Positive", 
                                   "None-Negative", "None-Negative","None-Negative", "None-Negative", "None-Negative", "None-Negative", "None-Negative", "None-Negative"))

```


7. Plot model results

```{r}
# plot data
level_order <- c("P", "S", "A", "PS", "PA","SA", "PAS", "None")
ggplot(mixed_ramps, aes(x= factor(ramp_type), y = perc, fill=factor(ramp_id, level = level_order))) +
  geom_bar(stat="identity",width = 0.9, alpha = .7) +
  labs(y = "Percent") +
  scale_fill_manual(values=c("deeppink1","indianred3", "steelblue3", "darkred", "orchid", "lightseagreen", "darkgreen", "grey32")) +

  #scale_fill_brewer(palette= "RdYlBu") +
  theme_classic() +
  theme(axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        legend.position="bottom", 
        legend.title = element_blank(),
        text = element_text(size=12), 
        legend.text=element_text(size=12), 
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))
ggsave(file = "plots/cell_proportions-groups_homebound.png", width = 4, height = 4.5)


```





# define grouping
```{r}
pos_pos <-nrow(subset(spatial_firing, lm_result_o_p == "Positive" & lm_result_h_p == "Positive"))/nrow(spatial_firing)*100
pos_neg <-nrow(subset(spatial_firing, lm_result_o_p == "Positive" & lm_result_h_p == "Negative"))/nrow(spatial_firing)*100
pos_none <-nrow(subset(spatial_firing, lm_result_o_p == "Positive" & lm_result_h_p == "None"))/nrow(spatial_firing)*100

neg_pos <-nrow(subset(spatial_firing, lm_result_o_p == "Negative" & lm_result_h_p == "Positive"))/nrow(spatial_firing)*100
neg_neg <-nrow(subset(spatial_firing, lm_result_o_p == "Negative" & lm_result_h_p == "Negative"))/nrow(spatial_firing)*100
neg_none <-nrow(subset(spatial_firing, lm_result_o_p == "Negative" & lm_result_h_p == "None"))/nrow(spatial_firing)*100

none_pos <-nrow(subset(spatial_firing, lm_result_o_p == "None" & lm_result_h_p == "Positive"))/nrow(spatial_firing)*100
none_neg <-nrow(subset(spatial_firing, lm_result_o_p == "None" & lm_result_h_p == "Negative"))/nrow(spatial_firing)*100
none_none <-nrow(subset(spatial_firing, lm_result_o_p == "None" & lm_result_h_p == "None"))/nrow(spatial_firing)*100
```


```{r}
mixed_ramps <- tibble(perc=c(pos_pos,pos_neg,pos_none,neg_pos, neg_neg, neg_none,none_pos, none_neg), 
                      
                      ramp_id= c("Positive-Positive","Positive-Negative","Positive-None","Negative-Positive", "Negative-Negative","Negative-None","None-Positive","None-Negative"), 
                      
                      ramp_type= c("Positive-Positive","Positive-Negative","Positive-None","Negative-Positive", "Negative-Negative","Negative-None","None-Positive","None-Negative"))
```


```{r}
bp<- ggplot(mixed_ramps, aes(x="", y=perc, fill=ramp_id))+
geom_bar(width = 1, stat = "identity")
pie <- bp + coord_polar("y", start=0) + 
  scale_fill_brewer(palette="Blues") +
  theme_minimal() +
  geom_text(aes(y = perc/1 + c(0, cumsum(perc)[-length(perc)]), 
            label = round(perc, digits=2)), size=2)
pie
ggsave(file = "plots/cell_proportions-groups_pie.png", width = 4, height = 4.5)

```





# define grouping
```{r}
pos_pos <-subset(spatial_firing, lm_result_o_p == "Positive" & lm_result_h_p == "Positive")
pos_neg <-subset(spatial_firing, lm_result_o_p == "Positive" & lm_result_h_p == "Negative")
pos_none <-subset(spatial_firing, lm_result_o_p == "Positive" & lm_result_h_p == "None")

neg_pos <-subset(spatial_firing, lm_result_o_p == "Negative" & lm_result_h_p == "Positive")
neg_neg <-subset(spatial_firing, lm_result_o_p == "Negative" & lm_result_h_p == "Negative")
neg_none <-subset(spatial_firing, lm_result_o_p == "Negative" & lm_result_h_p == "None")

none_pos <-subset(spatial_firing, lm_result_o_p == "None" & lm_result_h_p == "Positive")
none_neg <-subset(spatial_firing, lm_result_o_p == "None" & lm_result_h_p == "Negative")
none_none <-subset(spatial_firing, lm_result_o_p == "None" & lm_result_h_p == "None")
```


```{r}
pos_n <-subset(pos_pos, final_model_h_p == "None")
pos_position <-subset(pos_pos, final_model_h_p == "PA")
speed_none <-subset(pos_neg, final_model_h_p == "None")
pos_position <-subset(pos_neg, final_model_h_p == "A")
pos_speed_none <-subset(pos_none, final_model_h_p == "None")
pos_int_none <-subset(neg_pos, final_model_h_p == "None")
pos_position <-subset(neg_pos, final_model_h_p == "P")
pos_speed_int_none <- subset(neg_neg, final_model_h_p == "None")
int_none <- subset(neg_none, final_model_h_p == "None")
none_n <- subset(none_pos, final_model_h_p == "None")
none_neg_none <- subset(none_neg, final_model_h_p == "None")
none_n_none <- subset(none_none, final_model_h_p == "None")
```


```{r}

slope_comparison <- as.tibble(cbind(cluster_id=pos_n$cluster_id, 
                          start_model = pos_n$asr_p_slope,
                          end_model = pos_n$asr_p_slope,
                          session_id = pos_n$session_id, 
                          firing_rate_in_time = pos_n$spikes_in_time,
                          firing_rate_p = pos_n$asr_p))
```



### plot all cells wth followning info:


```{r}
ramp_number = nrow(slope_comparison)
new_cluster_id = seq(from = 1, to = ramp_number, by = 1)
mixed_ramps <- cbind(slope_comparison, new_cluster_id)

concat_firing_mix <- unnest(select(na.omit(mixed_ramps), session_id, new_cluster_id, firing_rate_p, firing_rate_in_time), firing_rate_p)

```


```{r}
ggplot(data=concat_firing_mix, aes(x=Position, y=Rates)) +
    geom_line(color = "blue", position = "identity",show.legend = NA) +
    scale_y_continuous(breaks = NULL) +
    facet_wrap(vars(new_cluster_id), scales = "free_y") +
    theme(strip.background = element_blank(),strip.text.x = element_blank()) +
    theme_classic() +
    annotate("rect", xmin = 90, xmax = 110, ymin = 0, ymax = 20, color="White", fill="Green", alpha = .2) + 
    annotate("rect", xmin = 0, xmax = 30, ymin = 0, ymax = 20, color="White", fill="Grey", alpha = .2) +
    annotate("rect", xmin = 170, xmax = 200, ymin = 0, ymax = 20, color="White", fill="Grey", alpha = .2) +
ggsave(file = "plots/facet_pos_pos_None.png", width = 14, height = 9)



```


```{r}

ramp_number = nrow(slope_comparison)
new_cluster_id = seq(from = 1, to = ramp_number, by = 1)
mixed_ramps <- cbind(slope_comparison, new_cluster_id)

#concat_firing_mix <- unnest(select(na.omit(mixed_ramps), session_id, new_cluster_id, firing_rate_in_time), firing_rate_in_time)

df <- tibble(Rates = as.numeric(unlist(mixed_ramps[5,]$firing_rate_in_time[[1]][1])), Position = as.numeric(unlist(mixed_ramps[5,]$firing_rate_in_time[[1]][2])), Speed = unlist(mixed_ramps[5,]$firing_rate_in_time[[1]][3]), Trials = unlist(mixed_ramps[5,]$firing_rate_in_time[[1]][5]), Types = unlist(mixed_ramps[5,]$firing_rate_in_time[[1]][6]))
df <- df %>% 
  subset(Speed > 3 & Types == 2) 
```

```{r}
ggplot(data=df, aes(x=Position, y=Rates)) +
    geom_point(color = "deeppink1",geom = "smooth", position = "identity",show.legend = NA, n = 40, span = 0.4) +
    #stat_smooth(aes(x=Position, y=Rates1), color = "grey32",geom = "smooth", position = "identity",show.legend = NA, n = 40, span = 0.4) +
    scale_y_continuous(breaks = NULL) +
    #facet_wrap(vars(new_cluster_id), scales = "free_y") +
    #theme(strip.background = element_blank(),strip.text.x = element_blank()) +
    theme_classic() +
    annotate("rect", xmin = 90, xmax = 110, ymin = 0, ymax = 20, color="White", fill="Green", alpha = .2) + 
    annotate("rect", xmin = 0, xmax = 30, ymin = 0, ymax = 20, color="White", fill="Grey", alpha = .2) +
    annotate("rect", xmin = 170, xmax = 200, ymin = 0, ymax = 20, color="White", fill="Grey", alpha = .2) +
ggsave(file = "plots/example_all_facet_in_time5.png", width = 14, height = 9)
```


## plot slopes for all lmer groups
```{r}
pos_neg <-subset(spatial_firing, lm_result_o_p == "Positive" & lm_result_h_p == "Negative")

```


```{r}

outbound_ramps <- outbound_ramps %>%
  filter(lm_result_o_b != "None" | lm_result_o_b != "NA")

```


```{r}
lm_results_ramps <- tibble(Ramp_type = as.character(outbound_ramps$final_model_o_p),
    Slopes = outbound_ramps$asr_b_slope_o, 
    r2 = outbound_ramps$asr_b_r2_o, 
    id =outbound_ramps$cluster_id)

```

```{r}
level_order <- c("P", "S", "A", "PS", "PA","SA", "PSA", "None")

ggplot(data=lm_results_ramps, aes(x=Slopes, y=r2, color=factor(Ramp_type, level = level_order))) +
    geom_point() +
    scale_color_manual(values=c("deeppink1","indianred3", "steelblue3", "darkred", "orchid", "lightseagreen", "darkgreen", "grey32")) +
    theme_classic()
ggsave(file = "plots/slope_distribution_LMER_groups.png", width = 8, height =5)
```


```{r}
ggplot(lm_results_ramps, aes(x=Slopes, fill =factor(Ramp_type, level = level_order))) +
  geom_histogram(position="identity", alpha=0.2) +
  scale_fill_manual(values=c("deeppink1","indianred3", "steelblue3", "darkred", "orchid", "lightseagreen", "darkgreen", "grey32")) +
  theme_classic()
ggsave(file = "plots/slope_hist_LMER_groups.png", width = 8, height = 4)
  
ggplot(lm_results_ramps, aes(x=r2, fill =factor(Ramp_type, level = level_order))) +
  geom_histogram(position="identity", alpha=0.2) +
  scale_fill_manual(values=c("deeppink1","indianred3", "steelblue3", "darkred", "orchid", "lightseagreen", "darkgreen", "grey32")) +
  theme_classic()
ggsave(file = "plots/r2_hist_LMER_groups.png", width = 8, height = 4)

```

